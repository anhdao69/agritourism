# Table of Contents
- app/layout.tsx
- app/page.tsx
- app/globals.css
- app/providers.tsx
- app/analysis/page.tsx
- app/form-veget/page.tsx
- app/owner/page.tsx
- app/verify/page.tsx
- app/reset/page.tsx
- app/admin/listings/page.tsx
- app/admin/requests/page.tsx
- app/admin/users/page.tsx
- app/admin/users/create/page.tsx
- app/admin/submissions/page.tsx
- app/dashboard/sign-out-button.tsx
- app/dashboard/page.tsx
- app/reset-request/page.tsx
- app/components/DynamicOpenLayersField.tsx
- app/components/landing/search-bar.tsx
- app/components/auth/ui.tsx
- app/components/site/nav.tsx
- app/components/site/footer.tsx
- app/components/site/logo.tsx
- app/components/site/header.tsx
- app/register/page.tsx
- app/profile/page.tsx
- app/select-project/page.tsx
- app/prompts/page.tsx
- app/api/analysis/route.ts
- app/api/form-veget/route.ts
- app/api/auth/verify/route.ts
- app/api/auth/reset/route.ts
- app/api/auth/reset-request/route.ts
- app/api/auth/register/route.ts
- app/api/auth/[...nextauth]/route.ts
- app/api/listings/route.ts
- app/api/listings/[id]/route.ts
- app/api/admin/users/route.ts
- app/api/admin/users/[id]/status/route.ts
- app/api/admin/users/[id]/soft-delete/route.ts
- app/api/admin/users/[id]/hard-delete/route.ts
- app/api/admin/users/create/route.ts
- app/api/requests/route.ts
- app/api/profile/route.ts
- app/api/submissions/route.ts
- app/api/self-delete/route.ts
- app/login/page.tsx

## File: app/layout.tsx

- Extension: .tsx
- Language: typescript
- Size: 1232 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-10-24 14:53:50

### Code

```typescript
// app/layout.tsx
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

import Providers from "./providers";           // ðŸ‘ˆ add this
import SiteHeader from "./components/site/header";
import SiteFooter from "./components/site/footer";

const geistSans = Geist({ variable: "--font-geist-sans", subsets: ["latin"] });
const geistMono = Geist_Mono({ variable: "--font-geist-mono", subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Local Food Directories",
  description: "Farms, farmers markets and food hubs near you.",
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body
        suppressHydrationWarning
        className={`${geistSans.variable} ${geistMono.variable} antialiased bg-[#eef6e6] text-slate-800`}
      >
        {/* âœ… Wrap the app in SessionProvider so useSession() works */}
        <Providers>
          <div className="min-h-svh flex flex-col">
            <SiteHeader />
            <main className="flex-1">{children}</main>
            <SiteFooter />
          </div>
        </Providers>
      </body>
    </html>
  );
}

```

## File: app/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 8006 bytes
- Created: 2025-11-26 10:35:59
- Modified: 2025-11-26 10:35:59

### Code

```typescript
// app/page.tsx
"use client";
import React from "react";
import Link from "next/link";

/* ---------- Helper UI bits ---------- */
const Container = ({
  children,
  className = "",
}: {
  children: React.ReactNode;
  className?: string;
}) => (
  <div className={`mx-auto w-full max-w-[1200px] px-4 sm:px-6 lg:px-8 ${className}`}>
    {children}
  </div>
);

const Pill = ({
  children,
  className = "",
}: {
  children: React.ReactNode;
  className?: string;
}) => (
  <span className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${className}`}>
    {children}
  </span>
);

/* ---------- Data ---------- */
const FEATURES = [
  {
    key: "urban",
    title: "Urban Expansion",
    stats: "98% Accuracy",
    blurb:
      "Monitor rapid urbanization and calculate impervious surface changes over time in metropolitan areas.",
    cta: "Analyze Urban",
    img: "https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?q=80&w=1600&auto=format&fit=crop", 
  },
  {
    key: "vegetation",
    title: "Vegetation Health",
    stats: "NDVI/EVI",
    blurb:
      "Track deforestation and crop health using multi-temporal spectral indices and change detection.",
    cta: "Analyze Forests",
    img: "https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=1600&auto=format&fit=crop", 
  },
  {
    key: "water",
    title: "Water Resources",
    stats: "Real-time",
    blurb: "Detect shrinking water bodies, wetland loss, and coastline shifts using SAR and optical data.",
    cta: "Analyze Water",
    img: "https://images.unsplash.com/photo-1468581264429-2548ef9eb732?q=80&w=1600&auto=format&fit=crop", 
  },
  {
    key: "agri",
    title: "Agricultural Land",
    stats: "Crop Type",
    blurb:
      "Classify crop types and detect seasonal land use changes for agricultural yield estimation.",
    cta: "Analyze Crops",
    img: "https://images.unsplash.com/photo-1625246333195-78d9c38ad449?q=80&w=1600&auto=format&fit=crop", 
  },
];

/* ---------- Main ---------- */
export default function HomePage() {
  return (
    <div className="min-h-screen bg-[#eef6e6] text-slate-800 font-sans">
       {/* Global Header is injected by app/layout.tsx, so we don't need Navbar here */}
       <Hero />
       <FeaturesGrid />
    </div>
  );
}

/* ---------- Hero ---------- */
function Hero() {
  return (
    <section id="hero" className="relative w-full border-b border-slate-200">
      {/* Background Images */}
      <div className="absolute inset-0 -z-10">
        <div className="grid h-[500px] w-full grid-cols-3 gap-0 overflow-hidden md:h-[600px]">
          <div
            className="h-full w-full bg-cover bg-center"
            style={{
              backgroundImage:
                "url(https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2400&auto=format&fit=crop)",
            }}
          >
            <div className="h-full w-full bg-slate-900/30" />
          </div>
          <div
            className="h-full w-full bg-cover bg-center"
            style={{
              backgroundImage:
                "url(https://images.unsplash.com/photo-1524661135-423995f22d0b?q=80&w=2400&auto=format&fit=crop)",
            }}
          >
            <div className="h-full w-full bg-slate-900/30" />
          </div>
          <div
            className="h-full w-full bg-cover bg-center"
            style={{
              backgroundImage:
                "url(https://images.unsplash.com/photo-1534274988754-c6a60bf93c6c?q=80&w=2400&auto=format&fit=crop)",
            }}
          >
            <div className="h-full w-full bg-slate-900/30" />
          </div>
        </div>
      </div>

      <Container className="relative">
        <div className="pt-16 md:pt-24 lg:pt-28">
          
          {/* âœ… High Contrast Container */}
          <div className="max-w-3xl rounded-2xl bg-slate-900/70 backdrop-blur-md border border-white/10 p-6 md:p-10 shadow-2xl">
            <h1 className="text-4xl font-extrabold tracking-tight text-white sm:text-5xl md:text-6xl drop-shadow-lg">
              Land Cover <br className="hidden md:block" />
              <span className="text-green-400">Change Detection</span>
            </h1>
            
            <p className="mt-6 text-lg leading-relaxed text-slate-100 font-medium drop-shadow-md max-w-2xl">
              Advanced geospatial analysis for monitoring environmental changes, 
              urbanization, and vegetation health using satellite imagery.
            </p>

            {/* Operational Status Line */}
            <div className="mt-6 flex flex-wrap items-center gap-4 text-sm font-semibold text-green-100">
              <span className="flex items-center gap-2 bg-green-900/50 px-3 py-1 rounded-full border border-green-500/30">
                <span className="relative flex h-2.5 w-2.5">
                  <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span className="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                </span>
                System Operational
              </span>
              <span className="hidden sm:inline text-slate-400">â€¢</span>
              <span className="text-slate-200">Supports Sentinel-2 & Landsat</span>
            </div>

            {/* CTA Button */}
            <div className="mt-8">
              <Link 
                href="/select-project"
                className="inline-flex items-center justify-center rounded-xl bg-green-600 px-8 py-3.5 text-base font-bold text-white shadow-lg hover:bg-green-500 hover:shadow-green-900/20 transition-all duration-200 transform hover:-translate-y-0.5"
              >
                Start Analysis Project
              </Link>
            </div>
          </div>

        </div>
      </Container>
    </section>
  );
}

/* ---------- Features Grid ---------- */
function FeaturesGrid() {
  return (
    <section id="features" className="py-10 md:py-16">
      <Container>
        <div className="mb-8">
            <h2 className="text-2xl font-bold text-slate-900">Analysis Capabilities</h2>
            <p className="text-slate-600">Explore our core detection models available for immediate deployment.</p>
        </div>
        <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
          {FEATURES.map(({ key: id, ...props }) => (
            <FeatureCard key={id} {...props} />
          ))}
        </div>
      </Container>
    </section>
  );
}

function FeatureCard({
  title,
  stats,
  blurb,
  cta,
  img,
}: {
  title: string;
  stats: string;
  blurb: string;
  cta: string;
  img: string;
}) {
  return (
    <div className="group overflow-hidden rounded-xl border border-green-700/20 bg-white shadow-sm transition hover:shadow-lg hover:border-green-600 flex flex-col h-full">
      <div className="relative h-36 w-full overflow-hidden bg-slate-100 shrink-0">
        <img src={img} alt="" className="h-full w-full object-cover transition duration-500 group-hover:scale-110" />
        <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/10 to-transparent" />
        <div className="absolute top-2 left-2">
          <Pill className="bg-green-600 text-white shadow-sm">{title}</Pill>
        </div>
      </div>
      <div className="flex flex-col space-y-3 p-4 text-sm flex-1">
        <div className="text-xs text-slate-500 flex justify-between items-center border-b border-slate-100 pb-2">
          <span>Model Performance</span>
          <span className="font-bold text-green-700">{stats}</span>
        </div>
        <p className="leading-relaxed text-slate-600 grow">{blurb}</p>
        <div className="mt-auto pt-2">
          <Link href="/select-project" className="block w-full rounded-lg border border-green-700 text-green-700 hover:bg-green-50 text-center py-2 font-medium transition">
            {cta}
          </Link>
        </div>
      </div>
    </div>
  );
}
```

## File: app/globals.css

- Extension: .css
- Language: unknown
- Size: 598 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-10-20 13:12:50

### Code

```unknown
@import "tailwindcss";
/* Form.io styles */
@import "formiojs/dist/formio.full.min.css";
@import "formiojs/dist/formio.full.min.css";
:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}

```

## File: app/providers.tsx

- Extension: .tsx
- Language: typescript
- Size: 233 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-24 15:32:27

### Code

```typescript
"use client";

import { SessionProvider } from "next-auth/react";
import React from "react";

export default function Providers({ children }: { children: React.ReactNode }) {
  return <SessionProvider>{children}</SessionProvider>;
}

```

## File: app/analysis/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 15743 bytes
- Created: 2025-11-24 14:21:09
- Modified: 2025-11-24 14:21:09

### Code

```typescript
"use client";

import React, { useState, useCallback, Suspense } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import dynamic from "next/dynamic";
import { Download, Loader, MapPin, AlertCircle, Check, Trash2, ArrowLeft, Info } from "lucide-react";

// Dynamically import the map component to avoid SSR issues
const DynamicOpenLayersField = dynamic(
  () => import("../components/DynamicOpenLayersField"),
  {
    ssr: false,
    loading: () => (
      <div className="w-full h-[500px] flex items-center justify-center bg-emerald-50 rounded-lg text-emerald-700">
        <Loader className="w-5 h-5 animate-spin mr-2" /> Loading Map...
      </div>
    ),
  }
);

type AnalysisStatus = "idle" | "processing" | "success" | "error";

interface AnalysisState {
  status: AnalysisStatus;
  message: string;
  downloadUrl: string | null;
}

function AnalysisPageContent() {
  const searchParams = useSearchParams();
  const router = useRouter();
  
  // Get project ID from URL
  const ombilSiteId = searchParams.get("ombilSiteId");
  
  // Build TIF URL based on project ID
  const tifUrl = ombilSiteId 
    ? `/tif_data/${ombilSiteId}_2024.tif`
    : "/map_4326.tif"; // Default fallback

  const [geojson, setGeojson] = useState<object | null>(null);
  const [year1, setYear1] = useState<string>("2010");
  const [year2, setYear2] = useState<string>("2024");
  const [analysisState, setAnalysisState] = useState<AnalysisState>({
    status: "idle",
    message: "",
    downloadUrl: null,
  });

  // Available years for analysis
  const availableYears = [
    "2001", "2004", "2006", "2008", "2010", "2011", "2012",
    "2013", "2014", "2015", "2016", "2017", "2018", "2019",
    "2020", "2021", "2022", "2023", "2024"
  ];

  const handleGeoJSONChange = useCallback((value: object | null) => {
    setGeojson(value);
    // Reset analysis state when polygon changes
    if (analysisState.status !== "idle") {
      setAnalysisState({ status: "idle", message: "", downloadUrl: null });
    }
  }, [analysisState.status]);

  const handleClear = () => {
    setGeojson(null);
    setAnalysisState({ status: "idle", message: "", downloadUrl: null });
  };

    const goToVegetationForm = () => {
    // Build querystring so the vegetation form knows which project/years
    const params = new URLSearchParams();
    if (ombilSiteId) params.set("ombilSiteId", ombilSiteId);
    if (year1) params.set("year1", year1);
    if (year2) params.set("year2", year2);

    const qs = params.toString();
    router.push(`/form-veget${qs ? `?${qs}` : ""}`);
  };


  const handleSubmit = async () => {
    if (!geojson) {
      setAnalysisState({
        status: "error",
        message: "Please draw a polygon on the map first.",
        downloadUrl: null,
      });
      return;
    }

    if (year1 === year2) {
      setAnalysisState({
        status: "error",
        message: "Please select different years for comparison.",
        downloadUrl: null,
      });
      return;
    }

    setAnalysisState({
      status: "processing",
      message: "Processing your analysis request... This may take a few minutes.",
      downloadUrl: null,
    });

    try {
      const response = await fetch("/api/analysis", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          geojson,
          year1: parseInt(year1),
          year2: parseInt(year2),
          ombilSiteId: ombilSiteId || undefined,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `Analysis failed with status ${response.status}`);
      }

      // Get the blob from response
      const blob = await response.blob();
      const downloadUrl = URL.createObjectURL(blob);

      setAnalysisState({
        status: "success",
        message: "Analysis complete! Click the button below to download your results.",
        downloadUrl,
      });
    } catch (error: any) {
      console.error("Analysis error:", error);
      setAnalysisState({
        status: "error",
        message: error.message || "An error occurred during analysis. Please try again.",
        downloadUrl: null,
      });
    }
  };

  const handleDownload = () => {
    if (analysisState.downloadUrl) {
      const a = document.createElement("a");
      a.href = analysisState.downloadUrl;
      a.download = `land_cover_analysis_${year1}_${year2}${ombilSiteId ? `_${ombilSiteId}` : ""}.zip`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  };

  const goBack = () => {
    router.push("/select-project");
  };

  return (
    <main className="min-h-screen bg-white relative">
      {/* Background decoration */}
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <section className="mx-auto max-w-6xl p-6 sm:p-10">
        {/* Header */}
        <header className="mb-8">
          <div className="flex items-center gap-4 mb-4">
            <button
              onClick={goBack}
              className="flex items-center gap-2 px-3 py-2 rounded-lg text-emerald-700 hover:bg-emerald-50 transition"
            >
              <ArrowLeft className="w-4 h-4" />
              Back to Projects
            </button>
          </div>
          
          <div className="flex items-center gap-3 mb-2">
            <div className="h-12 w-12 rounded-2xl bg-emerald-600 flex items-center justify-center text-white shadow-md">
              <MapPin className="w-6 h-6" />
            </div>
            <div>
              <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">
                Land Cover Change Analysis
              </h1>
              <p className="text-sm text-emerald-900/70">
                Draw a polygon to analyze land cover changes between two years
              </p>
            </div>
          </div>
        </header>

        {/* Project Info Banner */}
        {ombilSiteId && (
          <div className="mb-6 rounded-2xl border border-emerald-200 bg-emerald-50/70 p-4 flex items-center gap-4">
            <div className="h-10 w-10 rounded-xl bg-emerald-600 flex items-center justify-center flex-shrink-0">
              <Info className="w-5 h-5 text-white" />
            </div>
            <div className="flex-1">
              <p className="text-sm font-medium text-emerald-900">
                Analyzing Project: <span className="font-mono">{ombilSiteId}</span>
              </p>
              <p className="text-xs text-emerald-700 mt-0.5">
                TIF overlay loaded from: <code className="px-1.5 py-0.5 rounded bg-white">{tifUrl}</code>
              </p>
            </div>
          </div>
        )}

        {/* Instructions Card */}
        <div className="mb-6 rounded-2xl border border-emerald-200 bg-emerald-50/50 p-4">
          <h2 className="font-semibold text-emerald-900 mb-2">How to use:</h2>
          <ol className="list-decimal list-inside text-sm text-emerald-800 space-y-1">
            <li>Use the polygon tool (â—‡) on the map to draw around your area of interest</li>
            <li>Select the start and end years for comparison below</li>
            <li>Click "Run Analysis" to process the data</li>
            <li>Download your results as a ZIP file containing Excel reports and visualizations</li>
          </ol>
        </div>

        {/* Year Selection */}
        <div className="mb-6 rounded-2xl border border-emerald-900/10 bg-white/70 p-6 shadow-sm">
          <h2 className="font-semibold text-emerald-950 mb-4">Select Analysis Years</h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-emerald-900 mb-2">
                Start Year (Before)
              </label>
              <select
                value={year1}
                onChange={(e) => setYear1(e.target.value)}
                className="w-full px-4 py-3 border-2 border-emerald-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition bg-white"
              >
                {availableYears.map((year) => (
                  <option key={year} value={year}>
                    {year}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-emerald-900 mb-2">
                End Year (After)
              </label>
              <select
                value={year2}
                onChange={(e) => setYear2(e.target.value)}
                className="w-full px-4 py-3 border-2 border-emerald-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition bg-white"
              >
                {availableYears.map((year) => (
                  <option key={year} value={year}>
                    {year}
                  </option>
                ))}
              </select>
            </div>
          </div>
          {year1 === year2 && (
            <p className="mt-2 text-sm text-amber-700 flex items-center gap-2">
              <AlertCircle className="w-4 h-4" />
              Please select different years for comparison
            </p>
          )}
        </div>

        {/* Map Component */}
        <div className="mb-6 rounded-2xl border border-emerald-900/10 bg-white/70 p-6 shadow-sm">
          <DynamicOpenLayersField
            field={{
              label: "Draw Analysis Area",
              required: true,
              defaultCenter: [-83.8926, 34.3056],
              defaultZoom: 8,
            }}
            value={geojson}
            onChange={handleGeoJSONChange}
            disabled={analysisState.status === "processing"}
            tifUrl={tifUrl}
          />
        </div>

        {/* GeoJSON Preview */}
        {geojson && (
          <div className="mb-6 rounded-2xl border border-emerald-900/10 bg-white/70 p-4 shadow-sm">
            <div className="flex items-center justify-between mb-2">
              <h3 className="font-medium text-emerald-950">Selected Area (GeoJSON)</h3>
              <button
                onClick={handleClear}
                className="flex items-center gap-1 px-3 py-1.5 text-sm text-rose-700 hover:bg-rose-50 rounded-lg transition"
              >
                <Trash2 className="w-4 h-4" />
                Clear
              </button>
            </div>
            <pre className="text-xs bg-slate-50 p-3 rounded-lg overflow-auto max-h-32 text-slate-700">
              {JSON.stringify(geojson, null, 2)}
            </pre>
          </div>
        )}

        {/* Status Messages */}
        {analysisState.status !== "idle" && (
          <div
            className={`mb-6 rounded-2xl border p-4 ${
              analysisState.status === "processing"
                ? "bg-blue-50 border-blue-200 text-blue-800"
                : analysisState.status === "success"
                ? "bg-emerald-50 border-emerald-200 text-emerald-800"
                : "bg-rose-50 border-rose-200 text-rose-800"
            }`}
          >
            <div className="flex items-start gap-3">
              {analysisState.status === "processing" && (
                <Loader className="w-5 h-5 animate-spin flex-shrink-0 mt-0.5" />
              )}
              {analysisState.status === "success" && (
                <Check className="w-5 h-5 flex-shrink-0 mt-0.5" />
              )}
              {analysisState.status === "error" && (
                <AlertCircle className="w-5 h-5 flex-shrink-0 mt-0.5" />
              )}
              <div>
                <p className="text-sm">{analysisState.message}</p>
                {analysisState.status === "processing" && (
                  <p className="text-xs mt-2 opacity-75">
                    Please don't close this page while processing...
                  </p>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Action Buttons */}
        <div className="flex flex-wrap gap-4">
          <button
            onClick={handleSubmit}
            disabled={!geojson || analysisState.status === "processing" || year1 === year2}
            className={`flex items-center gap-2 px-6 py-3 rounded-xl font-semibold shadow-lg transition ${
              !geojson || analysisState.status === "processing" || year1 === year2
                ? "bg-gray-300 text-gray-500 cursor-not-allowed"
                : "bg-emerald-600 text-white hover:bg-emerald-700 hover:shadow-xl"
            }`}
          >
            {analysisState.status === "processing" ? (
              <>
                <Loader className="w-5 h-5 animate-spin" />
                Processing...
              </>
            ) : (
              <>
                <MapPin className="w-5 h-5" />
                Run Analysis
              </>
            )}
          </button>

          {analysisState.downloadUrl && (
            <button
              onClick={handleDownload}
              className="flex items-center gap-2 px-6 py-3 rounded-xl font-semibold bg-blue-600 text-white hover:bg-blue-700 shadow-lg hover:shadow-xl transition"
            >
              <Download className="w-5 h-5" />
              Download Results (ZIP)
            </button>
          )}

          {/* NEW: Next button to vegetation form */}
          <button
            type="button"
            onClick={goToVegetationForm}
            disabled={analysisState.status !== "success"}
            className={`flex items-center gap-2 px-6 py-3 rounded-xl font-semibold shadow-lg transition ${
              analysisState.status !== "success"
                ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                : "bg-emerald-500 text-white hover:bg-emerald-600 hover:shadow-xl"
            }`}
          >
            Next: Vegetation Form
          </button>
        </div>


        {/* Output Description */}
        <div className="mt-8 rounded-2xl border border-emerald-200 bg-emerald-50/50 p-4">
          <h2 className="font-semibold text-emerald-900 mb-2">Analysis Output Includes:</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-1">
            <ul className="list-disc list-inside text-sm text-emerald-800 space-y-1">
              <li>Cropped raster files for both years</li>
              <li>NLCD Transition Tables (Excel)</li>
              <li>Normalized and ranked change analysis</li>
              <li>Chi-square statistical analysis</li>
            </ul>
            <ul className="list-disc list-inside text-sm text-emerald-800 space-y-1">
              <li>Land change intensity analysis</li>
              <li>Visualization PNG images</li>
              <li>Input polygon (GeoJSON)</li>
              <li>Analysis metadata (JSON)</li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  );
}

export default function AnalysisPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen flex items-center justify-center bg-emerald-50">
        <div className="flex items-center gap-2 text-emerald-700">
          <Loader className="w-5 h-5 animate-spin" />
          Loading...
        </div>
      </div>
    }>
      <AnalysisPageContent />
    </Suspense>
  );
}
```

## File: app/form-veget/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 24892 bytes
- Created: 2025-11-24 14:37:21
- Modified: 2025-11-24 14:37:21

### Code

```typescript
"use client";

import React, { useMemo, useState, useEffect } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import { Save, FileSpreadsheet, ArrowLeft, Loader } from "lucide-react";
import * as XLSX from "xlsx"; // npm install xlsx

/** â€”â€” Helpers & types â€”â€” */
type Category = "Landscape Context" | "Size" | "Vegetation" | "Soils/Substrate" | "Hydrology";

type Q = {
  id: string;               // e.g. "L1"
  category: Category;
  label: string;            // short question label
  help?: string;            // brief description under label
  required?: boolean;
  // Optional per-score guidance. Key is the numeric choice (1..5).
  guidance?: Partial<Record<1 | 2 | 3 | 4 | 5, string>>;
};

// numeric (1..5) â†’ textual rating
function ratingFromScore(s: number) {
  if (s >= 4.5) return "Sustainable+ (A)";
  if (s >= 3.5) return "Sustainable (B)";
  if (s >= 2.5) return "Transitioning (C)";
  if (s >= 1.75) return "Degraded (D)";
  return "Very Degraded (E)";
}

const CAT_ORDER: Category[] = [
  "Landscape Context",
  "Size",
  "Vegetation",
  "Soils/Substrate",
  "Hydrology",
];

/** â€”â€” Questions â€”â€” */
const QUESTIONS: Q[] = [
  // LANDSCAPE CONTEXT
  {
    id: "L1",
    category: "Landscape Context",
    label: "L1. Landscape Connectivity",
    help: "Percent of unaltered habitat around the polygon (see area-of-analysis rules).",
    required: true,
    guidance: {
      5: "Intact: 90â€“100% natural habitat; connectivity is high.",
      4: "Variegated: 60â€“90% natural habitat; generally high connectivity.",
      3: "Fragmented: 20â€“60% natural habitat; connectivity generally low.",
      1: "Relictual: <20% natural habitat; connectivity absent.",
    },
  },
  {
    id: "L2",
    category: "Landscape Context",
    label: "L2. Surrounding Land Use (Index)",
    help: "Compute Land Use Index over the specified landscape area (see worksheet).",
    required: true,
    guidance: {
      5: "Index 0.95â€“1.0",
      4: "Index 0.80â€“0.94",
      3: "Index 0.40â€“0.79",
      1: "Index < 0.40",
    },
  },
  {
    id: "L3",
    category: "Landscape Context",
    label: "L3. Landscape Stressors Checklist",
    help: "Use LANDSCAPE CONTEXT checklist. Field value is [total (# significant)].",
    required: true,
    guidance: {
      5: "No stressors listed.",
      4: "1â€“3 stressors; none significant (<10% area).",
      3: "2â€“4 stressors; 1â€“2 significant (>10% area).",
      1: ">4 stressors; â‰¥2 significant (>10% area).",
    },
  },
  {
    id: "L4a",
    category: "Landscape Context",
    label: "L4a. Buffer Length (wetlands, optional)",
    help: "Percent of occurrence perimeter with buffer.",
    required: false,
    guidance: {
      5: ">75â€“100% perimeter buffered",
      4: "50â€“74%",
      3: "25â€“49%",
      1: "<25%",
    },
  },
  {
    id: "L4b",
    category: "Landscape Context",
    label: "L4b. Buffer Width (wetlands, optional)",
    help: "Average buffer width (m), slope-adjusted.",
    required: false,
    guidance: {
      5: ">200 m",
      4: "100â€“199 m",
      3: "50â€“99 m",
      2: "10â€“49 m",
      1: "<10 m",
    },
  },

  // SIZE
  {
    id: "Z1",
    category: "Size",
    label: "Z1. Patch Size",
    help: "Current size (ha) of contiguous patch for the NVC Class.",
    required: true,
    guidance: {
      5: ">1,000 ha",
      4: "100â€“999 ha",
      3: "10â€“99 ha",
      1: "<10 ha",
    },
  },
  {
    id: "Z2",
    category: "Size",
    label: "Z2. Patch Size Condition",
    help: "Naturalness of current overall vegetation patch extent vs. original.",
    required: true,
    guidance: {
      5: "At/minimally changed (<5%).",
      4: "Modestly changed (5â€“20%).",
      3: "Substantially changed (20â€“50%).",
      1: "Heavily changed (>50%).",
    },
  },

  // VEGETATION
  {
    id: "V1",
    category: "Vegetation",
    label: "V1. Vegetation Structure",
    help: "Overall structural complexity vs. reference (density, stem size, canopy).",
    required: true,
  },
  {
    id: "V2",
    category: "Vegetation",
    label: "V2. Invasive Exotic Plants",
    help: "Percent cover / mapped overlap / county presence of key invasive species.",
    required: true,
    guidance: {
      5: "No key invasives present (or county data shows none).",
      4: "1â€“2% cover (or 1 key invasive at county level).",
      3: "3â€“5% cover, or mapped overlap, or 2â€“3 county species.",
      2: "5â€“25% cover, or >10% mapped overlap, or 4â€“5 county species.",
      1: ">25% cover, or >25% mapped overlap, or >5 county species.",
    },
  },
  {
    id: "V3",
    category: "Vegetation",
    label: "V3. Vegetation Composition",
    help: "Species composition/diversity of dominant layer; diseases/mortality evidence.",
    required: true,
    guidance: {
      5: "At/close to reference; exotics low; some indicators may be absent.",
      3: "Differs from reference but largely native; exotics common, not dominant.",
      1: "Severely altered; exotics dominate / planted non-characteristic / indicators absent.",
    },
  },
  {
    id: "V4",
    category: "Vegetation",
    label: "V4. Relative % Cover of Native Plant Species (optional)",
    help: "Relative % cover of native species vs. total vegetation cover.",
    required: false,
    guidance: {
      5: ">95%",
      4: "80â€“94%",
      3: "50â€“79%",
      1: "<50%",
    },
  },
  {
    id: "V5",
    category: "Vegetation",
    label: "V5. Vegetation Stressors Checklist",
    help: "Use VEGETATION (BIOTIC CONDITION) checklist. Field value is [total (# significant)].",
    required: true,
    guidance: {
      5: "No stressors listed.",
      4: "1â€“3 stressors; none significant (<10%).",
      3: "2â€“4 stressors; 1â€“2 significant (>10%).",
      1: ">4 stressors; â‰¥2 significant (>10%).",
    },
  },

  // SOIL / SUBSTRATE
  {
    id: "S1",
    category: "Soils/Substrate",
    label: "S1. Soil/Substrate Condition",
    help: "Physical disturbances (filling, grading, plowing, pugging, vehicle use, dredgingâ€¦).",
    required: true,
    guidance: {
      5: "No apparent soil surface modifications.",
      4: "Past but recovered OR recent minor.",
      3: "Recovering OR recent moderate.",
      1: "Recent severe modifications.",
    },
  },
  {
    id: "S2",
    category: "Soils/Substrate",
    label: "S2. On-Site Land Use (Index)",
    help: "Use Land Use Index worksheet.",
    required: true,
    guidance: {
      5: "Index 0.95â€“1.0",
      4: "Index 0.80â€“0.95",
      3: "Index 0.40â€“0.80",
      1: "Index < 0.40",
    },
  },
  {
    id: "S3",
    category: "Soils/Substrate",
    label: "S3. Soils/Substrate Stressors Checklist",
    help: "Use SOIL / SUBSTRATE checklist. Field value is [total (# significant)].",
    required: true,
    guidance: {
      5: "No stressors listed.",
      4: "1â€“3 stressors; none significant (<10%).",
      3: "2â€“4 stressors; 1â€“2 significant (>10%).",
      1: ">4 stressors; â‰¥2 significant (>10%).",
    },
  },

  // HYDROLOGY
  {
    id: "H1n",
    category: "Hydrology",
    label: "H1-n. Hydrologic Alterations (non-riparian)",
    help: "Dikes, diversions, ditches, flow additions, pugging, fill, wells, etc. within assessment area.",
    required: true,
    guidance: {
      5: "No alterations present.",
      4: "Low intensity (e.g., small ditches <1 ft, few wells, roads at grade).",
      3: "Moderate intensity (e.g., 1â€“3 ft ditches, low dikes, culverted roads).",
      1: "High intensity (e.g., >3 ft ditches/diversions, large fill, heavy pumping).",
    },
  },
  {
    id: "H1r",
    category: "Hydrology",
    label: "H1-r. Floodplain Interactions (riparian)",
    help: "Degree flooding interactions/geomorphic floodplain structure impacted.",
    required: true,
    guidance: {
      5: "Within natural range; no geomorphic modification.",
      4: "Few modifications; â‰¤20% streambanks affected.",
      3: "Highly disrupted; 20â€“50% streambanks affected.",
      1: "Complete modification; >50% streambanks affected.",
    },
  },
  {
    id: "H2r",
    category: "Hydrology",
    label: "H2-r. Upstream Surface Water Retention (riparian)",
    help: "Percent of contributing watershed draining to storage facilities.",
    required: true,
    guidance: {
      5: "<5% drains to storage",
      4: ">5â€“20%",
      3: ">20â€“50%",
      1: ">50%",
    },
  },
  {
    id: "H3r",
    category: "Hydrology",
    label: "H3-r. Upstream/On-Site Water Diversion (riparian)",
    help: "Number/impact of diversions/wells relative to watershed; onsite/downstream impacts.",
    required: true,
    guidance: {
      5: "No upstream/onsite/nearby downstream diversions or wells.",
      4: "Few/minor impacts relative to watershed size.",
      3: "Many/moderate impacts; major local effects.",
      1: "Numerous/high impacts; drastically altered local hydrology.",
    },
  },
  {
    id: "H4",
    category: "Hydrology",
    label: "H4. Hydrologic Stressors Checklist",
    help: "Use HYDROLOGY checklist. Field value is [total (# significant)].",
    required: true,
    guidance: {
      5: "No stressors listed.",
      4: "1â€“3 stressors; none significant (<10%).",
      3: "2â€“4 stressors; 1â€“2 significant (>10%).",
      1: ">4 stressors; â‰¥2 significant (>10%).",
    },
  },
];

/** â€”â€” Page â€”â€” */
export default function VegetFormPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const ombilSiteId = searchParams.get("ombilSiteId") || "";

  // 1. Scoring State
  const [answers, setAnswers] = useState<Record<string, number | null>>(
    Object.fromEntries(QUESTIONS.map((q) => [q.id, null]))
  );

  // 2. Metadata State (User Input)
  const [metadata, setMetadata] = useState({
    siteId: ombilSiteId,
    observerName: "",
    date: new Date().toISOString().split("T")[0],
    notes: "",
  });

  // 3. UI State
  const [submitting, setSubmitting] = useState(false);
  const [submittedMsg, setSubmittedMsg] = useState<string | null>(null);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);

  // Sync URL ID to state if available
  useEffect(() => {
    if (ombilSiteId) {
      setMetadata((prev) => ({ ...prev, siteId: ombilSiteId }));
    }
  }, [ombilSiteId]);

  // Calculations
  const byCategory = useMemo(() => {
    const map = new Map<Category, Q[]>();
    CAT_ORDER.forEach((c) => map.set(c, []));
    QUESTIONS.forEach((q) => map.get(q.category)!.push(q));
    return map;
  }, []);

  const sectionStats = useMemo(() => {
    const res: Record<
      Category,
      { average: number | null; rating: string | null }
    > = {} as any;

    for (const cat of CAT_ORDER) {
      const qs = byCategory.get(cat)!;
      const vals = qs
        .map((q) => answers[q.id])
        .filter((v): v is number => Number.isFinite(v as number));
      if (vals.length === 0) {
        res[cat] = { average: null, rating: null };
      } else {
        const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
        res[cat] = { average: avg, rating: ratingFromScore(avg) };
      }
    }
    return res;
  }, [answers, byCategory]);

  const overall = useMemo(() => {
    const vals = Object.values(answers).filter(
      (v): v is number => Number.isFinite(v as number)
    );
    if (vals.length === 0) return { average: null, rating: null };
    const avg = vals.reduce((a, b) => a + b, 0) / vals.length;
    return { average: avg, rating: ratingFromScore(avg) };
  }, [answers]);

  function setAnswer(id: string, val: number) {
    setAnswers((s) => ({ ...s, [id]: val }));
  }

  const handleMetadataChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    setMetadata({ ...metadata, [e.target.name]: e.target.value });
  };

  // --- SAVE LOGIC ---
  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setSubmittedMsg(null);
    setErrorMsg(null);

    // Validate Scores
    const missing = QUESTIONS.filter(
      (q) => q.required && !Number.isFinite(answers[q.id] as number)
    );
    if (missing.length) {
      setErrorMsg(
        `Please answer all required items: ${missing.map((m) => m.id).join(", ")}`
      );
      return;
    }

    setSubmitting(true);
    try {
      // Create a flat object combining everything for saving
      const payload = {
        ...metadata,
        ...answers,
        overallRating: overall.rating,
        overallScore: overall.average,
        // Add section averages for the record
        landscapeAvg: sectionStats["Landscape Context"].average,
        sizeAvg: sectionStats["Size"].average,
        vegAvg: sectionStats["Vegetation"].average,
        soilAvg: sectionStats["Soils/Substrate"].average,
        hydroAvg: sectionStats["Hydrology"].average,
      };

      const res = await fetch("/api/form-veget", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json?.error || "Failed to submit.");

      setSubmittedMsg(`Saved successfully! File: ${json.file}`);
    } catch (err: any) {
      setErrorMsg(err?.message || "Something went wrong.");
    } finally {
      setSubmitting(false);
    }
  }

  // --- DOWNLOAD EXCEL LOGIC ---
  const handleDownloadExcel = () => {
    try {
      const flatData = {
        "Site ID": metadata.siteId,
        "Date": metadata.date,
        "Observer": metadata.observerName,
        "Notes": metadata.notes,
        "Overall Rating": overall.rating,
        "Overall Score": overall.average?.toFixed(2),
        ...answers, // Spreads L1: 5, L2: 3, etc.
      };

      const ws = XLSX.utils.json_to_sheet([flatData]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Ecological Data");
      
      const fileName = `Eco_Assessment_${metadata.siteId || "Unknown"}_${metadata.date}.xlsx`;
      XLSX.writeFile(wb, fileName);
    } catch (e) {
      console.error(e);
      alert("Error generating Excel file.");
    }
  };

  return (
    <main className="min-h-screen bg-[#eef6e6] text-slate-800 relative">
       {/* Background Decor */}
       <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
      </div>

      <div className="mx-auto w-full max-w-5xl px-4 sm:px-6 lg:px-8 py-8">
        <header className="mb-6">
          <button
            onClick={() => router.back()}
            className="flex items-center gap-2 mb-4 text-emerald-700 hover:text-emerald-900 transition"
          >
            <ArrowLeft className="w-4 h-4" /> Back
          </button>
          <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-900">
            Vegetation & Ecological Integrity Form
          </h1>
          <p className="text-sm text-emerald-900/70">
            Record ground truth data for the analyzed area.
          </p>
        </header>

        <form onSubmit={onSubmit} className="space-y-8">
          
          {/* --- NEW: Metadata Section --- */}
          <section className="rounded-2xl border border-emerald-900/15 bg-white p-6 shadow-sm">
            <h2 className="text-lg font-semibold text-emerald-950 mb-4 border-b border-emerald-100 pb-2">
              Project Information
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
              <div>
                <label className="block text-sm font-medium text-emerald-900 mb-1">Site / Project ID</label>
                <input 
                  name="siteId"
                  value={metadata.siteId}
                  onChange={handleMetadataChange}
                  className="w-full rounded-lg border border-emerald-200 p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none"
                  placeholder="e.g. OMB-001"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-emerald-900 mb-1">Observer Name</label>
                <input 
                  name="observerName"
                  value={metadata.observerName}
                  onChange={handleMetadataChange}
                  className="w-full rounded-lg border border-emerald-200 p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none"
                  placeholder="John Doe"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-emerald-900 mb-1">Date</label>
                <input 
                  type="date"
                  name="date"
                  value={metadata.date}
                  onChange={handleMetadataChange}
                  className="w-full rounded-lg border border-emerald-200 p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none"
                />
              </div>
              <div className="md:col-span-3">
                <label className="block text-sm font-medium text-emerald-900 mb-1">General Notes</label>
                <textarea 
                  name="notes"
                  rows={2}
                  value={metadata.notes}
                  onChange={handleMetadataChange}
                  className="w-full rounded-lg border border-emerald-200 p-2.5 focus:ring-2 focus:ring-emerald-500 outline-none"
                  placeholder="Weather conditions, access issues, general observations..."
                />
              </div>
            </div>
          </section>

          {/* --- Existing Questions Section --- */}
          {CAT_ORDER.map((cat) => {
            const qs = byCategory.get(cat)!;
            return (
              <section key={cat} className="rounded-2xl border border-emerald-900/15 bg-white/80 shadow-sm">
                <div className="border-b border-emerald-900/10 px-4 py-3 bg-emerald-50/50 rounded-t-2xl">
                  <h2 className="text-lg font-semibold text-emerald-950">{cat}</h2>
                  <div className="text-xs text-emerald-900/70">
                    {sectionStats[cat].average != null ? (
                      <>
                        Avg:{" "}
                        <b>{sectionStats[cat].average.toFixed(2)}</b> Â· Rating:{" "}
                        <b>{sectionStats[cat].rating}</b>
                      </>
                    ) : (
                      <>No responses yet.</>
                    )}
                  </div>
                </div>

                <div className="divide-y divide-emerald-900/10">
                  {qs.map((q) => {
                    const val = answers[q.id];
                    return (
                      <div key={q.id} className="p-4">
                        <div className="flex items-start justify-between gap-4">
                          <div>
                            <label className="block font-medium text-emerald-950">
                              {q.label}{" "}
                              {q.required && <span className="text-red-600">*</span>}
                            </label>
                            {q.help && (
                              <p className="mt-1 max-w-3xl text-sm text-emerald-900/75">
                                {q.help}
                              </p>
                            )}
                          </div>
                          {q.guidance && (
                            <details className="text-xs group">
                              <summary className="cursor-pointer text-emerald-700 hover:underline list-none flex items-center gap-1">
                                <span className="bg-emerald-100 rounded-full w-4 h-4 flex items-center justify-center text-[10px]">i</span> 
                                Guidance
                              </summary>
                              <div className="mt-2 absolute z-10 bg-white border border-emerald-200 p-3 rounded-lg shadow-lg max-w-sm text-emerald-800">
                                {[5,4,3,2,1].map((k) =>
                                  q.guidance![k as 1|2|3|4|5] ? (
                                    <div key={k} className="mb-1 last:mb-0">
                                      <b className="text-emerald-600">{k}</b> â€“ {q.guidance![k as 1|2|3|4|5]}
                                    </div>
                                  ) : null
                                )}
                              </div>
                            </details>
                          )}
                        </div>

                        {/* Radios 1..5 */}
                        <div className="mt-3 grid grid-cols-5 gap-2 sm:max-w-md">
                          {[1, 2, 3, 4, 5].map((n) => (
                            <label
                              key={n}
                              className={`flex items-center justify-center rounded-xl border px-3 py-2 text-sm cursor-pointer transition shadow-sm ${
                                val === n
                                  ? "bg-emerald-600 text-white border-emerald-600 ring-2 ring-emerald-200"
                                  : "bg-white text-emerald-900 border-emerald-900/20 hover:bg-emerald-50"
                              }`}
                              title={`Choose ${n}`}
                            >
                              <input
                                type="radio"
                                name={q.id}
                                value={n}
                                checked={val === n}
                                onChange={() => setAnswer(q.id, n)}
                                className="sr-only"
                              />
                              {n}
                            </label>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </section>
            );
          })}

          {/* Overall summary */}
          <section className="rounded-2xl border border-emerald-900/15 bg-white p-4 shadow-sm flex items-center justify-between">
            <div>
              <h3 className="text-base font-semibold text-emerald-950">Overall Score</h3>
              <p className="text-sm text-emerald-900/70">
                {overall.average != null ? (
                  <>
                    Average: <b className="text-lg">{overall.average.toFixed(2)}</b> Â· Rating:{" "}
                    <b className="text-lg text-emerald-700">{overall.rating}</b>
                  </>
                ) : (
                  <>Answer items to calculate score.</>
                )}
              </p>
            </div>
          </section>

          {errorMsg && (
            <div className="rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-900 font-medium">
              {errorMsg}
            </div>
          )}
          {submittedMsg && (
            <div className="rounded-xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-900 font-medium">
              {submittedMsg}
            </div>
          )}

          <div className="sticky bottom-4 z-10 bg-white/90 backdrop-blur p-4 rounded-2xl border border-emerald-100 shadow-lg flex flex-wrap items-center justify-between gap-4">
             <div className="text-xs text-emerald-900/60 hidden sm:block">
              Legend: 5=A (Best) ... 1=E (Worst)
            </div>
            
            <div className="flex gap-3">
              <button
                type="button"
                onClick={() => setAnswers(Object.fromEntries(QUESTIONS.map((q) => [q.id, null])))}
                className="rounded-xl border border-emerald-900/15 bg-white px-4 py-2.5 text-sm font-medium shadow-sm hover:bg-emerald-50 transition"
              >
                Clear Form
              </button>

              <button
                type="button"
                onClick={handleDownloadExcel}
                className="flex items-center gap-2 rounded-xl border border-emerald-600 text-emerald-700 bg-white px-4 py-2.5 text-sm font-semibold shadow-sm hover:bg-emerald-50 transition"
              >
                <FileSpreadsheet className="w-4 h-4" />
                Download Excel
              </button>

              <button
                type="submit"
                disabled={submitting}
                className="flex items-center gap-2 rounded-xl bg-emerald-600 px-6 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-emerald-700 disabled:opacity-60 transition"
              >
                {submitting ? <Loader className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4" />}
                {submitting ? "Saving..." : "Save Data"}
              </button>
            </div>
          </div>
        </form>
      </div>
    </main>
  );
}
```

## File: app/owner/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 7177 bytes
- Created: 2025-11-10 14:33:34
- Modified: 2025-11-10 10:43:50

### Code

```typescript
// Owner portal â€” create & manage listings
"use client";
import React from "react";
import Link from "next/link";

export default function OwnerPage() {
  const [name, setName] = React.useState("");
  const [shortIntro, setShortIntro] = React.useState("");
  const [creating, setCreating] = React.useState(false);
  const [listings, setListings] = React.useState<any[]>([]);
  const [loading, setLoading] = React.useState(true);
  const [err, setErr] = React.useState<string | null>(null);

  async function load() {
    setLoading(true);
    const r = await fetch("/api/listings", { cache: "no-store" });
    const d = await r.json().catch(() => ({}));
    setListings(d?.listings || []);
    setLoading(false);
  }

  React.useEffect(() => {
    load();
  }, []);

  async function onCreate(e: React.FormEvent) {
    e.preventDefault();
    if (creating) return;
    setErr(null);
    setCreating(true);
    const r = await fetch("/api/listings", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, shortIntro }),
    });
    const d = await r.json().catch(() => ({}));
    if (!r.ok) setErr(d?.error || "Unable to create listing");
    setCreating(false);
    setName("");
    setShortIntro("");
    load(); // This will reload the table and show the new "PENDING" listing
  }

  // ðŸ‘‡ *** THIS IS THE FIX ***
  // We no longer need the submitForReview function, so we remove it.
  /*
  async function submitForReview(id: string) {
    await fetch(`/api/listings/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "submit" }),
    });
    load();
  }
  */

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <section className="mx-auto max-w-6xl p-6 sm:p-10">
        <header className="mb-6">
          <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">
            Owner Â· Manage listings
          </h1>
          {/* ðŸ‘‡ *** FIX *** (Updated description) */}
          <p className="text-sm text-emerald-900/70">
            Create a listing to submit it for review.
          </p>
        </header>

        {err && (
          <div className="rounded-xl bg-rose-50 border border-rose-200 text-rose-950 px-4 py-3 mb-4 text-sm">
            {err}
          </div>
        )}

        <form
          onSubmit={onCreate}
          className="rounded-2xl border border-emerald-900/10 bg-white/70 p-4 sm:p-6 shadow-sm grid gap-3 sm:grid-cols-3"
        >
          <div className="sm:col-span-1">
            <label className="block text-sm font-medium text-emerald-950">
              Business name
            </label>
            <input
              value={name}
              onChange={(e) => setName(e.target.value)}
              required
              className="mt-1 w-full rounded-xl border border-emerald-900/15 bg-white px-3 py-2 shadow-inner outline-none focus:border-emerald-600/40 focus:ring-1 focus:ring-emerald-600/20"
            />
          </div>
          <div className="sm:col-span-2">
            <label className="block text-sm font-medium text-emerald-950">
              Short intro
            </label>
            <input
              value={shortIntro}
              onChange={(e) => setShortIntro(e.target.value)}
              className="mt-1 w-full rounded-xl border border-emerald-900/15 bg-white px-3 py-2 shadow-inner outline-none"
              placeholder="What you're known forâ€¦"
            />
          </div>
          <div className="sm:col-span-3">
            {/* ðŸ‘‡ *** FIX *** (Updated button text) */}
            <button
              disabled={creating}
              className="rounded-xl bg-emerald-600 text-white px-4 py-2 shadow-sm hover:bg-emerald-700"
            >
              {creating ? "Submitting..." : "Create & submit for review"}
            </button>
          </div>
        </form>

        <div className="mt-6 overflow-x-auto rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b border-emerald-900/10">
                <th className="p-3">Name</th>
                <th className="p-3">Status</th>
                <th className="p-3">Slug</th>
                <th className="p-3">Actions</th>
              </tr>
            </thead>
            <tbody>
              {loading ? (
                <tr>
                  <td className="p-4 text-emerald-900/70" colSpan={4}>
                    Loadingâ€¦
                  </td>
                </tr>
              ) : listings.length === 0 ? (
                <tr>
                  <td className="p-4 text-emerald-900/70" colSpan={4}>
                    No listings yet.
                  </td>
                </tr>
              ) : (
                listings.map((l: any) => (
                  <tr key={l.id} className="border-t border-emerald-900/10">
                    <td className="p-3">{l.name}</td>
                    <td className="p-3">
                      {/* ðŸ‘‡ *** FIX *** (Added status styling) */}
                      <span
                        className={`rounded-full px-2 py-0.5 text-xs font-medium border ${
                          l.status === "PUBLISHED"
                            ? "bg-emerald-50 text-emerald-800 border-emerald-200"
                            : l.status === "REJECTED"
                            ? "bg-rose-50 text-rose-800 border-rose-200"
                            : l.status === "PENDING"
                            ? "bg-amber-50 text-amber-800 border-amber-200"
                            : "bg-slate-50 text-slate-800 border-slate-200"
                        }`}
                      >
                        {l.status}
                      </span>
                    </td>
                    <td className="p-3">{l.slug}</td>
                    <td className="p-3">
                      <div className="flex gap-2">
                        {/* ðŸ‘‡ *** FIX *** (Removed the Submit button) */}
                        {/* <button onClick={() => submitForReview(l.id)} className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">Submit</button> */}
                        <Link
                          href={`/explore/${l.slug}`}
                          className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50"
                        >
                          Preview
                        </Link>
                      </div>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  );
}

```

## File: app/verify/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 4156 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:43:30

### Code

```typescript
// =============================================================
// app/verify/page.tsx â€” email verification landing
// =============================================================
"use client";
import React, { Suspense, useEffect, useState } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { BgDecor, BrandAside, Alert, Spinner } from "../components/auth/ui";

function VerifyForm() {
  const params = useSearchParams();
  const router = useRouter();
  const token = params.get("token");

  const [status, setStatus] = useState<"idle" | "loading" | "ok" | "error">("idle");
  const [message, setMessage] = useState<string>("");

  useEffect(() => {
    async function run() {
      if (!token) {
        setStatus("error");
        setMessage("Missing verification token.");
        return;
      }
      setStatus("loading");
      try {
        const res = await fetch(`/api/auth/verify?token=${encodeURIComponent(token)}`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || "Verification failed.");
        setStatus("ok");
        setMessage("Your email is verified. You can sign in now.");
      } catch (e: any) {
        setStatus("error");
        setMessage(e?.message || "Verification failed.");
      }
    }
    run();
  }, [token]);

  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />

      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <span className="inline-flex items-center gap-2 rounded-full border border-emerald-600/20 bg-emerald-600/5 px-3 py-1 text-xs font-medium text-emerald-800">
              <span className="h-1.5 w-1.5 rounded-full bg-emerald-600" />
              Verify email
            </span>
            <h1 className="mt-4 text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Checking your linkâ€¦</h1>
            <p className="mt-2 text-sm text-emerald-900/70">Please wait while we confirm your account.</p>
          </div>

          {status === "loading" && (
            <div className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 sm:p-8 text-center">
              <Spinner label="Verifying" />
            </div>
          )}

          {status === "ok" && (
            <div className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 sm:p-8">
              <Alert type="success" message={message || "Verified"} />
              <Link href="/login?verified=true" className="mt-2 inline-flex items-center justify-center rounded-xl bg-emerald-600 px-4 py-2 text-white font-medium shadow-sm hover:bg-emerald-700">Go to sign in</Link>
            </div>
          )}

          {status === "error" && (
            <div className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 sm:p-8">
              <Alert type="error" message={message || "Verification failed"} />
              <div className="flex items-center gap-3 mt-2">
                <Link href="/register" className="text-emerald-800 hover:underline">Create account</Link>
                <span className="text-emerald-900/50">Â·</span>
                <Link href="/reset-request" className="text-emerald-800 hover:underline">Forgot password?</Link>
              </div>
            </div>
          )}
        </div>
      </section>
    </main>
  );
}

function VerifyFallback() {
  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />
      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <h1 className="text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Loading...</h1>
          </div>
        </div>
      </section>
    </main>
  );
}

export default function VerifyPage() {
  return (
    <Suspense fallback={<VerifyFallback />}>
      <VerifyForm />
    </Suspense>
  );
}
```

## File: app/reset/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 6196 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:44:32

### Code

```typescript
// =============================================================
// app/reset/page.tsx â€” set a new password (token in URL)
// =============================================================
"use client";
import React, { Suspense, useState } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { BgDecor, BrandAside, Alert, Spinner } from "../components/auth/ui";

function ResetForm() {
  const params = useSearchParams();
  const router = useRouter();
  const token = params.get("token") || "";

  const [password, setPassword] = useState("");
  const [password2, setPassword2] = useState("");
  const [show, setShow] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [err, setErr] = useState<string | null>(null);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (submitting) return;
    setMsg(null);
    setErr(null);

    if (!token) return setErr("Reset link missing or invalid.");
    if (password !== password2) return setErr("Passwords do not match.");
    if (password.length < 8) return setErr("Password must be at least 8 characters.");

    setSubmitting(true);
    try {
      const res = await fetch("/api/auth/reset", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, password }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || "Unable to reset password.");

      setMsg("Password updated. You can sign in now.");
      setTimeout(() => router.push("/login"), 800);
    } catch (e: any) {
      setErr(e?.message || "Something went wrong. Please try again.");
    } finally {
      setSubmitting(false);
    }
  }

  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />

      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <span className="inline-flex items-center gap-2 rounded-full border border-emerald-600/20 bg-emerald-600/5 px-3 py-1 text-xs font-medium text-emerald-800">
              <span className="h-1.5 w-1.5 rounded-full bg-emerald-600" />
              Choose a new password
            </span>
            <h1 className="mt-4 text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Reset your password</h1>
            <p className="mt-2 text-sm text-emerald-900/70">Your reset link is tied to this device and expires for security.</p>
          </div>

          {msg && <Alert type="success" message={msg} />}
          {err && <Alert type="error" message={err} />}

          <form onSubmit={onSubmit} className="rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm backdrop-blur p-6 sm:p-8 space-y-5">
            <div className="space-y-1.5">
              <label htmlFor="password" className="block text-sm font-medium text-emerald-950">New password</label>
              <div className="relative">
                <input
                  id="password"
                  type={show ? "text" : "password"}
                  required
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="peer w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring pr-12"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  autoComplete="new-password"
                />
                <button
                  type="button"
                  onClick={() => setShow((s) => !s)}
                  className="absolute inset-y-0 right-2 my-auto h-9 rounded-lg px-3 text-sm text-emerald-950/70 hover:bg-emerald-50"
                >
                  {show ? "Hide" : "Show"}
                </button>
              </div>
            </div>

            <div className="space-y-1.5">
              <label htmlFor="password2" className="block text-sm font-medium text-emerald-950">Confirm new password</label>
              <input
                id="password2"
                type={show ? "text" : "password"}
                required
                value={password2}
                onChange={(e) => setPassword2(e.target.value)}
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                autoComplete="new-password"
              />
            </div>

            <button
              type="submit"
              disabled={submitting}
              className="group inline-flex w-full items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 py-3 text-white font-medium shadow-sm transition hover:bg-emerald-700 disabled:opacity-60"
            >
              {submitting ? <Spinner label="Updating" /> : <span>Update password</span>}
            </button>

            <p className="text-center text-sm text-emerald-900/70">
              All set? <Link href="/login" className="text-emerald-800 hover:underline">Back to sign in</Link>
            </p>
          </form>
        </div>
      </section>
    </main>
  );
}

function ResetFallback() {
  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />
      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <h1 className="text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Loading...</h1>
          </div>
        </div>
      </section>
    </main>
  );
}

export default function ResetPage() {
  return (
    <Suspense fallback={<ResetFallback />}>
      <ResetForm />
    </Suspense>
  );
}
```

## File: app/admin/listings/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 5471 bytes
- Created: 2025-11-10 14:33:34
- Modified: 2025-11-10 10:59:22

### Code

```typescript
import { auth } from "@/auth";
import { headers, cookies } from "next/headers";

// ðŸ‘‡ *** HELPER FUNCTION ***
// This function forwards the admin's session cookies to the API
async function apiFetch(path: string, init: RequestInit = {}) {
  const h = headers();
  const c = cookies();
  const host = h.get("x-forwarded-host") ?? h.get("host");
  const proto = h.get("x-forwarded-proto") ?? "http";

  if (!host) throw new Error("Missing host header");

  const base = `${proto}://${host}`;

  return fetch(`${base}${path}`, {
    ...init,
    cache: "no-store",
    headers: {
      ...(init.headers || {}),
      cookie: c.toString(),
      "content-type":
        (init.headers as any)?.["content-type"] ?? "application/json",
    },
  });
}

async function getListings() {
  // ðŸ‘‡ Use `apiFetch` to ensure the admin's session is sent
  const res = await apiFetch("/api/listings?all=1");
  if (!res.ok) return { listings: [] as any[] };
  return res.json();
}

export default async function AdminListingsPage() {
  const session = await auth();
  if (!session?.user) return null;

  const { listings } = await getListings();

  async function moderate(
    id: string,
    status: "PUBLISHED" | "REJECTED" | "PENDING",
  ) {
    "use server";
    // ðŸ‘‡ Use `apiFetch` to send the moderation command as an admin
    await apiFetch(`/api/listings/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "moderate", status }),
    });
  }

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <section className="mx-auto max-w-6xl p-6 sm:p-10">
        <header className="mb-6">
          <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">
            Admin Â· Listings
          </h1>
          <p className="text-sm text-emerald-900/70">
            Moderate submissions and keep the directory tidy.
          </p>
        </header>

        <div className="overflow-x-auto rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b border-emerald-900/10">
                <th className="p-3">Name</th>
                <th className="p-3">Status</th>
                <th className="p-3">Owner</th>
                <th className="p-3">Created</th>
                <th className="p-3">Actions</th>
              </tr>
            </thead>
            <tbody>
              {listings.map((l: any) => (
                <tr key={l.id} className="border-t border-emerald-900/10">
                  <td className="p-3">{l.name}</td>
                  <td className="p-3">
                    {/* ðŸ‘‡ Added styling for status */}
                    <span
                      className={`rounded-full px-2 py-0.5 text-xs font-medium border ${
                        l.status === "PUBLISHED"
                          ? "bg-emerald-50 text-emerald-800 border-emerald-200"
                          : l.status === "REJECTED"
                          ? "bg-rose-50 text-rose-800 border-rose-200"
                          : l.status === "PENDING"
                          ? "bg-amber-50 text-amber-800 border-amber-200"
                          : "bg-slate-50 text-slate-800 border-slate-200"
                      }`}
                    >
                      {l.status}
                    </span>
                  </td>
                  <td className="p-3">{l.ownerId || "â€”"}</td>
                  <td className="p-3">
                    {new Date(l.createdAt).toLocaleString()}
                  </td>
                  <td className="p-3">
                    <div className="flex gap-2">
                      <form action={moderate.bind(null, l.id, "PUBLISHED")}>
                        <button className="rounded-lg bg-emerald-600 text-white px-3 py-1 hover:bg-emerald-700">
                          Publish
                        </button>
                      </form>
                      <form action={moderate.bind(null, l.id, "REJECTED")}>
                        <button className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">
                          Reject
                        </button>
                      </form>
                      <form action={moderate.bind(null, l.id, "PENDING")}>
                        <button className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">
                          Pend
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              ))}
              {listings.length === 0 && (
                <tr>
                  <td
                    className="p-4 text-emerald-900/70"
                    colSpan={5}
                  >
                    No listings found.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  );
}

```

## File: app/admin/requests/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 4656 bytes
- Created: 2025-11-10 18:21:31
- Modified: 2025-11-10 16:30:37

### Code

```typescript
import { auth } from "@/auth";

async function getAll() {
  const res = await fetch("/api/requests?all=1", { cache: "no-store" });
  if (!res.ok) return { requests: [] as any[] };
  return res.json();
}

export default async function AdminRequestsPage() {
  const session = await auth();
  const user = session?.user as any;
  if (!user) return null;
  const isStaff = user.role === "ADMIN" || user.role === "EDITOR";
  if (!isStaff) return null;

  const { requests } = await getAll();

  async function moderate(id: string, action: "APPROVED" | "REJECTED" | "PENDING") {
    "use server";
    await fetch("/api/requests", {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, action }),
      cache: "no-store",
    });
  }

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <section className="mx-auto max-w-6xl p-6 sm:p-10">
        <header className="mb-6">
          <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">Admin Â· Approvals</h1>
          <p className="text-sm text-emerald-900/70">Review user-submitted requests.</p>
        </header>

        <div className="overflow-x-auto rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b border-emerald-900/10">
                <th className="p-3">ID</th>
                <th className="p-3">User name</th>
                <th className="p-3">Task subject</th>
                <th className="p-3">Request time</th>
                <th className="p-3">Actions</th>
                <th className="p-3">Action time</th>
              </tr>
            </thead>
            <tbody>
              {requests.map((r: any) => (
                <tr key={r.id} className="border-t border-emerald-900/10 align-top">
                  <td className="p-3 text-xs">{r.id}</td>
                  <td className="p-3">
                    <div className="font-medium">{r.userName || "â€”"}</div>
                    <div className="text-xs text-emerald-900/60">{r.userEmail || ""}</div>
                  </td>
                  <td className="p-3">
                    <div className="font-medium">{r.subject}</div>
                    {r.payload ? (
                      <pre className="mt-1 max-w-[520px] overflow-x-auto rounded-lg bg-slate-50 p-2 text-[11px] text-slate-700">
                        {JSON.stringify(r.payload, null, 2)}
                      </pre>
                    ) : null}
                  </td>
                  <td className="p-3">{new Date(r.requestTime).toLocaleString()}</td>
                  <td className="p-3">
                    <div className="flex flex-wrap items-center gap-2">
                      <span className={`rounded-full px-2 py-0.5 text-xs border ${
                        r.action === "APPROVED" ? "bg-emerald-50 text-emerald-800 border-emerald-200"
                        : r.action === "REJECTED" ? "bg-rose-50 text-rose-800 border-rose-200"
                        : "bg-amber-50 text-amber-800 border-amber-200"
                      }`}>
                        {r.action || "PENDING"}
                      </span>
                      <form action={moderate.bind(null, r.id, "APPROVED")}><button className="rounded-lg bg-emerald-600 text-white px-3 py-1 hover:bg-emerald-700">Approve</button></form>
                      <form action={moderate.bind(null, r.id, "REJECTED")}><button className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">Reject</button></form>
                      <form action={moderate.bind(null, r.id, "PENDING")}><button className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">Pend</button></form>
                    </div>
                  </td>
                  <td className="p-3">{r.actionTime ? new Date(r.actionTime).toLocaleString() : "â€”"}</td>
                </tr>
              ))}
              {requests.length === 0 && (
                <tr><td className="p-4 text-emerald-900/70" colSpan={6}>No requests yet.</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  );
}

```

## File: app/admin/users/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 7898 bytes
- Created: 2025-11-10 18:21:31
- Modified: 2025-11-10 16:54:12

### Code

```typescript
import { auth } from "@/auth";
import { headers, cookies } from "next/headers";
import Link from "next/link";

async function apiFetch(path: string, init: RequestInit = {}) {
  const h = await headers();
  const c = await cookies();
  const host = h.get("x-forwarded-host") ?? h.get("host");
  const proto = h.get("x-forwarded-proto") ?? "http";
  if (!host) throw new Error("Missing host header");
  const base = `${proto}://${host}`;

  return fetch(`${base}${path}`, {
    ...init,
    cache: "no-store",
    headers: {
      ...(init.headers || {}),
      cookie: c.toString(),
      "content-type": (init.headers as any)?.["content-type"] ?? "application/json",
    },
  });
}

async function getUsers() {
  const res = await apiFetch(`/api/admin/users`);
  if (!res.ok) return { users: [] as any[] };
  return res.json();
}

export default async function AdminUsersPage() {
  const session = await auth();
  if (!session?.user) return null;

  const { users } = await getUsers();

  async function softDelete(id: string) {
    "use server";
    await apiFetch(`/api/admin/users/${id}/soft-delete`, { method: "POST" });
  }

  async function hardDelete(id: string) {
    "use server";
    await apiFetch(`/api/admin/users/${id}/hard-delete`, { method: "POST" });
  }

  async function updateStatus(id: string, status: string) {
    "use server";
    await apiFetch(`/api/admin/users/${id}/status`, {
      method: "PATCH",
      body: JSON.stringify({ status }),
    });
  }

  async function invite(formData: FormData) {
    "use server";
    const email = String(formData.get("email") || "");
    const role = String(formData.get("role") || "VISITOR");
    await apiFetch(`/api/admin/users`, {
      method: "POST",
      body: JSON.stringify({ email, role }),
    });
  }

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <section className="mx-auto max-w-7xl p-6 sm:p-10">
        <header className="mb-6 flex items-center justify-between">
          <div>
            <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">Admin Â· Users</h1>
            <p className="text-sm text-emerald-900/70">Invite, manage, soft-delete, or permanently remove users.</p>
          </div>
          <Link
            href="/admin/users/create"
            className="rounded-xl bg-emerald-600 text-white px-4 py-2 text-sm font-medium shadow-sm hover:bg-emerald-700"
          >
            + Create User
          </Link>
        </header>

        <form action={invite} className="rounded-2xl border border-emerald-900/10 bg-white/70 p-4 sm:p-6 shadow-sm flex flex-col sm:flex-row gap-3 sm:items-end mb-6">
          <div className="flex-1">
            <label className="block text-sm font-medium text-emerald-950">Invite email</label>
            <input name="email" type="email" required className="mt-1 w-full rounded-xl border border-emerald-900/15 bg-white px-3 py-2 shadow-inner outline-none focus:border-emerald-600/40 focus:ring-1 focus:ring-emerald-600/20" placeholder="user@example.com" />
          </div>
          <div>
            <label className="block text-sm font-medium text-emerald-950">Role</label>
            <select name="role" defaultValue="VISITOR" className="mt-1 rounded-xl border border-emerald-900/15 bg-white px-3 py-2 shadow-inner outline-none">
              <option value="VISITOR">Visitor</option>
              <option value="OWNER">Owner</option>
              <option value="EDITOR">Editor</option>
              <option value="ADMIN">Admin</option>
            </select>
          </div>
          <button type="submit" className="rounded-xl bg-emerald-600 text-white px-4 py-2 shadow-sm hover:bg-emerald-700">Send invite</button>
        </form>

        <div className="overflow-x-auto rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b border-emerald-900/10">
                <th className="p-3">Email</th>
                <th className="p-3">Name</th>
                <th className="p-3">Role</th>
                <th className="p-3">Status</th>
                <th className="p-3">Verified</th>
                <th className="p-3">Deleted</th>
                <th className="p-3">Actions</th>
              </tr>
            </thead>
            <tbody>
              {users.map((u: any) => (
                <tr key={u.id} className="border-t border-emerald-900/10">
                  <td className="p-3">{u.email}</td>
                  <td className="p-3">{u.name || "â€”"}</td>
                  <td className="p-3">{u.role}</td>
                  <td className="p-3">
                    <span
                      className={`inline-flex rounded-full px-2 py-0.5 text-xs font-medium border ${
                        u.status === "VERIFIED" || u.status === "ACTIVE"
                          ? "bg-emerald-50 text-emerald-800 border-emerald-200"
                          : u.status === "PENDING"
                          ? "bg-amber-50 text-amber-800 border-amber-200"
                          : u.status === "SUSPENDED"
                          ? "bg-rose-50 text-rose-800 border-rose-200"
                          : "bg-slate-50 text-slate-800 border-slate-200"
                      }`}
                    >
                      {u.status || "PENDING"}
                    </span>
                  </td>
                  <td className="p-3">{u.emailVerified ? "Yes" : "No"}</td>
                  <td className="p-3">{u.deletedAt ? "Yes" : "No"}</td>
                  <td className="p-3">
                    <div className="flex flex-wrap gap-2">
                      {/* Status change buttons */}
                      <form action={updateStatus.bind(null, u.id, "VERIFIED")}>
                        <button className="rounded-lg border border-emerald-900/15 px-2 py-1 text-xs hover:bg-emerald-50">
                          Verify
                        </button>
                      </form>
                      <form action={updateStatus.bind(null, u.id, "ACTIVE")}>
                        <button className="rounded-lg border border-emerald-900/15 px-2 py-1 text-xs hover:bg-emerald-50">
                          Active
                        </button>
                      </form>
                      <form action={updateStatus.bind(null, u.id, "SUSPENDED")}>
                        <button className="rounded-lg border border-amber-900/15 px-2 py-1 text-xs hover:bg-amber-50">
                          Suspend
                        </button>
                      </form>
                      
                      {/* Existing actions */}
                      <form action={softDelete.bind(null, u.id)}>
                        <button className="rounded-lg border border-emerald-900/15 px-2 py-1 text-xs hover:bg-emerald-50">Soft delete</button>
                      </form>
                      <form action={hardDelete.bind(null, u.id)}>
                        <button className="rounded-lg bg-rose-600 text-white px-2 py-1 text-xs hover:bg-rose-700">Hard delete</button>
                      </form>
                    </div>
                  </td>
                </tr>
              ))}
              {users.length === 0 && (
                <tr><td className="p-4 text-emerald-900/70" colSpan={7}>No users yet.</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  );
}
```

## File: app/admin/users/create/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 6943 bytes
- Created: 2025-11-10 16:53:32
- Modified: 2025-11-10 16:53:32

### Code

```typescript
"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";

export default function AdminCreateUserPage() {
  const router = useRouter();
  const [email, setEmail] = useState("");
  const [name, setName] = useState("");
  const [password, setPassword] = useState("");
  const [role, setRole] = useState<"VISITOR" | "OWNER" | "EDITOR" | "ADMIN">("VISITOR");
  const [showPassword, setShowPassword] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError(null);
    setSuccess(false);
    setSubmitting(true);

    try {
      const res = await fetch("/api/admin/users/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, name, password, role }),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || "Failed to create user");
      }

      setSuccess(true);
      setEmail("");
      setName("");
      setPassword("");
      setRole("VISITOR");
      
      // Redirect to users page after a short delay
      setTimeout(() => {
        router.push("/admin/users");
      }, 1500);
    } catch (err: any) {
      setError(err.message || "Something went wrong");
    } finally {
      setSubmitting(false);
    }
  }

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <section className="mx-auto max-w-2xl p-6 sm:p-10">
        <header className="mb-6">
          <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">
            Create New User
          </h1>
          <p className="text-sm text-emerald-900/70">
            Create a user account without email verification. The user will be automatically verified.
          </p>
        </header>

        {error && (
          <div className="rounded-xl bg-rose-50 border border-rose-200 text-rose-950 px-4 py-3 mb-4 text-sm">
            {error}
          </div>
        )}

        {success && (
          <div className="rounded-xl bg-emerald-50 border border-emerald-200 text-emerald-950 px-4 py-3 mb-4 text-sm">
            User created successfully! Redirecting...
          </div>
        )}

        <form
          onSubmit={handleSubmit}
          className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 shadow-sm space-y-5"
        >
          <div className="space-y-1.5">
            <label htmlFor="email" className="block text-sm font-medium text-emerald-950">
              Email *
            </label>
            <input
              id="email"
              type="email"
              required
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
              placeholder="user@example.com"
            />
          </div>

          <div className="space-y-1.5">
            <label htmlFor="name" className="block text-sm font-medium text-emerald-950">
              Name
            </label>
            <input
              id="name"
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
              placeholder="John Doe"
            />
          </div>

          <div className="space-y-1.5">
            <label htmlFor="password" className="block text-sm font-medium text-emerald-950">
              Password *
            </label>
            <div className="relative">
              <input
                id="password"
                type={showPassword ? "text" : "password"}
                required
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring pr-12"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              />
              <button
                type="button"
                onClick={() => setShowPassword(!showPassword)}
                className="absolute inset-y-0 right-2 my-auto h-9 rounded-lg px-3 text-sm text-emerald-950/70 hover:bg-emerald-50"
              >
                {showPassword ? "Hide" : "Show"}
              </button>
            </div>
            <p className="text-xs text-emerald-900/60">
              Minimum 8 characters
            </p>
          </div>

          <div className="space-y-1.5">
            <label htmlFor="role" className="block text-sm font-medium text-emerald-950">
              Role *
            </label>
            <select
              id="role"
              value={role}
              onChange={(e) => setRole(e.target.value as any)}
              className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 focus:border-emerald-600/40 focus:ring"
            >
              <option value="VISITOR">Visitor</option>
              <option value="OWNER">Owner</option>
              <option value="EDITOR">Editor</option>
              <option value="ADMIN">Admin</option>
            </select>
          </div>

          <div className="flex gap-3 pt-2">
            <button
              type="submit"
              disabled={submitting}
              className="flex-1 rounded-xl bg-emerald-600 text-white px-4 py-3 font-medium shadow-sm hover:bg-emerald-700 disabled:opacity-60"
            >
              {submitting ? "Creating..." : "Create User"}
            </button>
            <button
              type="button"
              onClick={() => router.push("/admin/users")}
              className="rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-sm hover:bg-emerald-50"
            >
              Cancel
            </button>
          </div>
        </form>
      </section>
    </main>
  );
}
```

## File: app/admin/submissions/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 9915 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-10-31 16:33:22

### Code

```typescript
// app/admin/submissions/page.tsx
import { auth } from "@/auth";
import { headers, cookies } from "next/headers";
import type { ReactNode } from "react";

async function apiFetch(path: string, init: RequestInit = {}) {
  const h = await headers();
  const c = await cookies();
  const host = h.get("x-forwarded-host") ?? h.get("host");
  const proto = h.get("x-forwarded-proto") ?? "http";
  if (!host) throw new Error("Missing host header");
  const base = `${proto}://${host}`;
  return fetch(`${base}${path}`, {
    ...init,
    cache: "no-store",
    headers: { ...(init.headers || {}), cookie: c.toString(), "content-type": "application/json" },
  });
}

function FormDataDisplay({ data }: { data: any }) {
  const renderValue = (value: any, key?: string): ReactNode => {
    // Handle null/undefined
    if (value === null || value === undefined) {
      return <span className="text-slate-400 italic">empty</span>;
    }

    // Handle booleans
    if (typeof value === "boolean") {
      return (
        <span className={value ? "text-emerald-600 font-medium" : "text-slate-500"}>
          {value ? "Yes" : "No"}
        </span>
      );
    }

    // Handle numbers (including timestamps)
    if (typeof value === "number") {
      // Check if it looks like a timestamp (10 or 13 digits)
      if (value > 1_000_000_000 && value < 10_000_000_000_000) {
        const date = new Date(value > 10_000_000_000 ? value : value * 1000);
        return (
          <span className="text-slate-700">
            {value}
            <span className="ml-2 text-xs text-slate-500">({date.toLocaleString()})</span>
          </span>
        );
      }

      // Check if it's a coordinate
      if (
        key &&
        (key.toLowerCase().includes("lat") ||
          key.toLowerCase().includes("lng") ||
          key.toLowerCase().includes("lon") ||
          key.toLowerCase().includes("coord"))
      ) {
        return <span className="text-blue-600 font-mono text-sm">{value.toFixed(6)}Â°</span>;
      }

      return <span className="text-slate-700 font-mono">{value}</span>;
    }

    // Handle strings
    if (typeof value === "string") {
      // URL?
      if (value.match(/^https?:\/\//)) {
        return (
          <a
            href={value}
            target="_blank"
            rel="noopener noreferrer"
            className="text-blue-600 hover:text-blue-700 underline break-all"
          >
            {value}
          </a>
        );
      }

      // Long text?
      if (value.length > 100) {
        return <span className="text-slate-700 break-words leading-relaxed">{value}</span>;
      }

      return <span className="text-slate-700">{value}</span>;
    }

    // Arrays
    if (Array.isArray(value)) {
      if (value.length === 0) {
        return <span className="text-slate-400 italic">empty list</span>;
      }
      return (
        <div className="space-y-1">
          {value.map((item, idx) => (
            <div key={idx} className="flex gap-2 pl-4 border-l-2 border-emerald-200">
              <span className="text-slate-500 text-xs mt-0.5">{idx + 1}.</span>
              <div className="flex-1">{renderValue(item)}</div>
            </div>
          ))}
        </div>
      );
    }

    // Objects
    if (typeof value === "object") {
      return (
        <div className="space-y-2 pl-4 border-l-2 border-slate-200">
          {Object.entries(value).map(([k, v]) => (
            <div key={k} className="space-y-1">
              <div className="text-xs font-semibold text-emerald-700 uppercase tracking-wide">
                {k.replace(/([A-Z])/g, " $1").replace(/^./, (str) => str.toUpperCase())}
              </div>
              <div className="pl-2">{renderValue(v, k)}</div>
            </div>
          ))}
        </div>
      );
    }

    return <span className="text-slate-700">{String(value)}</span>;
  };

  if (!data || Object.keys(data).length === 0) {
    return <div className="text-slate-400 italic text-sm">No data available</div>;
  }

  return (
    <div className="space-y-3">
      {Object.entries(data).map(([key, value]) => (
        <div key={key} className="group/item">
          <div className="flex items-baseline gap-2 mb-1">
            <span className="text-sm font-semibold text-emerald-800 uppercase tracking-wide">
              {key.replace(/([A-Z])/g, " $1").replace(/^./, (str) => str.toUpperCase())}
            </span>
          </div>
          <div className="pl-3">{renderValue(value, key)}</div>
        </div>
      ))}
    </div>
  );
}

async function getAll() {
  const res = await apiFetch("/api/submissions?all=1");
  if (!res.ok) return { submissions: [] as any[] };
  return res.json();
}

export default async function AdminSubmissionsPage() {
  const session = await auth();
  const me = session?.user as any;
  if (!me || !["ADMIN", "EDITOR"].includes(me.role)) return null;

  const { submissions } = await getAll();

  async function setStatus(id: string, status: "APPROVED" | "REJECTED" | "PENDING") {
    "use server";
    await apiFetch("/api/submissions", {
      method: "PATCH",
      body: JSON.stringify({ id, status }),
    });
  }

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <section className="mx-auto max-w-7xl p-6 sm:p-10">
        <header className="mb-6">
          <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">Admin Â· Submissions</h1>
          <p className="text-sm text-emerald-900/70">Review and approve user-submitted JSON.</p>
        </header>

        <div className="overflow-x-auto rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b border-emerald-900/10">
                <th className="p-3">ID</th>
                <th className="p-3">User</th>
                <th className="p-3">Form</th>
                <th className="p-3">Request time</th>
                <th className="p-3">Actions</th>
                <th className="p-3">Action time</th>
              </tr>
            </thead>
            <tbody>
              {submissions.map((s: any) => (
                <tr key={s.id} className="border-t border-emerald-900/10 align-top">
                  <td className="p-3 text-xs">{s.id}</td>
                  <td className="p-3">
                    <div className="font-medium">{s.userName || "â€”"}</div>
                    <div className="text-xs text-emerald-900/60">{s.userEmail}</div>
                  </td>
                  <td className="p-3">
                    <details className="group">
                      <summary className="cursor-pointer font-medium text-emerald-950 hover:text-emerald-700 transition-colors">
                        {s.formName}
                        <span className="ml-2 text-emerald-600 text-xs group-open:hidden">â–¼ View details</span>
                        <span className="ml-2 text-emerald-600 text-xs hidden group-open:inline">â–² Hide details</span>
                      </summary>
                      <div className="mt-3 max-w-[640px] rounded-lg bg-gradient-to-br from-slate-50 to-slate-100/50 p-4 border border-slate-200 shadow-sm">
                        <FormDataDisplay data={s.data} />
                      </div>
                    </details>
                  </td>
                  <td className="p-3">{new Date(s.submittedAt).toLocaleString()}</td>
                  <td className="p-3">
                    <div className="flex flex-wrap items-center gap-2">
                      <span
                        className={`rounded-full px-2 py-0.5 text-xs border ${
                          s.status === "APPROVED"
                            ? "bg-emerald-50 text-emerald-800 border-emerald-200"
                            : s.status === "REJECTED"
                            ? "bg-rose-50 text-rose-800 border-rose-200"
                            : "bg-amber-50 text-amber-800 border-amber-200"
                        }`}
                      >
                        {s.status}
                      </span>
                      <form action={setStatus.bind(null, s.id, "APPROVED")}>
                        <button className="rounded-lg bg-emerald-600 text-white px-3 py-1 hover:bg-emerald-700">
                          Approve
                        </button>
                      </form>
                      <form action={setStatus.bind(null, s.id, "REJECTED")}>
                        <button className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">
                          Reject
                        </button>
                      </form>
                      <form action={setStatus.bind(null, s.id, "PENDING")}>
                        <button className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">
                          Pend
                        </button>
                      </form>
                    </div>
                  </td>
                  <td className="p-3">{s.actionTime ? new Date(s.actionTime).toLocaleString() : "â€”"}</td>
                </tr>
              ))}
              {submissions.length === 0 && (
                <tr>
                  <td className="p-4 text-emerald-900/70" colSpan={6}>
                    No submissions yet.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  );
}

```

## File: app/dashboard/sign-out-button.tsx

- Extension: .tsx
- Language: typescript
- Size: 307 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-03 18:01:12

### Code

```typescript
// app/dashboard/sign-out-button.tsx (Client Component)
"use client"

import { signOut } from "next-auth/react"

export default function SignOutButton() {
  return (
    <button
      onClick={() => signOut({ callbackUrl: "/login" })}
      style={{ marginTop: 16 }}
    >
      Sign out
    </button>
  )
}
```

## File: app/dashboard/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 5349 bytes
- Created: 2025-11-12 15:25:50
- Modified: 2025-11-12 15:25:50

### Code

```typescript
// app/dashboard/page.tsx
import { auth } from "@/auth";
import { headers, cookies } from "next/headers";
import Link from "next/link";

// Helper: same-origin fetch with cookies forwarded
async function apiFetch(path: string, init: RequestInit = {}) {
  const h = await headers();
  const c = await cookies();
  const host = h.get("x-forwarded-host") ?? h.get("host");
  const proto = h.get("x-forwarded-proto") ?? "http";
  if (!host) throw new Error("Missing host header");
  const base = `${proto}://${host}`;
  return fetch(`${base}${path}`, {
    ...init,
    cache: "no-store",
    headers: {
      ...(init.headers || {}),
      cookie: c.toString(), // forward session cookies
    },
  });
}

async function getMyListings() {
  const res = await apiFetch("/api/listings");
  if (!res.ok) return { listings: [] as any[] };
  return res.json();
}

export default async function Dashboard() {
  const session = await auth();
  if (!session?.user) return null;
  const { listings } = await getMyListings();
  const user = session.user as any;
  
  const isAdmin = user.role === "ADMIN";
  const isStaff = user.role === "ADMIN" || user.role === "EDITOR";

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>
      <section className="mx-auto max-w-6xl p-6 sm:p-10">
        <header className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">
              Welcome, {user.name || user.email}
            </h1>
            <p className="text-sm text-emerald-900/70">
              Role: <span className="font-medium">{user.role}</span>
            </p>
          </div>
          <div className="flex gap-2">
            {/* --- FIX: Separated links based on role --- */}
            {isAdmin && (
              <Link
                href="/admin/users"
                className="rounded-xl border border-emerald-900/15 bg-white px-4 py-2 text-emerald-950 shadow-sm hover:bg-emerald-50"
              >
                Admin Â· Users
              </Link>
            )}
            {isStaff && (
              <Link
                href="/admin/listings"
                className="rounded-xl border border-emerald-900/15 bg-white px-4 py-2 text-emerald-950 shadow-sm hover:bg-emerald-50"
              >
                Admin Â· Listings
              </Link>
            )}
            {/* --- End Fix --- */}
          </div>
        </header>

        <div className="mt-8 grid gap-4 sm:grid-cols-3">
          <Card
            title="My listings"
            value={listings.length}
            hint="Create or edit your business pages"
            href="/owner"
          />
          {/* --- FIX: Removed duplicate "Account" card --- */}
          <Card
            title="Account"
            value={user.email}
            hint="Update your profile and account details"
            href="/profile"
          />
          <Card
            title="Explore"
            value="Directory"
            hint="See what visitors see"
            href="/explore"
          />
        </div>

        <div className="mt-8 grid gap-4 sm:grid-cols-2">
          <div className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 shadow-sm">
            <h2 className="font-medium text-emerald-950">Owner quick actions</h2>
            <ul className="mt-2 space-y-2 text-sm">
              <li>
                <Link className="text-emerald-800 hover:underline" href="/owner">
                  Create a listing
                </Link>
              </li>
              <li>
                <Link className="text-emerald-800 hover:underline" href="/owner">
                  Submit for review
                </Link>
              </li>
            </ul>
          </div>
          <div className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 shadow-sm">
            <h2 className="font-medium text-emerald-950">Account</h2>
            <p className="text-sm text-emerald-900/70 mt-1">Email: {user.email}</p>
            <form action="/api/self-delete" method="post" className="mt-4">
              <button className="rounded-xl bg-rose-600 text-white px-4 py-2 text-sm shadow-sm hover:bg-rose-700">
                Delete my account
              </button>
            </form>
          </div>
        </div>
        
        {/* --- FIX: Removed duplicate admin links section --- */}
      </section>
    </main>
  );
}

function Card({
  title,
  value,
  hint,
  href,
}: {
  title: string;
  value: React.ReactNode;
  hint: string;
  href: string;
}) {
  return (
    <Link
      href={href}
      className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 shadow-sm block hover:bg-white"
    >
      <p className="text-sm text-emerald-900/70">{title}</p>
      <p className="mt-1 text-2xl font-semibold text-emerald-950">{value}</p>
      <p className="mt-1 text-xs text-emerald-900/60">{hint}</p>
    </Link>
  );
}
```

## File: app/reset-request/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 3819 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:13:53

### Code

```typescript
// =============================================================
// app/(auth)/reset-request/page.tsx â€” request password reset email
// =============================================================
"use client";
import React, { useState } from "react";
import Link from "next/link";
import { BgDecor, BrandAside, Alert, Spinner } from "../components/auth/ui";

export default function ResetRequestPage() {
  const [email, setEmail] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [err, setErr] = useState<string | null>(null);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (submitting) return;
    setMsg(null);
    setErr(null);

    setSubmitting(true);
    try {
      const res = await fetch("/api/auth/reset-request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || "Unable to send reset email.");
      setMsg("If that email exists, we just sent a reset link. Check your inbox.");
    } catch (e: any) {
      setErr(e?.message || "Something went wrong. Please try again.");
    } finally {
      setSubmitting(false);
    }
  }

  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />

      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <span className="inline-flex items-center gap-2 rounded-full border border-emerald-600/20 bg-emerald-600/5 px-3 py-1 text-xs font-medium text-emerald-800">
              <span className="h-1.5 w-1.5 rounded-full bg-emerald-600" />
              Reset password
            </span>
            <h1 className="mt-4 text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Send reset link</h1>
            <p className="mt-2 text-sm text-emerald-900/70">Weâ€™ll email you a secure link to set a new password.</p>
          </div>

          {msg && <Alert type="success" message={msg} />}
          {err && <Alert type="error" message={err} />}

          <form onSubmit={onSubmit} className="rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm backdrop-blur p-6 sm:p-8 space-y-5">
            <div className="space-y-1.5">
              <label htmlFor="email" className="block text-sm font-medium text-emerald-950">Email</label>
              <input
                id="email"
                type="email"
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                placeholder="you@example.com"
                autoComplete="email"
              />
            </div>

            <button
              type="submit"
              disabled={submitting}
              className="group inline-flex w-full items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 py-3 text-white font-medium shadow-sm transition hover:bg-emerald-700 disabled:opacity-60"
            >
              {submitting ? <Spinner label="Sending" /> : <span>Send reset link</span>}
            </button>

            <p className="text-center text-sm text-emerald-900/70">
              Remembered it? <Link href="/login" className="text-emerald-800 hover:underline">Back to sign in</Link>
            </p>
          </form>
        </div>
      </section>
    </main>
  );
}

```

## File: app/components/DynamicOpenLayersField.tsx

- Extension: .tsx
- Language: typescript
- Size: 13970 bytes
- Created: 2025-11-26 14:32:55
- Modified: 2025-11-26 14:32:55

### Code

```typescript
"use client";
import React, { useEffect, useMemo, useRef, useState, useCallback } from "react";
import "leaflet/dist/leaflet.css";
import "leaflet-draw/dist/leaflet.draw.css"; 
import { MapContainer, TileLayer, FeatureGroup, useMap } from "react-leaflet";
import { EditControl } from "react-leaflet-draw";
import L from "leaflet";
import parseGeoraster from "georaster";
import GeoRasterLayer from "georaster-layer-for-leaflet";
import proj4 from "proj4";

// ---- Proj4 Definitions ----
const proj4Any = proj4 as unknown as {
  defs: any; 
};

if (typeof window !== "undefined") {
  (window as any).proj4 = proj4Any;
  if (!proj4Any.defs["EPSG:5070"]) {
    proj4Any.defs(
      "EPSG:5070",
      "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs"
    );
  }
  if (!proj4Any.defs["ESRI:102003"]) {
    proj4Any.defs(
      "ESRI:102003",
      "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs"
    );
  }
  if (!proj4Any.defs["CUSTOM:AEA_WGS84"]) {
    proj4Any.defs(
      "CUSTOM:AEA_WGS84",
      "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"
    );
  }
}

// --- Types ---
type GeoJSONValue = object | null;

interface OpenLayersFieldProps {
  field: {
    label: string;
    required?: boolean;
    defaultCenter?: [number, number]; // [lon, lat]
    defaultZoom?: number;
  };
  value: GeoJSONValue;
  onChange: (value: GeoJSONValue) => void;
  disabled: boolean;
  tifUrl?: string;
}

// Leaflet marker icon fix
const DefaultIcon = new L.Icon({
  iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
  iconRetinaUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
});
L.Marker.prototype.options.icon = DefaultIcon;

// --- GeoTiff Overlay Component ---
function GeoTiffOverlay({
  url,
  opacity,
  onLoaded,
  onError,
}: {
  url: string;
  opacity: number;
  onLoaded?: (b: L.LatLngBounds) => void;
  onError?: (msg: string) => void;
}) {
  const map = useMap();
  const layerRef = useRef<GeoRasterLayer<any> | null>(null);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
        const ab = await res.arrayBuffer();
        const georaster = await parseGeoraster(ab);
        const layer = new GeoRasterLayer({ georaster, opacity, resolution: 256 });
        
        if (cancelled) return;
        
        layer.addTo(map);
        layerRef.current = layer;
        
        const bounds = layer.getBounds();
        if (bounds?.isValid()) {
          map.fitBounds(bounds, { padding: [40, 40] });
        }
        
        onLoaded?.(bounds);
      } catch (e: any) {
        console.error("GeoTIFF load error:", e);
        onError?.(e?.message ?? "Failed to load GeoTIFF.");
      }
    })();

    return () => {
      cancelled = true;
      if (layerRef.current) {
        map.removeLayer(layerRef.current);
        layerRef.current = null;
      }
    };
  }, [url, map, onLoaded, onError]); // Dependencies include handlers

  // Update opacity without reloading layer
  useEffect(() => {
    if (layerRef.current) layerRef.current.setOpacity(opacity);
  }, [opacity]);

  return null;
}

// Invalidate size when height changes
function InvalidateOnResize({ nonce }: { nonce: number }) {
  const map = useMap();
  useEffect(() => {
    map.invalidateSize();
  }, [nonce, map]);
  return null;
}

// Component to handle clearing layers from outside
function LayerClearer({ 
  shouldClear, 
  onCleared,
  featureGroupRef 
}: { 
  shouldClear: boolean; 
  onCleared: () => void;
  featureGroupRef: React.RefObject<L.FeatureGroup>;
}) {
  const map = useMap();
  
  useEffect(() => {
    if (shouldClear && featureGroupRef.current) {
      featureGroupRef.current.clearLayers();
      onCleared();
    }
  }, [shouldClear, onCleared, featureGroupRef, map]);
  
  return null;
}

export default function DynamicOpenLayersField({
  field,
  value,
  onChange,
  disabled,
  tifUrl = "/map_4326.tif",
}: OpenLayersFieldProps) {
  const [loadingTif, setLoadingTif] = useState(true);
  const [tifError, setTifError] = useState<string | null>(null);
  const [opacity, setOpacity] = useState(0.7);
  const [expanded, setExpanded] = useState(true);
  const [shouldClearLayers, setShouldClearLayers] = useState(false);
  
  const heightPx = expanded ? "70vh" : "400px";
  const sizeNonce = expanded ? 1 : 0;
  
  const featureGroupRef = useRef<L.FeatureGroup>(null);

  const initialCenter = useMemo<[number, number]>(() => {
    const ll = field.defaultCenter ?? [-83.8926, 34.3056]; // [lon, lat]
    return [ll[1], ll[0]]; // Leaflet wants [lat, lon]
  }, [field.defaultCenter]);

  const initialZoom = field.defaultZoom ?? 11;

  // --- FIX: Memoized Handlers for GeoTiffOverlay ---
  // These ensure the GeoTiffOverlay useEffect doesn't re-run when opacity changes
  const handleTifLoaded = useCallback(() => {
    setLoadingTif(false);
    setTifError(null);
  }, []);

  const handleTifError = useCallback((msg: string) => {
    setTifError(msg || "Failed to load GeoTIFF");
    setLoadingTif(false);
  }, []);

  // --- Actions ---
  const handleExport = () => {
    if (!value) {
      alert("No polygon to export.");
      return;
    }
    try {
      const dataStr = JSON.stringify(value, null, 2);
      const dataBlob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(dataBlob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${field.label.replace(/ /g, "_") || "polygon"}.geojson`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error("Export failed:", e);
      alert("Failed to export GeoJSON.");
    }
  };

  const handleDelete = useCallback(() => {
    onChange(null);
    setShouldClearLayers(true);
  }, [onChange]);

  const handleLayersCleared = useCallback(() => {
    setShouldClearLayers(false);
  }, []);

  // --- Leaflet Draw Handlers ---
  const onCreated = (e: any) => {
    if (disabled) return;
    
    if (featureGroupRef.current) {
      featureGroupRef.current.clearLayers();
    }
    
    const layer = e.layer;
    const geoJson = layer.toGeoJSON();
    onChange(geoJson);

    if (featureGroupRef.current) {
      featureGroupRef.current.addLayer(layer);
    }
  };

  const onEdited = (e: any) => {
    if (disabled) return;
    const layers = e.layers;
    
    let editedGeoJson: object | null = null;
    layers.eachLayer((layer: any) => {
      editedGeoJson = layer.toGeoJSON();
    });
    
    if (editedGeoJson) {
      onChange(editedGeoJson);
    }
  };

  const onDeleted = (e: any) => {
    if (disabled) return;
    onChange(null);
  };

  const fileLabel = tifUrl.split("/").pop() || "map.tif";
  const hasPolygon = value !== null;

  return (
    <div className="w-full">
      <div className="flex items-center justify-between mb-2">
        <label className="block text-sm font-semibold text-emerald-900">
          {field.label}
          {field.required && <span className="text-red-500 ml-1">*</span>}
        </label>
        <button
          type="button"
          onClick={() => setExpanded((v) => !v)}
          className="text-xs px-3 py-1.5 rounded-lg border border-emerald-300 text-emerald-800 hover:bg-emerald-50"
          title={expanded ? "Shrink map" : "Expand map"}
        >
          {expanded ? "Shrink" : "Expand"}
        </button>
      </div>

      {/* Status Messages */}
      {tifError && (
        <div className="mb-2 p-2 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-800">
          âš ï¸ {tifError}
        </div>
      )}
      {!tifError && loadingTif && (
        <div className="mb-2 p-2 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
          â³ Loading overlay <b>{fileLabel}</b>...
        </div>
      )}
      {!loadingTif && !tifError && (
        <div className="mb-2 p-2 bg-emerald-50 border border-emerald-200 rounded-lg text-xs text-emerald-800">
          âœ“ Overlay <b>{fileLabel}</b> loaded
        </div>
      )}

      {/* Polygon Status */}
      {hasPolygon && (
        <div className="mb-2 p-2 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800 flex items-center justify-between">
          <span>âœ“ Polygon drawn - Ready for analysis</span>
          <button
            type="button"
            onClick={handleDelete}
            disabled={disabled}
            className="ml-2 px-2 py-1 bg-rose-100 text-rose-700 rounded hover:bg-rose-200 transition disabled:opacity-50"
          >
            Delete
          </button>
        </div>
      )}

      {/* Controls */}
      <div className="mb-2 flex items-center gap-3 flex-wrap">
        <label className="text-xs text-emerald-900/80">
          Overlay opacity
          <input
            type="range" min={0} max={1} step={0.05} value={opacity}
            onChange={(e) => setOpacity(parseFloat(e.target.value))}
            className="ml-2 align-middle"
          />
          <span className="ml-2 text-emerald-700">{Math.round(opacity * 100)}%</span>
        </label>
        
        <button
          type="button"
          onClick={handleExport}
          disabled={!hasPolygon || disabled}
          className="inline-flex items-center gap-2 rounded-lg border border-emerald-300 bg-white px-3 py-1.5 text-sm text-emerald-800 hover:bg-emerald-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
          Export GeoJSON
        </button>
        
        <button
          type="button"
          onClick={handleDelete}
          disabled={!hasPolygon || disabled}
          className="inline-flex items-center gap-2 rounded-lg border border-rose-300 bg-white px-3 py-1.5 text-sm text-rose-700 hover:bg-rose-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          Delete Polygon
        </button>
      </div>

      {/* MAP CONTAINER */}
      <div
        className="w-full overflow-hidden rounded-lg border border-emerald-200 shadow-sm relative"
        style={{ height: heightPx }}
      >
        <MapContainer
          center={initialCenter}
          zoom={initialZoom}
          style={{ height: "100%", width: "100%" }}
          zoomControl
          scrollWheelZoom
        >
          <InvalidateOnResize nonce={sizeNonce} />
          <TileLayer
            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          />
          
          <GeoTiffOverlay
            url={tifUrl}
            opacity={opacity}
            onLoaded={handleTifLoaded}
            onError={handleTifError}
          />

          <FeatureGroup ref={featureGroupRef}>
            {!disabled && (
              <EditControl
                position="topright"
                onCreated={onCreated}
                onEdited={onEdited}
                onDeleted={onDeleted}
                draw={{
                  polygon: {
                    allowIntersection: false,
                    shapeOptions: {
                      color: '#10b981',
                      fillColor: '#10b981',
                      fillOpacity: 0.3,
                      weight: 3,
                    },
                  },
                  marker: false,
                  circle: false,
                  circlemarker: false,
                  rectangle: false,
                  polyline: false,
                }}
                edit={{
                  edit: hasPolygon,
                  remove: hasPolygon,
                }}
              />
            )}
          </FeatureGroup>

          <LayerClearer 
            shouldClear={shouldClearLayers} 
            onCleared={handleLayersCleared}
            featureGroupRef={featureGroupRef}
          />
        </MapContainer>

        {hasPolygon && !disabled && (
          <button
            type="button"
            onClick={handleDelete}
            className="absolute bottom-4 right-4 z-[1000] flex items-center gap-2 px-4 py-2 bg-rose-600 text-white rounded-lg shadow-lg hover:bg-rose-700 transition font-medium"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Delete Polygon
          </button>
        )}
      </div>

      <div className="mt-2 text-xs text-emerald-700">
        <p>
          <strong>Draw:</strong> Click the polygon tool (â—‡) in the top-right corner to draw.
          {hasPolygon && (
            <span className="ml-2 text-rose-600">
              <strong>Delete:</strong> Click the "Delete Polygon" button or use the trash icon (ðŸ—‘ï¸) in the map toolbar.
            </span>
          )}
        </p>
      </div>
    </div>
  );
}
```

## File: app/components/landing/search-bar.tsx

- Extension: .tsx
- Language: typescript
- Size: 3832 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-05 17:22:29

### Code

```typescript
// app/components/landing/search-bar.tsx
"use client";
import React, { useState } from "react";
import { useRouter } from "next/navigation";

export default function LandingSearchBar() {
  const [q, setQ] = useState("");
  const [when, setWhen] = useState<"today" | "weekend" | "any">("any");
  const router = useRouter();

  function submit(e: React.FormEvent) {
    e.preventDefault();
    const params = new URLSearchParams();
    if (q) params.set("q", q);
    if (when !== "any") params.set("when", when);
    router.push(`/explore?${params.toString()}`);
  }

  return (
    <form onSubmit={submit} className="w-full max-w-3xl rounded-2xl border border-emerald-900/10 bg-white/80 p-3 shadow-sm backdrop-blur">
      <div className="flex flex-col gap-3 sm:flex-row sm:items-center">
        <div className="relative flex-1">
          <input
            value={q}
            onChange={(e) => setQ(e.target.value)}
            placeholder='Try "pumpkin patch", "vineyard with music"...'
            className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 pr-28 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
          />
          <div className="pointer-events-none absolute inset-y-0 right-3 flex items-center text-emerald-900/40 text-sm">
            Search
          </div>
        </div>

        <div className="grid grid-cols-3 gap-2 sm:w-[280px]">
          <button
            type="button"
            onClick={() => setWhen("today")}
            className={`rounded-xl px-3 py-2 text-sm font-medium border ${
              when === "today"
                ? "bg-emerald-600 text-white border-emerald-600"
                : "bg-white text-emerald-900 border-emerald-900/15 hover:bg-emerald-50"
            }`}
          >
            Today
          </button>
          <button
            type="button"
            onClick={() => setWhen("weekend")}
            className={`rounded-xl px-3 py-2 text-sm font-medium border ${
              when === "weekend"
                ? "bg-emerald-600 text-white border-emerald-600"
                : "bg-white text-emerald-900 border-emerald-900/15 hover:bg-emerald-50"
            }`}
          >
            Weekend
          </button>
          <button
            type="button"
            onClick={() => setWhen("any")}
            className={`rounded-xl px-3 py-2 text-sm font-medium border ${
              when === "any"
                ? "bg-emerald-600 text-white border-emerald-600"
                : "bg-white text-emerald-900 border-emerald-900/15 hover:bg-emerald-50"
            }`}
          >
            Anytime
          </button>
        </div>

        <button
          type="submit"
          className="inline-flex items-center justify-center rounded-xl bg-emerald-600 px-5 py-3 text-white font-medium shadow-sm hover:bg-emerald-700"
        >
          Find places
        </button>
      </div>

      {/* quick chips */}
      <div className="mt-3 flex flex-wrap items-center gap-2 text-sm">
        {["U-pick apples", "Farm-stay", "Hayrides", "Wine tasting"].map((t) => (
          <button
            key={t}
            type="button"
            onClick={() => setQ(t)}
            className="rounded-full border border-emerald-900/15 bg-white px-3 py-1.5 text-emerald-900/80 hover:bg-emerald-50"
          >
            {t}
          </button>
        ))}
        <span className="text-emerald-900/40">Â·</span>
        <button
          type="button"
          onClick={() => setQ((s) => (s ? `${s} near me` : "near me"))}
          className="rounded-full border border-emerald-900/15 bg-white px-3 py-1.5 text-emerald-900/80 hover:bg-emerald-50"
        >
          Use my location
        </button>
      </div>
    </form>
  );
}

```

## File: app/components/auth/ui.tsx

- Extension: .tsx
- Language: typescript
- Size: 3362 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-04 11:29:53

### Code

```typescript
"use client";
import React from "react";
import Link from "next/link";

// Drop this at: components/auth/ui.tsx
// Then import in pages like: import { BgDecor, BrandAside, Alert, Spinner, ValueRow } from "../../components/auth/ui";
// If you use a route group like app/(auth)/register/page.tsx, use: import from "../../../components/auth/ui";

export function BgDecor() {
  return (
    <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
      <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
      <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
      <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
    </div>
  );
}

export function BrandAside() {
  return (
    <aside className="hidden lg:flex flex-col justify-between p-10">
      <header className="flex items-center gap-3">
        <div className="h-10 w-10 rounded-2xl bg-emerald-600 flex items-center justify-center text-white font-semibold shadow-md">AG</div>
        <div>
          <p className="text-lg font-semibold text-emerald-900">Agritourism Directory</p>
          <p className="text-sm text-emerald-800/70">Find farms, orchards, vineyards & stays</p>
        </div>
      </header>
      <section className="space-y-6">
        <ValueRow title="Search what you love" desc="Pumpkin patches, wine tastings, farm-stays, u-pick." />
        <ValueRow title="Filter by season & amenities" desc="Open today, kidâ€‘friendly, petâ€‘friendly, accessible." />
        <ValueRow title="Plan your route" desc="Pin places on the map and build a weekend trail." />
        <ValueRow title="For owners & editors" desc="Claim listings, post events, and keep info fresh." />
      </section>
      <footer className="text-sm text-emerald-900/70 flex gap-4">
        <Link href="/about" className="hover:underline">About</Link>
        <Link href="/privacy" className="hover:underline">Privacy</Link>
        <Link href="/terms" className="hover:underline">Terms</Link>
      </footer>
    </aside>
  );
}

export function ValueRow({ title, desc }: { title: string; desc: string }) {
  return (
    <div className="flex items-start gap-3">
      <span className="mt-1 inline-flex h-2.5 w-2.5 shrink-0 rounded-full bg-emerald-600" />
      <div>
        <p className="font-medium text-emerald-950">{title}</p>
        <p className="text-sm text-emerald-900/70">{desc}</p>
      </div>
    </div>
  );
}

export function Alert({ type, message }: { type: "success" | "error"; message: string }) {
  const base = "rounded-xl px-4 py-3 mb-4 text-sm border";
  const t = type === "success" ? "bg-emerald-50 border-emerald-200 text-emerald-900" : "bg-rose-50 border-rose-200 text-rose-950";
  return <div role="status" className={`${base} ${t}`}>{message}</div>;
}

export function Spinner({ label }: { label?: string }) {
  return (
    <span className="inline-flex items-center gap-2">
      <svg className="h-4 w-4 animate-spin" viewBox="0 0 24 24" aria-hidden>
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z" />
      </svg>
      {label && <span>{label}</span>}
    </span>
  );
}

```

## File: app/components/site/nav.tsx

- Extension: .tsx
- Language: typescript
- Size: 1656 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-05 17:22:05

### Code

```typescript
// app/components/site/nav.tsx
import React from "react";
import Link from "next/link";
import Logo from "./logo";

export default function SiteNav() {
  return (
    <header className="relative z-10">
      <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <nav className="flex h-16 items-center justify-between rounded-2xl border border-emerald-900/10 bg-white/70 backdrop-blur px-4 shadow-sm">
          <Link href="/" aria-label="Home" className="shrink-0">
            <Logo />
          </Link>

          <div className="hidden sm:flex items-center gap-6 text-sm">
            <Link href="/explore" className="text-emerald-900/80 hover:text-emerald-900">Explore</Link>
            <Link href="/owner" className="text-emerald-900/80 hover:text-emerald-900">For Owners</Link>
            <Link href="/about" className="text-emerald-900/80 hover:text-emerald-900">About</Link>
            <Link href="/admin" className="text-emerald-900/80 hover:text-emerald-900">Admin</Link>
          </div>

          <div className="flex items-center gap-2">
            <Link
              href="/login"
              className="hidden sm:inline-flex rounded-xl border border-emerald-900/15 bg-white px-4 py-2 text-sm font-medium text-emerald-900 shadow-sm hover:bg-emerald-50"
            >
              Sign in
            </Link>
            <Link
              href="/register"
              className="inline-flex rounded-xl bg-emerald-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-emerald-700"
            >
              Create account
            </Link>
          </div>
        </nav>
      </div>
    </header>
  );
}

```

## File: app/components/site/footer.tsx

- Extension: .tsx
- Language: typescript
- Size: 1909 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-17 14:15:58

### Code

```typescript
"use client";

import React from "react";
import Link from "next/link";

const Container = ({
  children,
  className = "",
}: {
  children: React.ReactNode;
  className?: string;
}) => (
  <div className={`mx-auto w-full max-w-[1200px] px-4 sm:px-6 lg:px-8 ${className}`}>
    {children}
  </div>
);

export default function SiteFooter() {
  return (
    <footer className="bg-[#6b4f3a] text-[#F9F6F2]">
      <Container className="py-8 space-y-4 text-sm relative">
        {/* keep anchor so /#data still works */}
        <span id="data" className="absolute -top-16 h-0 w-0" aria-hidden />

        <p className="text-center leading-relaxed">
          This website was developed through a Cooperative Agreement with Michigan State University
          and USDA&apos;s Agricultural Marketing Service.
        </p>

        <nav
          aria-label="Footer"
          className="flex flex-wrap items-center justify-center gap-x-6 gap-y-2 text-[13px]"
        >
          <Link href="/definitions" className="hover:underline underline-offset-2">
            Definitions
          </Link>
          <Link href="/privacy" className="hover:underline underline-offset-2">
            Privacy Policy
          </Link>
          <Link href="/terms" className="hover:underline underline-offset-2">
            Terms of Use and Service
          </Link>
          <Link href="/accessibility" className="hover:underline underline-offset-2">
            Accessibility Statement
          </Link>
        </nav>

        <div className="text-center text-xs leading-relaxed text-[#F3EDE7]">
          <p>
            OMB Number for Agritourism Directory: 0581-0332_Expiration Date: 01/31/2025
          </p>
          <p>
            OMB Number for CSA, Farmers Market, Food Hub and On-farm Market:
            0581-0169_Expiration Date: 01/31/2023
          </p>
        </div>
      </Container>
    </footer>
  );
}

```

## File: app/components/site/logo.tsx

- Extension: .tsx
- Language: typescript
- Size: 611 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-05 17:21:54

### Code

```typescript
// app/components/site/logo.tsx
import React from "react";

export default function Logo({ withText = false }: { withText?: boolean }) {
  return (
    <div className="flex items-center gap-3">
      <div className="h-10 w-10 rounded-2xl bg-emerald-600 flex items-center justify-center text-white font-semibold shadow-md">
        AG
      </div>
      {withText && (
        <div>
          <p className="text-lg font-semibold text-emerald-900">Agritourism Directory</p>
          <p className="text-xs text-emerald-800/70">Find farms, orchards, vineyards & stays</p>
        </div>
      )}
    </div>
  );
}

```

## File: app/components/site/header.tsx

- Extension: .tsx
- Language: typescript
- Size: 3674 bytes
- Created: 2025-11-26 09:40:59
- Modified: 2025-11-26 09:40:59

### Code

```typescript
// app/components/site/header.tsx
"use client";

import Link from "next/link";
import React from "react";
import { useSession, signOut } from "next-auth/react";

const Container = ({ children, className = "" }: { children: React.ReactNode; className?: string }) => (
  <div className={`mx-auto w-full max-w-[1200px] px-4 sm:px-6 lg:px-8 ${className}`}>{children}</div>
);

export default function SiteHeader() {
  const { data } = useSession();
  const user: any = data?.user;
  const isStaff = user && (user.role === "ADMIN" || user.role === "EDITOR");

  return (
    <header className="sticky top-0 z-40 w-full border-b border-slate-200 bg-white/90 backdrop-blur">
      <Container className="flex h-14 items-center justify-between">
        {/* Brand */}
        <Link href="/" className="group flex items-center gap-2">
          <div className="flex items-center gap-2">
            <div className="h-8 w-8 rounded bg-green-700 flex items-center justify-center text-white font-bold text-xs">
              LC
            </div>
            <span className="text-sm font-bold tracking-tight text-slate-900">
              LandCover<span className="text-green-700">AI</span>
            </span>
          </div>
        </Link>

        {/* Right side: Nav & Auth */}
        <div className="flex items-center gap-4">
          {/* Primary Nav */}
          <nav className="flex items-center gap-4 text-sm font-medium">
            <Link 
              href="/select-project" 
              className="text-slate-600 hover:text-green-700 transition"
            >
              Analysis
            </Link>

            {isStaff && (
              <div className="relative group">
                <button className="flex items-center gap-1 text-slate-600 hover:text-green-700 transition">
                  Admin <span aria-hidden className="text-xs">â–¾</span>
                </button>
                <div className="invisible absolute right-0 mt-2 w-40 rounded-lg border border-slate-200 bg-white p-1 text-xs shadow-lg group-hover:visible origin-top-right transition-all">
                  <Link href="/admin/users" className="block rounded-md px-3 py-2 text-slate-700 hover:bg-slate-50">Users</Link>
                  <Link href="/admin/listings" className="block rounded-md px-3 py-2 text-slate-700 hover:bg-slate-50">Listings</Link>
                  <Link href="/admin/submissions" className="block rounded-md px-3 py-2 text-slate-700 hover:bg-slate-50">Submissions</Link>
                </div>
              </div>
            )}
          </nav>

          <div className="h-4 w-px bg-slate-200" aria-hidden />

          {/* Auth Buttons */}
          <div className="flex items-center gap-2">
            {!user ? (
              <Link
                href="/login"
                className="rounded-lg bg-green-700 px-4 py-2 text-xs font-semibold text-white shadow-sm transition hover:bg-green-800"
              >
                Login
              </Link>
            ) : (
              <>
                <Link 
                  href="/dashboard" 
                  className="hidden sm:block text-xs font-medium text-slate-600 hover:text-green-700"
                >
                  Dashboard
                </Link>
                <button
                  onClick={() => signOut({ callbackUrl: "/login" })}
                  className="rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50"
                >
                  Sign out
                </button>
              </>
            )}
          </div>
        </div>
      </Container>
    </header>
  );
}
```

## File: app/register/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 9894 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:42:40

### Code

```typescript
// =============================================================
// app/register/page.tsx
// =============================================================
"use client";
import React, { Suspense, useMemo, useState } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { BgDecor, BrandAside, Alert, Spinner } from "../components/auth/ui";

function RegisterForm() {
  const router = useRouter();
  const params = useSearchParams();
  const callbackUrl = useMemo(() => params.get("callbackUrl") ?? "/dashboard", [params]);

  // ---- NEW: invite/as-owner flags + invited info ----
  const invite = params.get("invite") || null;
  const asOwner = params.get("as") === "owner";
  const [invitedEmail, setInvitedEmail] = useState<string | null>(null);
  const [invitedRole, setInvitedRole] = useState<string | null>(null);

  const [name, setName] = useState("");
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [password2, setPassword2] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [agree, setAgree] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [err, setErr] = useState<string | null>(null);

  // ---- NEW: inspect invite token on mount ----
  React.useEffect(() => {
    let ignore = false;
    (async () => {
      if (!invite) return;
      const r = await fetch(`/api/invite/inspect?token=${encodeURIComponent(invite)}`, { cache: "no-store" });
      const d = await r.json().catch(() => ({}));
      if (!ignore) {
        if (d?.valid) {
          setInvitedEmail(d.email);
          setEmail(d.email);
          setInvitedRole(d.role);
        } else {
          setErr("Invite link is invalid or expired.");
        }
      }
    })();
    return () => {
      ignore = true;
    };
  }, [invite]);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (submitting) return;
    setMsg(null);
    setErr(null);

    if (!agree) return setErr("Please accept the Terms to continue.");
    if (password !== password2) return setErr("Passwords do not match.");
    if (password.length < 8) return setErr("Password must be at least 8 characters.");

    setSubmitting(true);
    try {
      // ---- NEW: send invite/as flag to API ----
      const body: any = { name, email, password };
      if (invite) body.invite = invite;
      else if (asOwner) body.as = "owner";

      const res = await fetch("/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || "Could not create your account.");

      setMsg("Account created. Check your email to verify before signing in.");
    } catch (e: any) {
      setErr(e?.message || "Something went wrong. Please try again.");
    } finally {
      setSubmitting(false);
    }
  }

  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />

      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <span className="inline-flex items-center gap-2 rounded-full border border-emerald-600/20 bg-emerald-600/5 px-3 py-1 text-xs font-medium text-emerald-800">
              <span className="h-1.5 w-1.5 rounded-full bg-emerald-600" />
              Create your account
            </span>
            <h1 className="mt-4 text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Join the Agritourism Directory</h1>
            <p className="mt-2 text-sm text-emerald-900/70">Owners & editors manage listings. Visitors can browse without an account.</p>
          </div>

          {msg && <Alert type="success" message={msg} />}
          {err && <Alert type="error" message={err} />}

          <form onSubmit={onSubmit} className="rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm backdrop-blur p-6 sm:p-8 space-y-5">
            <div className="space-y-1.5">
              <label htmlFor="name" className="block text-sm font-medium text-emerald-950">Name (optional)</label>
              <input
                id="name"
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                placeholder="Jane Farmer"
              />
            </div>

            <div className="space-y-1.5">
              <label htmlFor="email" className="block text-sm font-medium text-emerald-950">Email</label>
              <input
                id="email"
                type="email"
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                disabled={!!invitedEmail}
                className={`w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring ${invitedEmail ? "opacity-70 cursor-not-allowed" : ""}`}
                placeholder="you@example.com"
                autoComplete="email"
              />
              {invitedRole && (
                <p className="text-xs text-emerald-900/60 mt-1">
                  Invited as <span className="font-medium">{invitedRole}</span>.
                </p>
              )}
            </div>

            <div className="space-y-1.5">
              <label htmlFor="password" className="block text-sm font-medium text-emerald-950">Password</label>
              <div className="relative">
                <input
                  id="password"
                  type={showPassword ? "text" : "password"}
                  required
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="peer w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring pr-12"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  autoComplete="new-password"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword((s) => !s)}
                  className="absolute inset-y-0 right-2 my-auto h-9 rounded-lg px-3 text-sm text-emerald-950/70 hover:bg-emerald-50"
                >
                  {showPassword ? "Hide" : "Show"}
                </button>
              </div>
              <p className="text-xs text-emerald-900/60">Use at least 8 characters. Consider a mix of letters, numbers, and symbols.</p>
            </div>

            <div className="space-y-1.5">
              <label htmlFor="password2" className="block text-sm font-medium text-emerald-950">Confirm password</label>
              <input
                id="password2"
                type={showPassword ? "text" : "password"}
                required
                value={password2}
                onChange={(e) => setPassword2(e.target.value)}
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                autoComplete="new-password"
              />
            </div>

            <label className="flex items-start gap-3 text-sm">
              <input
                type="checkbox"
                checked={agree}
                onChange={(e) => setAgree(e.target.checked)}
                className="mt-0.5 h-4 w-4 rounded border-emerald-900/20 text-emerald-600 focus:ring-emerald-600"
              />
              <span className="text-emerald-900/80">
                I agree to the <Link href="/terms" className="text-emerald-800 underline">Terms</Link> and <Link href="/privacy" className="text-emerald-800 underline">Privacy Policy</Link>.
              </span>
            </label>

            <button
              type="submit"
              disabled={submitting}
              className="group inline-flex w-full items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 py-3 text-white font-medium shadow-sm transition hover:bg-emerald-700 disabled:opacity-60"
            >
              {submitting ? <Spinner label="Creating account" /> : <span>Create account</span>}
            </button>

            <p className="text-center text-sm text-emerald-900/70">
              Already have an account? <Link href="/login" className="text-emerald-800 hover:underline">Sign in</Link>
            </p>
          </form>
        </div>
      </section>
    </main>
  );
}

function RegisterFallback() {
  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />
      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <h1 className="text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Loading...</h1>
          </div>
        </div>
      </section>
    </main>
  );
}

export default function RegisterPage() {
  return (
    <Suspense fallback={<RegisterFallback />}>
      <RegisterForm />
    </Suspense>
  );
}
```

## File: app/profile/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 7477 bytes
- Created: 2025-11-12 16:34:02
- Modified: 2025-11-12 16:34:02

### Code

```typescript
// app/profile/page.tsx
"use client";
import React, { useState, useEffect } from "react";
import { Alert, Spinner } from "../components/auth/ui"; // Assuming ui components are here

type UserProfile = {
  name: string;
  email: string;
  institution: string;
  personalLink: string;
  bio: string;
  role: string;
  status: string;
};

export default function ProfilePage() {
  const [user, setUser] = useState<UserProfile | null>(null);
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  
  const [name, setName] = useState("");
  const [institution, setInstitution] = useState("");
  const [personalLink, setPersonalLink] = useState("");
  const [bio, setBio] = useState("");

  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);

  // Fetch profile data on load
  useEffect(() => {
    async function fetchProfile() {
      setLoading(true);
      setError(null);
      try {
        const res = await fetch("/api/profile");
        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || "Failed to fetch profile");
        }
        const { user } = await res.json();
        setUser(user);
        // Populate form fields
        setName(user.name || "");
        setInstitution(user.institution || "");
        setPersonalLink(user.personalLink || "");
        setBio(user.bio || "");
      } catch (err: any) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    }
    fetchProfile();
  }, []);

  // Handle profile update
  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setSubmitting(true);
    setError(null);
    setSuccess(null);
    
    try {
      const res = await fetch("/api/profile", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, institution, personalLink, bio }),
      });
      
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || "Failed to update profile");
      }
      
      setUser(data.user); 
      setSuccess("Profile updated successfully!");
    } catch (err: any) {
      setError(err.message);
    } finally {
      setSubmitting(false);
    }
  }

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>
      
      <section className="mx-auto max-w-2xl p-6 sm:p-10">
        <header className="mb-6">
          <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">
            My Profile
          </h1>
          <p className="text-sm text-emerald-900/70">
            Update your personal information.
          </p>
        </header>

        {loading && (
          <div className="text-center p-10">
            <Spinner label="Loading profile..." />
          </div>
        )}

        {error && <Alert type="error" message={error} />}
        {success && <Alert type="success" message={success} />}

        {!loading && user && (
          <form
            onSubmit={handleSubmit}
            className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 shadow-sm space-y-5"
          >
            <div className="space-y-1.5">
              <label htmlFor="email" className="block text-sm font-medium text-emerald-950">
                Email
              </label>
              <input
                id="email"
                type="email"
                disabled
                value={user.email}
                className="w-full rounded-xl border border-emerald-900/15 bg-slate-100 px-4 py-3 text-emerald-950 shadow-inner outline-none opacity-70"
              />
              <p className="text-xs text-emerald-900/60">
                Email address cannot be changed.
              </p>
            </div>

            <div className="space-y-1.5">
              <label htmlFor="name" className="block text-sm font-medium text-emerald-950">
                Name
              </label>
              <input
                id="name"
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                placeholder="John Doe"
              />
            </div>

            <div className="space-y-1.5">
              <label htmlFor="institution" className="block text-sm font-medium text-emerald-950">
                Institution or Farm
              </label>
              <input
                id="institution"
                type="text"
                value={institution}
                onChange={(e) => setInstitution(e.target.value)}
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                placeholder="e.g., MSU Extension, Local Farm Co-op"
              />
            </div>
            
            <div className="space-y-1.5">
              <label htmlFor="personalLink" className="block text-sm font-medium text-emerald-950">
                Personal Link
              </label>
              <input
                id="personalLink"
                type="url"
                value={personalLink}
                onChange={(e) => setPersonalLink(e.target.value)}
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                placeholder="https://my-farm.com"
              />
            </div>

            <div className="space-y-1.5">
              <label htmlFor="bio" className="block text-sm font-medium text-emerald-950">
                Bio
              </label>
              <textarea
                id="bio"
                rows={4}
                value={bio}
                onChange={(e) => setBio(e.target.value)}
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                placeholder="A short description of yourself or your work..."
              />
            </div>

            <div className="flex gap-3 pt-2">
              <button
                type="submit"
                disabled={submitting}
                className="flex-1 rounded-xl bg-emerald-600 text-white px-4 py-3 font-medium shadow-sm hover:bg-emerald-700 disabled:opacity-60"
              >
                {submitting ? <Spinner label="Saving..." /> : "Save Changes"}
              </button>
            </div>
          </form>
        )}
      </section>
    </main>
  );
}
```

## File: app/select-project/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 11391 bytes
- Created: 2025-11-21 12:15:58
- Modified: 2025-11-21 12:15:58

### Code

```typescript
"use client";

import React, { useEffect, useMemo, useRef, useState } from "react";
import { useRouter } from "next/navigation";
import { MapPin, Search, ChevronRight, Loader, AlertCircle } from "lucide-react";

type Row = Record<string, string>;

function parseCSVorTSV(text: string): Row[] {
  const first = text.split(/\r?\n/, 1)[0] ?? "";
  const delim = first.includes("\t") ? "\t" : ",";
  const lines = text.split(/\r?\n/).filter((l) => l.trim().length);
  if (!lines.length) return [];
  const headers = lines[0].split(delim).map((h) => h.trim());
  return lines.slice(1).map((line) => {
    const cells = line.split(delim);
    const obj: Row = {};
    headers.forEach((h, i) => (obj[h] = (cells[i] ?? "").trim()));
    return obj;
  });
}

export default function SelectProjectForAnalysisPage() {
  const router = useRouter();
  const [rows, setRows] = useState<Row[]>([]);
  const [q, setQ] = useState("");
  const [open, setOpen] = useState(false);
  const [sel, setSel] = useState<Row | null>(null);
  const [hi, setHi] = useState(0);
  const listRef = useRef<HTMLUListElement>(null);
  const [err, setErr] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);

  // load /public/data/projects.csv
  useEffect(() => {
    let alive = true;
    (async () => {
      try {
        setLoading(true);
        const res = await fetch("/data/projects.csv", { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const txt = await res.text();
        if (!alive) return;
        setRows(parseCSVorTSV(txt));
        setErr(null);
      } catch (e: any) {
        setErr(e?.message ?? "Failed to load projects.csv");
      } finally {
        if (alive) setLoading(false);
      }
    })();
    return () => {
      alive = false;
    };
  }, []);

  // Columns - using ombilSiteId as primary identifier
  const idKey = "ombilSiteId";
  const nameKey = useMemo(() => {
    const sample = rows[0] ?? {};
    return (
      (("projectName" in sample) && "projectName") ||
      (("featureName" in sample) && "featureName") ||
      (("foundationalName" in sample) && "foundationalName") ||
      Object.keys(sample).find((k) => /name/i.test(k)) ||
      Object.keys(sample).find((k) => !/id|code|uid|objectid/i.test(k)) ||
      "projectName"
    );
  }, [rows]);

  const filtered = useMemo(() => {
    const s = q.trim().toLowerCase();
    if (!s) return rows.slice(0, 50);
    return rows
      .filter(
        (r) =>
          String(r[nameKey] ?? "").toLowerCase().includes(s) ||
          String(r[idKey] ?? "").toLowerCase().includes(s)
      )
      .slice(0, 50);
  }, [rows, q, nameKey, idKey]);

  const apply = (r: Row) => {
    setSel(r);
    setQ(r[nameKey] || r[idKey] || "");
    setOpen(false);
  };

  const onKeyDown: React.KeyboardEventHandler<HTMLInputElement> = (e) => {
    if (!open && (e.key === "ArrowDown" || e.key === "ArrowUp")) {
      setOpen(true);
      return;
    }
    if (!open) return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      setHi((h) => Math.min(h + 1, filtered.length - 1));
      listRef.current?.children[Math.min(hi + 1, filtered.length - 1)]?.scrollIntoView({ block: "nearest" });
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      setHi((h) => Math.max(h - 1, 0));
      listRef.current?.children[Math.max(hi - 1, 0)]?.scrollIntoView({ block: "nearest" });
    } else if (e.key === "Enter") {
      e.preventDefault();
      const pick = filtered[hi];
      if (pick) apply(pick);
    } else if (e.key === "Escape") {
      setOpen(false);
    }
  };

  const goNext = () => {
    const ombilSiteId = String(sel?.[idKey] ?? "").trim();
    if (!ombilSiteId) {
      alert("Please select a project with a valid ombilSiteId.");
      return;
    }
    // Navigate to analysis page with the ombilSiteId as a query parameter
    router.push(`/analysis?ombilSiteId=${encodeURIComponent(ombilSiteId)}`);
  };

  return (
    <main className="min-h-screen bg-white relative">
      {/* Background decoration */}
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <div className="min-h-screen flex items-center justify-center p-6">
        <div className="w-full max-w-xl space-y-6 bg-white border border-emerald-100 rounded-2xl shadow-lg p-8">
          {/* Header */}
          <div className="flex items-center gap-3 mb-2">
            <div className="h-12 w-12 rounded-2xl bg-emerald-600 flex items-center justify-center text-white shadow-md">
              <MapPin className="w-6 h-6" />
            </div>
            <div>
              <h1 className="text-2xl font-semibold text-emerald-950">
                Land Cover Change Analysis
              </h1>
              <p className="text-sm text-emerald-900/70">
                Select a project to analyze
              </p>
            </div>
          </div>

          {/* Instructions */}
          <div className="rounded-xl border border-emerald-200 bg-emerald-50/50 p-4">
            <h2 className="font-medium text-emerald-900 mb-2 flex items-center gap-2">
              <Search className="w-4 h-4" />
              Step 1: Select Your Project
            </h2>
            <p className="text-sm text-emerald-800">
              Search for your project by name or <code className="px-1.5 py-0.5 rounded bg-white text-emerald-700 text-xs">ombilSiteId</code>.
              The corresponding land cover data will be loaded on the map.
            </p>
          </div>

          {/* Search Input */}
          <div className="space-y-2">
            <label className="block text-sm font-medium text-emerald-900">
              Search Projects
            </label>
            <div className="relative">
              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                {loading ? (
                  <Loader className="h-5 w-5 text-emerald-400 animate-spin" />
                ) : (
                  <Search className="h-5 w-5 text-emerald-400" />
                )}
              </div>
              <input
                className="w-full border-2 border-emerald-300 rounded-xl pl-10 pr-4 py-3 outline-none focus:ring-2 focus:ring-emerald-400 focus:border-emerald-400 transition"
                placeholder={loading ? "Loading projects..." : "Type to search by name or ID..."}
                value={q}
                onChange={(e) => {
                  setQ(e.target.value);
                  setSel(null);
                  setOpen(true);
                  setHi(0);
                }}
                onFocus={() => setOpen(true)}
                onBlur={() => setTimeout(() => setOpen(false), 200)}
                onKeyDown={onKeyDown}
                aria-autocomplete="list"
                aria-expanded={open}
                role="combobox"
                disabled={loading}
              />

              {open && !loading && (
                <ul
                  ref={listRef}
                  className="absolute z-10 mt-1 max-h-64 w-full overflow-auto rounded-xl border border-emerald-200 bg-white shadow-lg"
                  role="listbox"
                >
                  {filtered.length === 0 && (
                    <li className="px-4 py-3 text-sm text-gray-500 flex items-center gap-2">
                      <AlertCircle className="w-4 h-4" />
                      No matches found
                    </li>
                  )}
                  {filtered.map((r, i) => {
                    const active = i === hi;
                    return (
                      <li
                        key={`${r[idKey]}-${i}`}
                        className={`px-4 py-3 cursor-pointer transition ${
                          active ? "bg-emerald-50" : "hover:bg-emerald-50/50"
                        }`}
                        onMouseEnter={() => setHi(i)}
                        onMouseDown={(e) => {
                          e.preventDefault();
                          apply(r);
                        }}
                        role="option"
                        aria-selected={active}
                      >
                        <div className="font-medium text-emerald-900">
                          {r[nameKey] || "(unnamed)"}
                        </div>
                        <div className="text-xs text-emerald-600 mt-0.5">
                          ID: <span className="font-mono font-medium">{r[idKey] || "â€”"}</span>
                        </div>
                      </li>
                    );
                  })}
                </ul>
              )}
            </div>
          </div>

          {/* Error Message */}
          {err && (
            <div className="rounded-xl bg-rose-50 border border-rose-200 p-4 flex items-start gap-3">
              <AlertCircle className="w-5 h-5 text-rose-600 flex-shrink-0 mt-0.5" />
              <div>
                <p className="text-sm font-medium text-rose-900">Error loading projects</p>
                <p className="text-sm text-rose-700 mt-1">{err}</p>
              </div>
            </div>
          )}

          {/* Selected Project Display */}
          {sel && (
            <div className="rounded-xl bg-emerald-50 border border-emerald-200 p-4">
              <div className="flex items-start justify-between">
                <div>
                  <p className="text-sm font-medium text-emerald-900">Selected Project:</p>
                  <p className="text-lg font-semibold text-emerald-950 mt-1">
                    {sel[nameKey] || "(unnamed)"}
                  </p>
                  <p className="text-sm text-emerald-700 mt-1 font-mono">
                    ID: {sel[idKey]}
                  </p>
                </div>
                <div className="h-10 w-10 rounded-xl bg-emerald-600 flex items-center justify-center">
                  <MapPin className="w-5 h-5 text-white" />
                </div>
              </div>
              <div className="mt-3 pt-3 border-t border-emerald-200">
                <p className="text-xs text-emerald-700">
                  TIF overlay: <code className="px-1.5 py-0.5 rounded bg-white">/tif_data/{sel[idKey]}_2024.tif</code>
                </p>
              </div>
            </div>
          )}

          {/* Next Button */}
          <button
            className="w-full flex items-center justify-center gap-2 rounded-xl px-6 py-3 bg-emerald-600 text-white font-semibold shadow-lg hover:bg-emerald-700 hover:shadow-xl transition disabled:opacity-50 disabled:cursor-not-allowed"
            onClick={goNext}
            disabled={!sel}
          >
            Continue to Analysis
            <ChevronRight className="w-5 h-5" />
          </button>

          {/* Help Text */}
          <p className="text-xs text-emerald-600 text-center">
            After selecting a project, you'll be able to draw a polygon on the map
            and run land cover change analysis between two years.
          </p>
        </div>
      </div>
    </main>
  );
}
```

## File: app/prompts/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 28660 bytes
- Created: 2025-12-03 10:44:45
- Modified: 2025-12-03 10:44:45

### Code

```typescript
"use client";

import React, { useMemo, useState } from "react";
import { Clipboard, ClipboardCheck, Search } from "lucide-react";

const Container = ({
  children,
  className = "",
}: {
  children: React.ReactNode;
  className?: string;
}) => (
  <div className={`mx-auto w-full max-w-[1200px] px-4 sm:px-6 lg:px-8 ${className}`}>
    {children}
  </div>
);

type PromptItem = {
  id: string;
  title: string;
  body: string;
  note?: string;
};

type PromptGroup = {
  id: string;
  title: string;
  category: "System" | "Workflow" | "Maps" | "Vegetation / Shoreline";
  description?: string;
  badge?: string;
  items: PromptItem[];
};

const PROMPT_GROUPS: PromptGroup[] = [
  {
    id: "system-full",
    title: "System Instruction Â· Full Workflow (Tasks 1â€“5)",
    category: "System",
    badge: "Core System Prompt",
    description:
      "Primary system instruction for Gemini / Google AI Studio covering Tasks 1â€“5 (land-use change, FRAGSTATS, maps, audience tailoring, vegetation).",
    items: [
      {
        id: "system-full-body",
        title: "Full Tasks 1â€“5 System Instruction",
        body: `You are an expert in land-use change interpretation from Year 1 (e.g., 2010) to Year 2 (e.g., 2024). You must analyze land-use transitions using only the provided data, including the transition matrix and Fragstats metrics. You will be also provided with maps to help you interpret the changes spatially.

Your task is to:

Task 1. Summarize Land-Use Change Using the Four CSV Files

Summarize land-use change patterns for the reclassified classes:
1 = Water, 2 = Developed, 3 = Forest, 4 = Shrub, 5 = Herbaceous, 6 = Nonvascular, 7 = Sparse Vegetation.

Use the following inputs:

NLCD_Transition_Tables.csv
â€“ Shows how land transitions from Year 1 to Year 2 (counts and percentages).

NLCD_Normalized_Ranked.csv
â€“ Ranks transition flows between land-use classes.

NLCD_ChiSquare_Results.csv
â€“ Includes chi-square values, observed vs. expected transitions, and statistical significance.

NLCD_Intensity_Analysis.csv
â€“ Provides gain intensity, loss intensity, and transition intensity.

Produce a concise summary of overall patterns and major transitions.

Task 2. Interpret FRAGSTATS Metrics and Integrate with Task 1 Findings

Use the FRAGSTATS outputs to describe spatial structure and configuration changes:

FRAGSTATS_ClassLevel.csv
â€“ Class-level indicators showing how each land class changed spatially.

FRAGSTATS_LandscapeLevel.csv
â€“ Landscape-level indicators reflecting overall spatial configuration.

Integrate these findings with Task 1 to produce a comprehensive summary of land-use change.

Task 3. Interpret Spatial Patterns Using the Maps with Task 1, 2 Findings

Interpret the spatial distribution of land-use transitions using the provided maps.

Describe where major transitions occur.

Reference visible features (roads, landmarks, intersections, neighborhood patterns) to pinpoint locations.

Identify areas that require attention and explain why, using only the patterns and evidence visible on the maps.

Only maps for land classes that received transitions will be provided. Each map includes a title and legend.

Task 4. Tailor Explanations for Different Audiences with Task 1, 2, 3 Findings

Be prepared to explain findings for:

- Technical experts
- Planning practitioners
- General public
- Site managers

Each explanation should match the audienceâ€™s level of technical familiarity.

Task 5. Interpret the Vegetation Structure Assessment results and interpret the transition with Task 1, 2, 3, 4 findings.

General Rules

- No hallucination. Do not infer patterns or transitions that are not supported by the data.
- Evidence-based only. All interpretations must be grounded in the provided statistics, maps, and metrics.
- Focus strictly on reclassified land-use results.
- Objective and data-driven. Do not speculate or introduce external information.

GEMINI Responses

Prompt attempt 2 [11-20-2025]: https://aistudio.google.com/prompts/1Y_az_fexZrjMz9GfIQoJEjWm8UZptSSh`,
      },
    ],
  },

  {
    id: "system-task1",
    title: "System Instruction Â· Task 1 Only",
    category: "System",
    badge: "Task 1 Focus",
    description:
      "Slimmed-down system prompt where the model is currently working only on Task 1 (land-use change summary).",
    items: [
      {
        id: "system-task1-body",
        title: "Task 1 System Instruction (CSV-only)",
        body: `You are an expert in land-use change interpretation from Year 1 (e.g., 2010) to Year 2 (e.g., 2024). You must analyze land-use transitions using only the provided data, including the transition matrix and Fragstats metrics. You will be also provided with maps to help you interpret the changes spatially.

You will have multiple tasks for this work. You currently work on Task1.

Task 1. Summarize Land-Use Change Using the Four CSV Files

Summarize land-use change patterns for the reclassified classes:
1 = Water, 2 = Developed, 3 = Forest, 4 = Shrub, 5 = Herbaceous, 6 = Nonvascular, 7 = Sparse Vegetation.

Use the following inputs:

NLCD_Transition_Tables.csv
â€“ Shows how land transitions from Year 1 to Year 2 (counts and percentages).

NLCD_Normalized_Ranked.csv
â€“ Ranks transition flows between land-use classes.

NLCD_ChiSquare_Results.csv
â€“ Includes chi-square values, observed vs. expected transitions, and statistical significance.

NLCD_Intensity_Analysis.csv
â€“ Provides gain intensity, loss intensity, and transition intensity.

Produce a concise summary of overall patterns and major transitions.

General Rules

- No hallucination. Do not infer patterns or transitions that are not supported by the data.
- Evidence-based only. All interpretations must be grounded in the provided statistics, maps, and metrics.
- Focus strictly on reclassified land-use results.
- Objective and data-driven. Do not speculate or introduce external information.

Produce a concise land use change summary of overall patterns and major transitions between different land use types. In the summary, address who are the Active Gainer, Active Loser, as well as who gain most (the primary â€œsinkâ€ for the land user transitions), who lost most.

[please also explain the statistics significance from table xxxxx]`,
      },
    ],
  },

  // -------------------- PROMPT ATTEMPT 1 --------------------
  {
    id: "attempt-1",
    title: "Prompt Attempt 1 Â· Stepwise NLCD & FRAGSTATS Workflow",
    category: "Workflow",
    badge: "Attempt 1",
    description:
      "Decomposes the workflow into sequential prompts focused on NLCD tables, ranked flows, chi-square, intensities, FRAGSTATS, and map-based spatial patterns.",
    items: [
      {
        id: "a1-p1",
        title: "Prompt 1 â€“ Land Cover Change Table",
        body: `Prompt 1: interpret this Land Cover Change Table and summary the change pattern.

Input â€“ Only NLCD transition table

Output â€“ Summary of Land-Use Change Patterns

This includes the:
(1) Overall Stability vs. Change
(2) Transitions: major and minor
(3) Summary of the changes`,
      },
      {
        id: "a1-p2",
        title: "Prompt 2 â€“ Normalized Ranked Results",
        body: `Prompt 2: attached is the rank in terms of transition. Combine this result with earlier findings discovered from [filename]. Interpret the results and summarize the pattern.

Input â€“ NLCD_Normalized_Ranked.csv

Output â€“ Combined Summary of Land-Use Change Patterns

Whatâ€™s expected in the answer:

- The Ranked Change Intensities data solidifies the conclusion that the landscape is experiencing selective urbanization. The process follows a clear path of least resistance:
  - Primary Target: Herbaceous land (High Intensity, 28.85%).
  - Secondary Target: Forest land (Moderate Intensity, 21.6%).
  - Insignificant Drivers: Natural shifts between vegetation types or water bodies are "Low" or "Very Low" intensity, confirming that human development is the sole driver of significant landscape change during this period.`,
      },
      {
        id: "a1-p3",
        title: "Prompt 3 â€“ Chi-Square Significance",
        body: `Prompt 3: â€œThis file is showing chi-squared to indicate whether the change is significant. Combining these findings with previous results, interpret the results and summarize the pattern.â€

Input â€“ NLCD_ChiSquare_Results.csv

Output â€“ Combined Summary of Land-Use Change Patterns`,
      },
      {
        id: "a1-p4",
        title: "Prompt 4 â€“ Intensity Analysis (Gain / Loss / Transition)",
        body: `Prompt 4: â€œAttached file has two tables: one is the gain and loss, one is showing the transition intensity. Also combine with earlier findings to interpret the results and summarize the pattern.â€

Input â€“ NLCD_Intensity_Analysis.csv

Output â€“ Combined Summary of Land-Use Change Patterns`,
      },
      {
        id: "a1-p5",
        title: "Prompt 5 â€“ FRAGSTATS Class-Level",
        body: `Prompt 5: â€œThis file is the FRAGSTATS results. Combine with earlier findings, interpret the results and summarize the pattern.â€

Input â€“ FRAGSTATS_ClassLevel.csv

Output â€“ Combined Summary of Land-Use Change Patterns (Final Synthesis)`,
      },
      {
        id: "a1-p6",
        title: "Prompt 6 â€“ Map: Changes into Developed",
        body: `Prompt 6:
â€œThis map shows land-use changes into Developed land, and the legend is included.
Please interpret the spatial patterns based on the map.
Describe where the major transitions occur and reference landmarks, streets, or identifiable features visible on the map to help pinpoint the locations.â€

Input â€“ A map with pixels that indicate the land use changes into development, with legend and title.

Output â€“ Interpretation of Spatial Patterns with landmarks.`,
      },
      {
        id: "a1-p7",
        title: "Prompt 7 â€“ Map: Changes into Forest",
        body: `Prompt 7:
â€œThis map shows land-use changes into forest, and the legend is included.
Please interpret the spatial patterns based on the map.
Describe where the major transitions occur and reference landmarks, streets, or identifiable features visible on the map to help pinpoint the locations.â€

Input â€“ A map with pixels that indicate the land use changes into forest, with legend and title.

Output â€“ Interpretation of Spatial Patterns with landmarks.`,
      },
      {
        id: "a1-p8",
        title: "Prompt 8 â€“ Map: Changes into Herbaceous",
        body: `Prompt 8:
â€œThis map shows land-use changes into herbaceous, and the legend is included.
Please interpret the spatial patterns based on the map.
Describe where the major transitions occur and reference landmarks, streets, or identifiable features visible on the map to help pinpoint the locations.â€

Input â€“ A map with pixels that indicate the land use changes into herbaceous, with legend and title.

Output â€“ Interpretation of Spatial Patterns with landmarks.

Note: Even if the text in the prompt is accidentally typed wrong, the results should still be based on the input image.`,
      },
    ],
  },

  // -------------------- PROMPT ATTEMPT 3 --------------------
  {
    id: "attempt-3",
    title: "Prompt Attempt 3 Â· Updated Multi-Task Workflow",
    category: "Workflow",
    badge: "Attempt 3 Â· 11-24-2025",
    description:
      "Refined version that makes gain and loss intensity files explicit, and structures Tasks 1â€“5 as separate prompts.",
    items: [
      {
        id: "a3-p1",
        title: "Prompt 1 â€“ Task 1 with Explicit Intensity Files",
        body: `Prompt 1
You are an expert in land-use change interpretation from Year 1 (e.g., 2010) to Year 2 (e.g., 2024). You must analyze land-use transitions using only the provided data, including the transition matrix and Fragstats metrics. You will be also provided with maps to help you interpret the changes spatially.

You will have multiple tasks for this work. You currently work on Task 1.

Task 1. Summarize Land-Use Change Using the CSV Files

Summarize land-use change patterns for the reclassified classes:

1 = Water, 2 = Developed, 3 = Forest, 4 = Shrub, 5 = Herbaceous, 6 = Nonvascular, 7 = Sparse Vegetation.

Use the following inputs:

NLCD_Transition_Tables.csv
â€“ Shows how land transitions from Year 1 to Year 2 (counts and percentages).

NLCD_Normalized_Ranked.csv
â€“ Ranks transition flows between land-use classes.

NLCD_ChiSquare_Results.csv
â€“ Includes chi-square values, observed vs. expected transitions, and statistical significance.

NLCD_Intensity_Analysis.csv
â€“ transition intensity.

NLCD_Intensity_Analysis_Gain_Reclass.csv and NLCD_Intensity_Analysis_Loss_Reclass.csv
â€“ provide gain intensity and loss intensity, respectively.

Produce a concise summary of overall patterns and major transitions.

General Rules

- No hallucination. Do not infer patterns or transitions that are not supported by the data.
- Evidence-based only. All interpretations must be grounded in the provided statistics, maps, and metrics.
- Focus strictly on reclassified land-use results.
- Objective and data-driven. Do not speculate or introduce external information.

Produce a concise land use change summary of overall patterns and major transitions between different land use types.`,
      },
      {
        id: "a3-p2",
        title: "Prompt 2 â€“ Task 2 FRAGSTATS Integration",
        body: `Prompt 2:
Now, the next step will be focus on Fragstats results.

Task 2. Interpret FRAGSTATS Metrics and Integrate with Task 1 Findings

Use the FRAGSTATS outputs to describe spatial structure and configuration changes:

FRAGSTATS_ClassLevel.csv
â€“ Class-level indicators showing how each land class changed spatially.

FRAGSTATS_LandscapeLevel.csv
â€“ Landscape-level indicators reflecting overall spatial configuration.

Integrate these findings with Task 1 to produce a comprehensive summary of land-use change.`,
      },
      {
        id: "a3-p3",
        title: "Prompt 3 â€“ Task 3 Spatial Patterns Using Maps",
        body: `Prompt 3:
Now we moved on to Task 3.

Task 3. Interpret Spatial Patterns Using the Maps with Task 1, 2 Findings

Interpret the spatial distribution of land-use transitions using the provided maps.

Describe where major transitions occur.

Reference visible features (roads, landmarks, intersections, neighborhood patterns) to pinpoint locations.

Identify areas that require attention and explain why, using only the patterns and evidence visible on the maps.

Only maps for land classes that received transitions will be provided. Each map includes a title and legend.`,
      },
      {
        id: "a3-p4",
        title: "Prompt 4 â€“ Task 4 Audience-Specific Explanations",
        body: `Prompt 4:
Now, move on to Task 4.

Task 4. Tailor Explanations for Different Audiences with Task 1, 2, 3 Findings

Be prepared to explain findings for:

- Technical experts
- Planning practitioners
- General public
- Site managers

Each explanation should match the audienceâ€™s level of technical familiarity.`,
      },
      {
        id: "a3-p5",
        title: "Prompt 5 â€“ Vegetation Structure & Ecological Identity",
        body: `Prompt 5:
The attached summarizes vegetation-structure transitions across different categories, as well as the value or grading assigned to each transition. Using the definitions provided in the table, the grading information from the CSV file, and the earlier findings, interpret the transition results shown in the CSV file.

You must determine the ecological identity and health of the landscape by cross-referencing Quantitative Metrics (from a provided CSV summary) against a Standardized Scoring Rubric (the table). Use these definitions to evaluate the land.`,
      },
    ],
  },

  // -------------------- PROMPT ATTEMPT 2 (SECOND VERSION) --------------------
  {
    id: "attempt-2",
    title: "Prompt Attempt 2 Â· Alternate Multi-Task Workflow",
    category: "Vegetation / Shoreline",
    badge: "Attempt 2 Â· 11-20-2025",
    description:
      "Earlier alternate attempt with Tasks 1â€“4 plus a shoreline-specific recommendation prompt.",
    items: [
      {
        id: "a2-p1",
        title: "Prompt 1 â€“ Multi-Task Setup (Tasks 1â€“4)",
        body: `Prompt 1
You are an expert in land-use change interpretation from Year 1 (e.g., 2010) to Year 2 (e.g., 2024). You must analyze land-use transitions using only the provided data, including the transition matrix and Fragstats metrics. You will be also provided with maps to help you interpret the changes spatially.

You will have multiple tasks for this work. You currently work on Task1.

Task 1. Summarize Land-Use Change Using the Four CSV Files

Summarize land-use change patterns for the reclassified classes:
1 = Water, 2 = Developed, 3 = Forest, 4 = Shrub, 5 = Herbaceous, 6 = Nonvascular, 7 = Sparse Vegetation.

Use the following inputs:

NLCD_Transition_Tables.csv
â€“ Shows how land transitions from Year 1 to Year 2 (counts and percentages).

NLCD_Normalized_Ranked.csv
â€“ Ranks transition flows between land-use classes.

NLCD_ChiSquare_Results.csv
â€“ Includes chi-square values, observed vs. expected transitions, and statistical significance.

NLCD_Intensity_Analysis.csv
â€“ Provides gain intensity, loss intensity, and transition intensity.

Produce a concise summary of overall patterns and major transitions.

General Rules

- No hallucination. Do not infer patterns or transitions that are not supported by the data.
- Evidence-based only. All interpretations must be grounded in the provided statistics, maps, and metrics.
- Focus strictly on reclassified land-use results.
- Objective and data-driven. Do not speculate or introduce external information.

Produce a concise land use change summary of overall patterns and major transitions between different land use types.`,
      },
      {
        id: "a2-p2",
        title: "Prompt 2 â€“ Task 2 (FRAGSTATS Integration)",
        body: `Prompt 2:
Now, the next step will be focus on Fragstats results.

Task 2. Interpret FRAGSTATS Metrics and Integrate with Task 1 Findings

Use the FRAGSTATS outputs to describe spatial structure and configuration changes:

FRAGSTATS_ClassLevel.csv
â€“ Class-level indicators showing how each land class changed spatially.

FRAGSTATS_LandscapeLevel.csv
â€“ Landscape-level indicators reflecting overall spatial configuration.

Integrate these findings with Task 1 to produce a comprehensive summary of land-use change.`,
      },
      {
        id: "a2-p3",
        title: "Prompt 3 â€“ Task 3 (Spatial Maps)",
        body: `Prompt 3:
Now we moved on to Task 3.

Task 3. Interpret Spatial Patterns Using the Maps with Task 1, 2 Findings

Interpret the spatial distribution of land-use transitions using the provided maps.

Describe where major transitions occur.

Reference visible features (roads, landmarks, intersections, neighborhood patterns) to pinpoint locations.

Identify areas that require attention and explain why, using only the patterns and evidence visible on the maps.

Only maps for land classes that received transitions will be provided. Each map includes a title and legend.`,
      },
      {
        id: "a2-p4",
        title: "Prompt 4 â€“ Task 4 (Audience-Specific Summaries)",
        body: `Prompt 4:
Now, move on to Task 4.

Task 4. Tailor Explanations for Different Audiences with Task 1, 2, 3 Findings

Be prepared to explain findings for:

- Technical experts
- Planning practitioners
- General public
- Site managers

Each explanation should match the audienceâ€™s level of technical familiarity.`,
      },
      {
        id: "a2-p5",
        title: "Prompt 5 â€“ Shoreline Management Recommendations",
        body: `Prompt 5:
Now, we are focusing on monitoring shoreline task. Write more on shoreline management suggestions / recommendations based on all the results.`,
      },
    ],
  },
];

export default function PromptLibraryPage() {
  const [query, setQuery] = useState("");
  const [copiedKey, setCopiedKey] = useState<string | null>(null);

  const filteredGroups = useMemo(() => {
    const q = query.trim().toLowerCase();
    if (!q) return PROMPT_GROUPS;
    return PROMPT_GROUPS.filter((group) => {
      if (group.title.toLowerCase().includes(q)) return true;
      if (group.description && group.description.toLowerCase().includes(q)) return true;
      return group.items.some(
        (item) =>
          item.title.toLowerCase().includes(q) ||
          item.body.toLowerCase().includes(q)
      );
    });
  }, [query]);

  function handleCopy(text: string, key: string) {
    if (typeof navigator !== "undefined" && navigator.clipboard?.writeText) {
      navigator.clipboard.writeText(text).then(
        () => {
          setCopiedKey(key);
          setTimeout(() => {
            setCopiedKey((prev) => (prev === key ? null : prev));
          }, 1500);
        },
        () => {
          setCopiedKey(key);
          setTimeout(() => setCopiedKey(null), 1500);
        }
      );
    }
  }

  function copyGroup(group: PromptGroup) {
    const combined = group.items
      .map((item) => `${item.title}\n\n${item.body}`)
      .join("\n\n\n-------------------------\n\n");
    handleCopy(combined, `group-${group.id}`);
  }

  return (
    <main className="min-h-screen bg-white relative">
      {/* Background decoration */}
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <Container className="py-8 sm:py-12 space-y-8">
        {/* Header */}
        <header className="space-y-3">
          <div className="inline-flex items-center gap-2 rounded-full border border-emerald-600/20 bg-emerald-600/5 px-3 py-1 text-xs font-medium text-emerald-800">
            <span className="h-1.5 w-1.5 rounded-full bg-emerald-600" />
            Prompt Library Â· LandCover AI
          </div>
          <h1 className="text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">
            Land-Use Change Prompt Library
          </h1>
          <p className="text-sm sm:text-base text-emerald-900/80 max-w-3xl">
            A curated collection of system instructions and task prompts used for
            land-use change analysis (NLCD transitions, FRAGSTATS, spatial
            interpretation, vegetation structure, and shoreline management).
            Click any prompt to expand and copy it directly into Google AI Studio
            or Gemini.
          </p>
        </header>

        {/* Search */}
        <section className="rounded-2xl border border-emerald-900/10 bg-white/80 p-4 shadow-sm">
          <div className="flex items-center gap-3">
            <div className="relative flex-1">
              <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-emerald-900/40" />
              <input
                type="text"
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                placeholder="Search prompts by task, keyword (e.g., â€œFragstatsâ€, â€œshorelineâ€, â€œTask 3 mapsâ€)â€¦"
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-9 py-2.5 text-sm text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
              />
            </div>
            <span className="hidden sm:inline text-xs text-emerald-900/60">
              {filteredGroups.length} groups Â·{" "}
              {filteredGroups.reduce((sum, g) => sum + g.items.length, 0)} prompts
            </span>
          </div>
        </section>

        {/* Prompt groups */}
        <section className="space-y-6">
          {filteredGroups.map((group) => (
            <article
              key={group.id}
              className="rounded-2xl border border-emerald-900/10 bg-white/80 p-5 sm:p-6 shadow-sm"
            >
              <header className="flex flex-wrap items-start justify-between gap-3 mb-4">
                <div className="space-y-1">
                  <div className="flex items-center gap-2 flex-wrap">
                    <h2 className="text-lg font-semibold text-emerald-950">
                      {group.title}
                    </h2>
                    <span className="inline-flex items-center rounded-full border border-emerald-900/15 bg-emerald-50 px-2.5 py-0.5 text-[11px] font-medium text-emerald-800">
                      {group.category}
                    </span>
                    {group.badge && (
                      <span className="inline-flex items-center rounded-full border border-amber-900/20 bg-amber-50 px-2.5 py-0.5 text-[11px] font-medium text-amber-900">
                        {group.badge}
                      </span>
                    )}
                  </div>
                  {group.description && (
                    <p className="text-xs sm:text-sm text-emerald-900/70 max-w-3xl">
                      {group.description}
                    </p>
                  )}
                </div>
                <button
                  type="button"
                  onClick={() => copyGroup(group)}
                  className="inline-flex items-center gap-1 rounded-xl border border-emerald-900/15 bg-white px-3 py-1.5 text-xs font-medium text-emerald-800 shadow-sm hover:bg-emerald-50"
                >
                  {copiedKey === `group-${group.id}` ? (
                    <>
                      <ClipboardCheck className="h-3.5 w-3.5" />
                      Copied group
                    </>
                  ) : (
                    <>
                      <Clipboard className="h-3.5 w-3.5" />
                      Copy all
                    </>
                  )}
                </button>
              </header>

              <div className="space-y-3">
                {group.items.map((item, idx) => (
                  <details
                    key={item.id}
                    className="group border border-emerald-900/10 rounded-xl bg-emerald-50/40"
                    open={idx === 0}
                  >
                    <summary className="flex cursor-pointer items-center justify-between gap-3 px-3 py-2.5 text-sm font-medium text-emerald-950">
                      <span className="flex-1">
                        {item.title}
                        {item.note && (
                          <span className="ml-2 text-[11px] font-normal text-emerald-900/60">
                            {item.note}
                          </span>
                        )}
                      </span>
                      <button
                        type="button"
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          handleCopy(item.body, item.id);
                        }}
                        className="inline-flex items-center gap-1 rounded-lg border border-emerald-900/10 bg-white px-2 py-1 text-[11px] font-medium text-emerald-800 hover:bg-emerald-50"
                      >
                        {copiedKey === item.id ? (
                          <>
                            <ClipboardCheck className="h-3 w-3" />
                            Copied
                          </>
                        ) : (
                          <>
                            <Clipboard className="h-3 w-3" />
                            Copy
                          </>
                        )}
                      </button>
                    </summary>
                    <div className="border-t border-emerald-900/10 bg-white/80 px-3 py-3 rounded-b-xl">
                      <pre className="whitespace-pre-wrap text-[12px] leading-relaxed text-slate-800 font-mono">
                        {item.body}
                      </pre>
                    </div>
                  </details>
                ))}
              </div>
            </article>
          ))}

          {filteredGroups.length === 0 && (
            <div className="rounded-2xl border border-emerald-900/10 bg-white/80 p-6 text-sm text-emerald-900/70 text-center">
              No prompts matched your search. Try a different keyword (e.g.,
              â€œFragstatsâ€, â€œChi-squareâ€, â€œshorelineâ€, â€œTask 5â€).
            </div>
          )}
        </section>
      </Container>
    </main>
  );
}

```

## File: app/api/analysis/route.ts

- Extension: .ts
- Language: typescript
- Size: 1811 bytes
- Created: 2025-11-21 11:50:38
- Modified: 2025-11-21 11:50:38

### Code

```typescript
import { NextRequest, NextResponse } from "next/server";

export const runtime = "nodejs";
export const maxDuration = 300; // 5 minutes for long analysis

// FastAPI backend URL - can be configured via environment variable
const FASTAPI_URL = process.env.FASTAPI_URL || "http://localhost:8000";

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const { geojson, year1, year2 } = body;

    if (!geojson) {
      return NextResponse.json(
        { error: "GeoJSON polygon is required" },
        { status: 400 }
      );
    }

    if (!year1 || !year2) {
      return NextResponse.json(
        { error: "Both year1 and year2 are required" },
        { status: 400 }
      );
    }

    // Forward request to FastAPI backend
    const response = await fetch(`${FASTAPI_URL}/api/analyze`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        geojson,
        year1,
        year2,
      }),
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      return NextResponse.json(
        { error: errorData.detail || `Analysis failed: ${response.statusText}` },
        { status: response.status }
      );
    }

    // Get the zip file blob from FastAPI
    const zipBlob = await response.blob();

    // Return the zip file
    return new NextResponse(zipBlob, {
      status: 200,
      headers: {
        "Content-Type": "application/zip",
        "Content-Disposition": `attachment; filename="analysis_${year1}_${year2}.zip"`,
      },
    });
  } catch (error: any) {
    console.error("Analysis API error:", error);
    return NextResponse.json(
      { error: error.message || "Internal server error" },
      { status: 500 }
    );
  }
}
```

## File: app/api/form-veget/route.ts

- Extension: .ts
- Language: typescript
- Size: 2550 bytes
- Created: 2025-11-24 14:42:14
- Modified: 2025-11-24 14:42:14

### Code

```typescript
import { NextResponse } from "next/server";
import path from "path";
import fs from "fs/promises";
import { existsSync } from "fs";

export const dynamic = "force-dynamic";

// Define where to save the files
const DATA_DIR = path.join(process.cwd(), "data", "veget-forms");

// Helper to ensure directory exists
async function ensureDir() {
  await fs.mkdir(DATA_DIR, { recursive: true });
}

export async function POST(req: Request) {
  try {
    const body = await req.json();
    
    // 1. Ensure the data folder exists
    await ensureDir();

    // 2. Save individual JSON file (Contains EVERYTHING: answers, notes, full stats)
    // Create a safe filename using SiteID and Date
    const timestamp = Date.now();
    const safeId = (body.siteId || "unknown").replace(/[^a-z0-9]/gi, "_");
    const filename = `veget_${safeId}_${timestamp}.json`;
    const filePath = path.join(DATA_DIR, filename);

    await fs.writeFile(filePath, JSON.stringify(body, null, 2), "utf8");

    // 3. Append to a Summary CSV file (Contains key stats for easy analysis)
    const csvPath = path.join(DATA_DIR, "summary_log.csv");
    
    // Define the columns we want in the CSV summary
    const headers = [
      "File Name",
      "Submission Date",
      "Site ID",
      "Observer",
      "Overall Score",
      "Overall Rating",
      "Landscape Avg",
      "Size Avg",
      "Vegetation Avg",
      "Soils Avg",
      "Hydrology Avg"
    ];

    // Check if CSV exists; if not, create it with headers
    if (!existsSync(csvPath)) {
      await fs.writeFile(csvPath, headers.join(",") + "\n", "utf8");
    }

    // Prepare the row data
    // Note: We access the specific fields sent from the frontend payload
    const row = [
      filename,
      new Date().toISOString(),
      `"${(body.siteId || "").replace(/"/g, '""')}"`,      // Escape quotes
      `"${(body.observerName || "").replace(/"/g, '""')}"`,
      body.overallScore?.toFixed(2) || "",
      `"${body.overallRating || ""}"`,
      body.landscapeAvg?.toFixed(2) || "",
      body.sizeAvg?.toFixed(2) || "",
      body.vegAvg?.toFixed(2) || "",
      body.soilAvg?.toFixed(2) || "",
      body.hydroAvg?.toFixed(2) || ""
    ];

    // Append the row to the CSV
    await fs.appendFile(csvPath, row.join(",") + "\n", "utf8");

    return NextResponse.json({ ok: true, file: filename });

  } catch (error: any) {
    console.error("Save error:", error);
    return NextResponse.json(
      { error: error.message || "Failed to save data on server" }, 
      { status: 500 }
    );
  }
}
```

## File: app/api/auth/verify/route.ts

- Extension: .ts
- Language: typescript
- Size: 874 bytes
- Created: 2025-11-10 18:21:31
- Modified: 2025-11-10 16:49:29

### Code

```typescript
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { consumeEmailVerificationToken } from "@/lib/tokens";
import { logActivity } from "@/lib/activity";

export async function GET(req: Request) {
  const { searchParams } = new URL(req.url);
  const token = searchParams.get("token");
  if (!token) return NextResponse.json({ error: "Missing token" }, { status: 400 });

  const email = await consumeEmailVerificationToken(token);
  if (!email) return NextResponse.json({ error: "Invalid or expired token" }, { status: 400 });

  const user = await prisma.user.update({ 
    where: { email }, 
    data: { 
      emailVerified: new Date(),
      status: "VERIFIED"
    } 
  });
  
  await logActivity({ userId: user.id, action: "AUTH_EMAIL_VERIFIED", details: "Status changed to VERIFIED" });

  return NextResponse.json({ ok: true });
}
```

## File: app/api/auth/reset/route.ts

- Extension: .ts
- Language: typescript
- Size: 1442 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-10 09:30:51

### Code

```typescript
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { consumePasswordResetToken } from "@/lib/tokens";
import bcrypt from "bcryptjs";
import { logActivity } from "@/lib/activity";
import { sendPasswordUpdatedEmail } from "@/lib/mail";


export async function POST(req: Request) {
  const { token, password } = await req.json().catch(() => ({}));
  if (!token || !password) return NextResponse.json({ error: "Missing token or password" }, { status: 400 });

  const email = await consumePasswordResetToken(token);
  if (!email) return NextResponse.json({ error: "Invalid or expired token" }, { status: 400 });

  const user = await prisma.user.findUnique({ where: { email } });
  if (!user || user.deletedAt) return NextResponse.json({ error: "Account not available" }, { status: 400 });

  const hash = await bcrypt.hash(password, 10);
  await prisma.user.update({ where: { id: user.id }, data: { passwordHash: hash } });
  await logActivity({ userId: user.id, action: "AUTH_PASSWORD_RESET" });


  // after updating the password hash:
  await prisma.user.update({ where: { id: user.id }, data: { passwordHash: hash } });

  // NEW (optional): let user know their password changed
  try { await sendPasswordUpdatedEmail(user.email); } catch (e) { console.error("notify reset:", e); }

  await logActivity({ userId: user.id, action: "AUTH_PASSWORD_RESET" });


  return NextResponse.json({ ok: true });
}

```

## File: app/api/auth/reset-request/route.ts

- Extension: .ts
- Language: typescript
- Size: 836 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-05 15:44:11

### Code

```typescript
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { issuePasswordResetToken } from "@/lib/tokens";
import { sendPasswordResetEmail } from "@/lib/mail";
import { logActivity } from "@/lib/activity";

export async function POST(req: Request) {
  const { email } = await req.json().catch(() => ({}));
  if (!email) return NextResponse.json({ error: "Missing email" }, { status: 400 });

  const user = await prisma.user.findUnique({ where: { email: String(email).toLowerCase().trim() } });
  if (user && !user.deletedAt) {
    const token = await issuePasswordResetToken(user.email);
    await sendPasswordResetEmail(user.email, token);
    await logActivity({ userId: user.id, action: "AUTH_RESET_REQUEST" });
  }
  // Always respond ok to avoid leakage
  return NextResponse.json({ ok: true });
}

```

## File: app/api/auth/register/route.ts

- Extension: .ts
- Language: typescript
- Size: 2151 bytes
- Created: 2025-11-10 18:21:31
- Modified: 2025-11-10 16:49:39

### Code

```typescript
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import bcrypt from "bcryptjs";
import { issueEmailVerificationToken } from "@/lib/tokens";
import { sendVerificationEmail } from "@/lib/mail";
import { logActivity } from "@/lib/activity";
import { Role } from "@prisma/client";

export async function POST(req: Request) {
  const { name, email, password, invite, as } = await req.json().catch(() => ({}));
  if (!email || !password) return NextResponse.json({ error: "Missing fields" }, { status: 400 });

  const normalized = String(email).toLowerCase().trim();
  const existing = await prisma.user.findUnique({ where: { email: normalized } });
  if (existing) return NextResponse.json({ error: "Email already in use" }, { status: 400 });

  let role: Role = "VISITOR";
  let status = "PENDING";
  
  if (invite) {
    const inv = await prisma.inviteToken.findUnique({ where: { token: String(invite) } });
    if (!inv || inv.expires < new Date() || inv.usedAt) {
      return NextResponse.json({ error: "Invite invalid or expired" }, { status: 400 });
    }
    if (inv.email !== normalized) {
      return NextResponse.json({ error: "Invite email mismatch" }, { status: 400 });
    }
    role = inv.role;
  } else if (String(as || "").toUpperCase() === "OWNER") {
    role = "OWNER";
  }

  const passwordHash = await bcrypt.hash(password, 10);
  const user = await prisma.user.create({
    data: { 
      email: normalized, 
      name: name || null, 
      passwordHash, 
      role,
      status,
    },
  });

  if (invite) {
    await prisma.inviteToken.update({
      where: { token: invite },
      data: { usedAt: new Date() },
    });
  }

  try {
    const token = await issueEmailVerificationToken(user.email);
    await sendVerificationEmail(user.email, token);
    await logActivity({ userId: user.id, action: "AUTH_REGISTER", details: `${role} - PENDING verification` });
  } catch (error) {
    console.error("Failed to send verification email:", error);
    await logActivity({ userId: user.id, action: "AUTH_REGISTER_EMAIL_FAILED", details: role });
  }

  return NextResponse.json({ ok: true });
}
```

## File: app/api/auth/[...nextauth]/route.ts

- Extension: .ts
- Language: typescript
- Size: 156 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-17 15:03:20

### Code

```typescript
import NextAuth from "next-auth";
import { authOptions } from "@/auth";

const handler = NextAuth(authOptions);
export { handler as GET, handler as POST };

```

## File: app/api/listings/route.ts

- Extension: .ts
- Language: typescript
- Size: 2077 bytes
- Created: 2025-11-10 14:33:35
- Modified: 2025-11-10 10:40:48

### Code

```typescript
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { slugify } from "@/lib/slugify";
import { logActivity } from "@/lib/activity";
import { hasRole } from "@/lib/rbac";

export async function GET(req: Request) {
Â  const session = await getServerSession(authOptions);
Â  const url = new URL(req.url);
Â  const all = url.searchParams.get("all") === "1";

Â  if (!session?.user) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

Â  if (all && hasRole((session.user as any).role, "EDITOR")) {
Â  Â  const rows = await prisma.listing.findMany({ where: { deletedAt: null }, orderBy: { createdAt: "desc" } });
Â  Â  return NextResponse.json({ listings: rows });
Â  }

Â  const rows = await prisma.listing.findMany({
Â  Â  where: { ownerId: (session.user as any).id, deletedAt: null },
Â  Â  orderBy: { createdAt: "desc" },
Â  });
Â  return NextResponse.json({ listings: rows });
}

export async function POST(req: Request) {
Â  const session = await getServerSession(authOptions);
Â  if (!session?.user?.id) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

Â  const { name, shortIntro } = await req.json().catch(() => ({}));
Â  if (!name) return NextResponse.json({ error: "Name required" }, { status: 400 });

Â  const base = slugify(name);
Â  let slug = base;
Â  let i = 1;
Â  while (await prisma.listing.findUnique({ where: { slug } })) {
Â  Â  i += 1;
Â  Â  slug = `${base}-${i}`;
Â  }

Â  const row = await prisma.listing.create({
Â  Â  data: {
Â  Â  Â  name,
Â  Â  Â  slug,
Â  Â  Â  shortIntro: shortIntro || null,
Â  Â  Â  ownerId: (session.user as any).id,
Â  Â  Â  // ðŸ‘‡ *** THIS IS THE FIX ***
Â  Â  Â  // We change "DRAFT" to "PENDING"
Â  Â  Â  status: "PENDING",
Â  Â  },
Â  });

Â  // We can log this as a submission now, not just a create
Â  await logActivity({ userId: (session.user as any).id, action: "LISTING_CREATE_AND_SUBMIT", details: row.id });
Â  return NextResponse.json({ listing: row });
}
```

## File: app/api/listings/[id]/route.ts

- Extension: .ts
- Language: typescript
- Size: 4047 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:01:48

### Code

```typescript
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { canEditListing } from "@/lib/permissions";
import { logActivity } from "@/lib/activity";

export async function GET(_req: Request, context: unknown) {
  const { params } = context as { params: { id: string } };

  const row = await prisma.listing.findUnique({ where: { id: params.id } });
  if (!row || row.deletedAt) return NextResponse.json({ error: "Not found" }, { status: 404 });
  return NextResponse.json({ listing: row });
}

export async function PATCH(req: Request, context: unknown) {
  const { params } = context as { params: { id: string } };

  const session = await getServerSession(authOptions);
  if (!session?.user?.id) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const row = await prisma.listing.findUnique({ where: { id: params.id } });
  if (!row || row.deletedAt) return NextResponse.json({ error: "Not found" }, { status: 404 });

  if (!canEditListing(session.user as any, row)) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const body = await req.json().catch(() => ({} as any));

  // action=submit sets status -> PENDING
  if (body?.action === "submit") {
    const updated = await prisma.listing.update({
      where: { id: row.id },
      data: { status: "PENDING" },
    });
    await logActivity({
      userId: (session.user as any).id,
      action: "LISTING_SUBMIT_REVIEW",
      details: row.id,
    });
    return NextResponse.json({ listing: updated });
  }

  // Admin/editor moderation
  if (
    body?.action === "moderate" &&
    ((session.user as any).role === "ADMIN" || (session.user as any).role === "EDITOR")
  ) {
    const nextStatus = String(body.status || "").toUpperCase();
    if (!["PUBLISHED", "REJECTED", "PENDING"].includes(nextStatus)) {
      return NextResponse.json({ error: "Invalid status" }, { status: 400 });
    }
    const updated = await prisma.listing.update({
      where: { id: row.id },
      data: { status: nextStatus as any },
    });
    await logActivity({
      userId: (session.user as any).id,
      action: "LISTING_MODERATE",
      details: `${row.id}:${nextStatus}`,
    });
    return NextResponse.json({ listing: updated });
  }

  // Update basics
  const updated = await prisma.listing.update({
    where: { id: row.id },
    data: {
      name: body.name ?? row.name,
      shortIntro: body.shortIntro ?? row.shortIntro,
      address1: body.address1 ?? row.address1,
      city: body.city ?? row.city,
      region: body.region ?? row.region,
      postalCode: body.postalCode ?? row.postalCode,
      country: body.country ?? row.country,
      phone: body.phone ?? row.phone,
      website: body.website ?? row.website,
      amenities: body.amenities ?? row.amenities,
      activities: body.activities ?? row.activities,
      hours: body.hours ?? row.hours,
    },
  });
  await logActivity({
    userId: (session.user as any).id,
    action: "LISTING_UPDATE",
    details: row.id,
  });
  return NextResponse.json({ listing: updated });
}

export async function DELETE(_req: Request, context: unknown) {
  const { params } = context as { params: { id: string } };

  const session = await getServerSession(authOptions);
  if (!session?.user?.id) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const row = await prisma.listing.findUnique({ where: { id: params.id } });
  if (!row || row.deletedAt) return NextResponse.json({ error: "Not found" }, { status: 404 });
  if (!canEditListing(session.user as any, row)) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const updated = await prisma.listing.update({
    where: { id: row.id },
    data: { deletedAt: new Date() },
  });
  await logActivity({
    userId: (session.user as any).id,
    action: "LISTING_DELETE",
    details: row.id,
  });
  return NextResponse.json({ ok: true, listing: updated });
}

```

## File: app/api/admin/users/route.ts

- Extension: .ts
- Language: typescript
- Size: 1796 bytes
- Created: 2025-11-12 20:17:09
- Modified: 2025-11-12 15:25:29

### Code

```typescript
// app/api/admin/users/route.ts
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { hasRole } from "@/lib/rbac";
import { issueInviteToken } from "@/lib/tokens";
import { sendInviteEmail } from "@/lib/mail";
import { logActivity } from "@/lib/activity";

export async function GET() {
  const session = await getServerSession(authOptions);
  if (!session?.user) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  if (!hasRole((session.user as any).role, "ADMIN")) return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  
  const users = await prisma.user.findMany({
    orderBy: { createdAt: "desc" },
    select: { 
      id: true, 
      email: true, 
      name: true, 
      role: true, 
      emailVerified: true, 
      deletedAt: true, 
      createdAt: true,
      status: true, // ðŸ‘ˆ *** FIX: Added status field here ***
    },
  });
  
  return NextResponse.json({ users });
}

export async function POST(req: Request) {
  const session = await getServerSession(authOptions);
  if (!session?.user) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  if (!hasRole((session.user as any).role, "ADMIN")) return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  
  const { email, role } = await req.json().catch(() => ({}));
  if (!email) return NextResponse.json({ error: "Missing email" }, { status: 400 });

  const token = await issueInviteToken(String(email).toLowerCase().trim(), role || "VISITOR");
  await sendInviteEmail(email, token);
  
  await logActivity({ userId: (session.user as any).id, action: "ADMIN_INVITE_USER", details: email });
  
  return NextResponse.json({ ok: true });
}
```

## File: app/api/admin/users/[id]/status/route.ts

- Extension: .ts
- Language: typescript
- Size: 1494 bytes
- Created: 2025-11-10 16:51:39
- Modified: 2025-11-10 16:51:39

### Code

```typescript
// app/api/admin/users/[id]/status/route.ts
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { hasRole } from "@/lib/rbac";
import { logActivity } from "@/lib/activity";

export async function PATCH(req: Request, context: unknown) {
  const { params } = context as { params: { id: string } };
  
  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  
  if (!hasRole((session.user as any).role, "ADMIN")) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  try {
    const { status } = await req.json();
    
    const validStatuses = ["PENDING", "VERIFIED", "ACTIVE", "SUSPENDED", "DELETED"];
    if (!status || !validStatuses.includes(status)) {
      return NextResponse.json({ error: "Invalid status" }, { status: 400 });
    }

    const user = await prisma.user.update({
      where: { id: params.id },
      data: { status },
    });

    await logActivity({
      userId: (session.user as any).id,
      action: "ADMIN_UPDATE_USER_STATUS",
      details: `Changed status of ${user.email} to ${status}`,
    });

    return NextResponse.json({ ok: true, user });
  } catch (error) {
    console.error("Error updating user status:", error);
    return NextResponse.json({ error: "Failed to update status" }, { status: 500 });
  }
}
```

## File: app/api/admin/users/[id]/soft-delete/route.ts

- Extension: .ts
- Language: typescript
- Size: 927 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:01:12

### Code

```typescript
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { hasRole } from "@/lib/rbac";
import { logActivity } from "@/lib/activity";

export async function POST(_req: Request, context: unknown) {
  const { params } = context as { params: { id: string } };

  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  if (!hasRole((session.user as any).role, "ADMIN")) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  await prisma.user.update({ where: { id: params.id }, data: { deletedAt: new Date() } });
  await logActivity({
    userId: (session.user as any).id,
    action: "ADMIN_SOFT_DELETE_USER",
    details: params.id,
  });

  return NextResponse.json({ ok: true });
}

```

## File: app/api/admin/users/[id]/hard-delete/route.ts

- Extension: .ts
- Language: typescript
- Size: 894 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:01:36

### Code

```typescript
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { hasRole } from "@/lib/rbac";
import { logActivity } from "@/lib/activity";

export async function POST(_req: Request, context: unknown) {
  const { params } = context as { params: { id: string } };

  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  if (!hasRole((session.user as any).role, "ADMIN")) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  await prisma.user.delete({ where: { id: params.id } });
  await logActivity({
    userId: (session.user as any).id,
    action: "ADMIN_HARD_DELETE_USER",
    details: params.id,
  });

  return NextResponse.json({ ok: true });
}

```

## File: app/api/admin/users/create/route.ts

- Extension: .ts
- Language: typescript
- Size: 2146 bytes
- Created: 2025-11-10 16:51:01
- Modified: 2025-11-10 16:51:01

### Code

```typescript
// app/api/admin/users/create/route.ts
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { hasRole } from "@/lib/rbac";
import bcrypt from "bcryptjs";
import { logActivity } from "@/lib/activity";

export async function POST(req: Request) {
  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  
  if (!hasRole((session.user as any).role, "ADMIN")) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  try {
    const { email, name, password, role } = await req.json();
    
    if (!email || !password) {
      return NextResponse.json({ error: "Email and password are required" }, { status: 400 });
    }

    const normalized = String(email).toLowerCase().trim();
    
    // Check if user already exists
    const existing = await prisma.user.findUnique({ where: { email: normalized } });
    if (existing) {
      return NextResponse.json({ error: "Email already in use" }, { status: 400 });
    }

    // Hash password
    const passwordHash = await bcrypt.hash(password, 10);

    // Create user with VERIFIED status and emailVerified set
    const user = await prisma.user.create({
      data: {
        email: normalized,
        name: name || null,
        passwordHash,
        role: role || "VISITOR",
        status: "VERIFIED",
        emailVerified: new Date(), // Admin-created users are automatically verified
      },
    });

    await logActivity({
      userId: (session.user as any).id,
      action: "ADMIN_CREATE_USER",
      details: `Created user ${user.email} with role ${user.role}`,
    });

    return NextResponse.json({ 
      ok: true, 
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
        role: user.role,
        status: user.status,
      }
    });
  } catch (error: any) {
    console.error("Error creating user:", error);
    return NextResponse.json({ error: "Failed to create user" }, { status: 500 });
  }
}
```

## File: app/api/requests/route.ts

- Extension: .ts
- Language: typescript
- Size: 3729 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-10-24 14:00:17

### Code

```typescript
// app/api/requests/route.ts
import { NextResponse } from "next/server";
import path from "path";
import fs from "fs/promises";
import { auth } from "@/auth";

export const revalidate = 0;
export const dynamic = "force-dynamic";

const DATA_DIR = path.join(process.cwd(), "data", "requests");
const INDEX_FILE = path.join(DATA_DIR, "index.json");

type RequestItem = {
  id: string;
  userId?: string | null;
  userEmail?: string | null;
  userName?: string | null;
  subject: string;
  payload?: any;
  requestTime: string; // ISO
  action?: "APPROVED" | "REJECTED" | "PENDING" | null;
  actionTime?: string | null; // ISO
};

async function ensureDir() {
  await fs.mkdir(DATA_DIR, { recursive: true });
  try { await fs.access(INDEX_FILE); } catch { await fs.writeFile(INDEX_FILE, "[]", "utf8"); }
}

async function readAll(): Promise<RequestItem[]> {
  await ensureDir();
  try {
    const buf = await fs.readFile(INDEX_FILE, "utf8");
    const list = JSON.parse(buf) as RequestItem[];
    // newest first
    return list.sort((a, b) => (a.requestTime < b.requestTime ? 1 : -1));
  } catch {
    return [];
  }
}

async function writeAll(items: RequestItem[]) {
  await fs.writeFile(INDEX_FILE, JSON.stringify(items, null, 2), "utf8");
}

// GET /api/requests[?all=1]
// - admins/editors: all items
// - others: only own items
export async function GET(req: Request) {
  const session = await auth().catch(() => null);
  const me = session?.user as any | undefined;
  const role = me?.role as string | undefined;

  const { searchParams } = new URL(req.url);
  const wantAll = searchParams.get("all") === "1";

  const all = await readAll();
  const visible = wantAll && (role === "ADMIN" || role === "EDITOR")
    ? all
    : all.filter((r) => r.userId && me?.id && r.userId === me.id);

  return NextResponse.json({ requests: visible });
}

// POST /api/requests
// body: { subject: string, payload?: any }
export async function POST(req: Request) {
  const session = await auth().catch(() => null);
  const me = session?.user as any | undefined;

  const { subject, payload } = await req.json().catch(() => ({}));
  if (!subject || typeof subject !== "string") {
    return NextResponse.json({ error: "Subject is required" }, { status: 400 });
  }

  const now = new Date().toISOString();
  const id = `${Date.now()}`;

  const item: RequestItem = {
    id,
    userId: me?.id ?? null,
    userEmail: me?.email ?? null,
    userName: me?.name ?? me?.email ?? "Anonymous",
    subject: subject.trim(),
    payload: payload ?? null,
    requestTime: now,
    action: "PENDING",
    actionTime: null,
  };

  const all = await readAll();
  all.push(item);
  await writeAll(all);

  return NextResponse.json({ ok: true, request: item });
}

// PATCH /api/requests
// body: { id: string, action: "APPROVED" | "REJECTED" | "PENDING" }
export async function PATCH(req: Request) {
  const session = await auth().catch(() => null);
  const me = session?.user as any | undefined;
  const role = me?.role as string | undefined;
  if (!(role === "ADMIN" || role === "EDITOR")) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const { id, action } = await req.json().catch(() => ({}));
  if (!id || !["APPROVED", "REJECTED", "PENDING"].includes(action)) {
    return NextResponse.json({ error: "Invalid payload" }, { status: 400 });
  }

  const all = await readAll();
  const idx = all.findIndex((r) => r.id === String(id));
  if (idx < 0) return NextResponse.json({ error: "Not found" }, { status: 404 });

  all[idx].action = action;
  all[idx].actionTime = action === "PENDING" ? null : new Date().toISOString();

  await writeAll(all);
  return NextResponse.json({ ok: true, request: all[idx] });
}

```

## File: app/api/profile/route.ts

- Extension: .ts
- Language: typescript
- Size: 2315 bytes
- Created: 2025-11-10 16:52:09
- Modified: 2025-11-10 16:52:09

### Code

```typescript
// app/api/profile/route.ts
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { logActivity } from "@/lib/activity";

export async function GET() {
  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  try {
    const user = await prisma.user.findUnique({
      where: { id: (session.user as any).id },
      select: {
        id: true,
        email: true,
        name: true,
        role: true,
        status: true,
        institution: true,
        personalLink: true,
        bio: true,
        emailVerified: true,
        createdAt: true,
      },
    });

    if (!user) {
      return NextResponse.json({ error: "User not found" }, { status: 404 });
    }

    return NextResponse.json({ user });
  } catch (error) {
    console.error("Error fetching profile:", error);
    return NextResponse.json({ error: "Failed to fetch profile" }, { status: 500 });
  }
}

export async function PATCH(req: Request) {
  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  try {
    const { name, institution, personalLink, bio } = await req.json();

    const user = await prisma.user.update({
      where: { id: (session.user as any).id },
      data: {
        name: name !== undefined ? name : undefined,
        institution: institution !== undefined ? institution : undefined,
        personalLink: personalLink !== undefined ? personalLink : undefined,
        bio: bio !== undefined ? bio : undefined,
      },
    });

    await logActivity({
      userId: user.id,
      action: "PROFILE_UPDATE",
      details: "Updated profile information",
    });

    return NextResponse.json({ 
      ok: true, 
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
        institution: user.institution,
        personalLink: user.personalLink,
        bio: user.bio,
      }
    });
  } catch (error) {
    console.error("Error updating profile:", error);
    return NextResponse.json({ error: "Failed to update profile" }, { status: 500 });
  }
}
```

## File: app/api/submissions/route.ts

- Extension: .ts
- Language: typescript
- Size: 4125 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-10-24 14:51:17

### Code

```typescript
// app/api/submissions/route.ts
import { NextResponse } from "next/server";
import path from "path";
import fs from "fs/promises";
import { auth } from "@/auth";

export const revalidate = 0;
export const dynamic = "force-dynamic";

const DATA_DIR = path.join(process.cwd(), "data", "submissions");
const INDEX = path.join(DATA_DIR, "index.json");

type Submission = {
  id: string;
  userId: string;
  userEmail: string;
  userName: string | null;
  formId: string;
  formName: string;
  data: any;
  submittedAt: string;  // ISO
  status: "PENDING" | "APPROVED" | "REJECTED";
  actionTime?: string | null; // ISO or null
  file: string; // saved json file path relative to /data/submissions
};

async function ensure() {
  await fs.mkdir(DATA_DIR, { recursive: true });
  try { await fs.access(INDEX); } catch { await fs.writeFile(INDEX, "[]", "utf8"); }
}
async function readAll(): Promise<Submission[]> {
  await ensure();
  try { return JSON.parse(await fs.readFile(INDEX, "utf8")); } catch { return []; }
}
async function writeAll(items: Submission[]) {
  await fs.writeFile(INDEX, JSON.stringify(items, null, 2), "utf8");
}

// GET /api/submissions[?all=1]  â†’ staff sees all, others see their own
export async function GET(req: Request) {
  const session = await auth().catch(() => null);
  const me = session?.user as any | undefined;

  if (!me) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const { searchParams } = new URL(req.url);
  const wantAll = searchParams.get("all") === "1";
  const isStaff = me.role === "ADMIN" || me.role === "EDITOR";

  const items = await readAll();
  const visible = wantAll && isStaff ? items : items.filter(s => s.userId === me.id);

  // newest first
  visible.sort((a, b) => (a.submittedAt < b.submittedAt ? 1 : -1));
  return NextResponse.json({ submissions: visible });
}

// POST /api/submissions  { formId, formName, data }
export async function POST(req: Request) {
  const session = await auth().catch(() => null);
  const me = session?.user as any | undefined;

  if (!me) return NextResponse.json({ error: "Please sign in" }, { status: 401 });

  const body = await req.json().catch(() => ({}));
  const formId = String(body.formId || "").trim();
  const formName = String(body.formName || "").trim();
  const data = body.data;

  if (!formName) return NextResponse.json({ error: "Missing formName" }, { status: 400 });

  const now = new Date().toISOString();
  const id = `${Date.now()}`;
  const file = `submission-${id}.json`;

  const submission: Submission = {
    id,
    userId: me.id,
    userEmail: me.email,
    userName: me.name || null,
    formId: formId || "custom",
    formName,
    data,
    submittedAt: now,
    status: "PENDING",
    actionTime: null,
    file,
  };

  // save the JSON file
  await ensure();
  await fs.writeFile(path.join(DATA_DIR, file), JSON.stringify(submission, null, 2), "utf8");

  // update index
  const all = await readAll();
  all.push(submission);
  await writeAll(all);

  return NextResponse.json({ ok: true, submission });
}

// PATCH /api/submissions  { id, status }
export async function PATCH(req: Request) {
  const session = await auth().catch(() => null);
  const me = session?.user as any | undefined;
  if (!(me && (me.role === "ADMIN" || me.role === "EDITOR"))) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const { id, status } = await req.json().catch(() => ({}));
  if (!id || !["PENDING", "APPROVED", "REJECTED"].includes(status)) {
    return NextResponse.json({ error: "Invalid payload" }, { status: 400 });
  }

  const all = await readAll();
  const i = all.findIndex(s => s.id === String(id));
  if (i < 0) return NextResponse.json({ error: "Not found" }, { status: 404 });

  all[i].status = status;
  all[i].actionTime = status === "PENDING" ? null : new Date().toISOString();

  await writeAll(all);

  // also update on-disk file for convenience
  try {
    await fs.writeFile(path.join(DATA_DIR, all[i].file), JSON.stringify(all[i], null, 2), "utf8");
  } catch {}

  return NextResponse.json({ ok: true, submission: all[i] });
}

```

## File: app/api/self-delete/route.ts

- Extension: .ts
- Language: typescript
- Size: 637 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-05 15:44:56

### Code

```typescript
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { logActivity } from "@/lib/activity";

export async function POST() {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  await prisma.user.update({ where: { id: (session.user as any).id }, data: { deletedAt: new Date() } });
  await logActivity({ userId: (session.user as any).id, action: "ACCOUNT_SELF_DELETE" });
  return NextResponse.json({ ok: true });
}

```

## File: app/login/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 14634 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:45:45

### Code

```typescript
"use client";
import React, { Suspense, useMemo, useState } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { signIn } from "next-auth/react";

/**
 * Drop this file at: app/(auth)/login/page.tsx  (or app/login/page.tsx)
 * TailwindCSS recommended. If you don't use it yet, the page will still render basic styles,
 * but the look shines with Tailwind.
 */

function LoginForm() {
  const router = useRouter();
  const params = useSearchParams();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const verified = params.get("verified") === "true";
  const urlError = params.get("error"); // e.g., NextAuth error query
  const callbackUrl = useMemo(() => params.get("callbackUrl") ?? "/dashboard", [params]);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (submitting) return;
    setErr(null);
    setSubmitting(true);
    const res = await signIn("credentials", {
      email,
      password,
      redirect: false,
      callbackUrl,
    });
    if (!res) {
      setErr("Something went wrong. Please try again.");
      setSubmitting(false);
      return;
    }
    if (res.error) {
      setErr(
        res.error === "EMAIL_NOT_VERIFIED"
          ? "Please verify your email first."
          : res.error === "CredentialsSignin"
          ? "Invalid email or password."
          : res.error
      );
      setSubmitting(false);
      return;
    }
    // success
    router.push(res.url ?? callbackUrl);
  }

  function onProvider(provider: string) {
    setErr(null);
    setSubmitting(true);
    signIn(provider, { callbackUrl });
  }

  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      {/* Decorative background */}
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      {/* Left panel: brand + value props */}
      <aside className="hidden lg:flex flex-col justify-between p-10">
        <header className="flex items-center gap-3">
          <div className="h-10 w-10 rounded-2xl bg-emerald-600 flex items-center justify-center text-white font-semibold shadow-md">
            AG
          </div>
          <div className="">
            <p className="text-lg font-semibold text-emerald-900">Agritourism Directory</p>
            <p className="text-sm text-emerald-800/70">Find farms, orchards, vineyards & stays</p>
          </div>
        </header>

        <section className="space-y-6">
          <ValueRow title="Search what you love" desc="Pumpkin patches, wine tastings, farm-stays, u-pick." />
          <ValueRow title="Filter by season & amenities" desc="Open today, kidâ€‘friendly, petâ€‘friendly, accessible." />
          <ValueRow title="Plan your route" desc="Pin places on the map and build a weekend trail." />
          <ValueRow title="For owners & editors" desc="Claim listings, post events, and keep info fresh." />
        </section>

        <footer className="text-sm text-emerald-900/70 flex gap-4">
          <Link href="/about" className="hover:underline">About</Link>
          <Link href="/privacy" className="hover:underline">Privacy</Link>
          <Link href="/terms" className="hover:underline">Terms</Link>
        </footer>
      </aside>

      {/* Right panel: auth card */}
      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <span className="inline-flex items-center gap-2 rounded-full border border-emerald-600/20 bg-emerald-600/5 px-3 py-1 text-xs font-medium text-emerald-800">
              <span className="h-1.5 w-1.5 rounded-full bg-emerald-600" />
              Welcome back
            </span>
            <h1 className="mt-4 text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Sign in to your account</h1>
            <p className="mt-2 text-sm text-emerald-900/70">
              Visitors can browse without an account. Owners & editors sign in to manage listings.
            </p>
          </div>

          {/* Alerts */}
          {verified && (
            <Alert type="success" message="Email verified. You can sign in now." />
          )}
          {urlError && !err && (
            <Alert type="error" message={formatUrlError(urlError)} />
          )}
          {err && <Alert type="error" message={err} />}

          <form onSubmit={onSubmit} className="rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm backdrop-blur p-6 sm:p-8 space-y-5">
            <div className="space-y-1.5">
              <label htmlFor="email" className="block text-sm font-medium text-emerald-950">Email</label>
              <div className="relative">
                <input
                  id="email"
                  type="email"
                  autoComplete="email"
                  required
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="peer w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                  placeholder="you@example.com"
                />
              </div>
            </div>

            <div className="space-y-1.5">
              <label htmlFor="password" className="block text-sm font-medium text-emerald-950">Password</label>
              <div className="relative">
                <input
                  id="password"
                  type={showPassword ? "text" : "password"}
                  autoComplete="current-password"
                  required
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="peer w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring pr-12"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword((s) => !s)}
                  className="absolute inset-y-0 right-2 my-auto h-9 rounded-lg px-3 text-sm text-emerald-950/70 hover:bg-emerald-50"
                  aria-label={showPassword ? "Hide password" : "Show password"}
                >
                  {showPassword ? "Hide" : "Show"}
                </button>
              </div>
            </div>

            <div className="flex items-center justify-between text-sm">
              <label className="flex items-center gap-2 select-none">
                <input type="checkbox" className="h-4 w-4 rounded border-emerald-900/20 text-emerald-600 focus:ring-emerald-600" />
                <span className="text-emerald-900/80">Remember me</span>
              </label>
              <Link href="/reset-request" className="text-emerald-800 hover:underline">Forgot password?</Link>
            </div>

            <button
              type="submit"
              disabled={submitting}
              className="group inline-flex w-full items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 py-3 text-white font-medium shadow-sm transition hover:bg-emerald-700 disabled:opacity-60"
            >
              {submitting ? (
                <Spinner label="Signing in" />
              ) : (
                <>
                  <span>Sign in</span>
                </>
              )}
            </button>

            <div className="relative">
              <div className="absolute inset-0 flex items-center" aria-hidden>
                <div className="w-full border-t border-emerald-900/10" />
              </div>
              <div className="relative flex justify-center">
                <span className="bg-white px-3 text-xs text-emerald-900/60">or</span>
              </div>
            </div>

            <div className="grid grid-cols-1 gap-3">
              <button
                type="button"
                onClick={() => onProvider("google")}
                className="inline-flex w-full items-center justify-center gap-2 rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 font-medium shadow-sm hover:bg-emerald-50"
              >
                <svg aria-hidden viewBox="0 0 24 24" className="h-5 w-5">
                  <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.2 3.31v2.75h3.56c2.08-1.92 3.28-4.75 3.28-8.07z"/>
                  <path fill="#34A853" d="M12 23c3 0 5.5-1 7.33-2.73l-3.56-2.75c-.98.66-2.23 1.06-3.77 1.06-2.9 0-5.35-1.96-6.23-4.6H1.99v2.86C3.81 20.53 7.58 23 12 23z"/>
                  <path fill="#FBBC05" d="M5.77 13.98c-.22-.66-.35-1.36-.35-2.08s.13-1.42.35-2.08V6.96H1.99A10.01 10.01 0 0 0 2 11.9c0 1.62.39 3.14 1.09 4.47l2.68-2.39z"/>
                  <path fill="#EA4335" d="M12 4.58c1.62 0 3.07.56 4.21 1.65l3.16-3.16C17.5 1.5 15 0.5 12 0.5 7.58 0.5 3.81 3 1.99 6.96l3.78 2.86C6.65 6.54 9.1 4.58 12 4.58z"/>
                </svg>
                Continue with Google
              </button>
            </div>

            <p className="text-center text-sm text-emerald-900/70">
              Don't have an account? <Link href="/register" className="text-emerald-800 hover:underline">Create one</Link>
            </p>
          </form>

          {/* Quick navigation for this app's personas */}
          <div className="mt-8 grid gap-3">
            <PersonaLink href="/explore" title="Browse as visitor" desc="Search farms, filter by season, and save favorites." />
            <PersonaLink href="/owner" title="Claim or manage a listing" desc="Update hours, add events, upload photos." />
            <PersonaLink href="/admin" title="Editor dashboard" desc="Review updates, manage tags & announcements." />
          </div>
        </div>
      </section>
    </main>
  );
}

function LoginFallback() {
  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      {/* Decorative background */}
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <aside className="hidden lg:flex flex-col justify-between p-10">
        <header className="flex items-center gap-3">
          <div className="h-10 w-10 rounded-2xl bg-emerald-600 flex items-center justify-center text-white font-semibold shadow-md">
            AG
          </div>
          <div className="">
            <p className="text-lg font-semibold text-emerald-900">Agritourism Directory</p>
            <p className="text-sm text-emerald-800/70">Find farms, orchards, vineyards & stays</p>
          </div>
        </header>
      </aside>

      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <h1 className="text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Loading...</h1>
          </div>
        </div>
      </section>
    </main>
  );
}

function ValueRow({ title, desc }: { title: string; desc: string }) {
  return (
    <div className="flex items-start gap-3">
      <span className="mt-1 inline-flex h-2.5 w-2.5 shrink-0 rounded-full bg-emerald-600" />
      <div>
        <p className="font-medium text-emerald-950">{title}</p>
        <p className="text-sm text-emerald-900/70">{desc}</p>
      </div>
    </div>
  );
}

function PersonaLink({ href, title, desc }: { href: string; title: string; desc: string }) {
  return (
    <Link
      href={href}
      className="group rounded-2xl border border-emerald-900/10 bg-white/60 p-4 shadow-sm backdrop-blur transition hover:border-emerald-600/30 hover:bg-white"
    >
      <div className="flex items-center justify-between">
        <div>
          <p className="font-medium text-emerald-950">{title}</p>
          <p className="text-sm text-emerald-900/70">{desc}</p>
        </div>
        <span className="ml-4 inline-flex h-9 w-9 items-center justify-center rounded-xl border border-emerald-900/10 bg-white text-emerald-900/70 group-hover:border-emerald-600/30 group-hover:text-emerald-900">
          â†’
        </span>
      </div>
    </Link>
  );
}

function Alert({ type, message }: { type: "success" | "error"; message: string }) {
  const base = "rounded-xl px-4 py-3 mb-4 text-sm border";
  const t =
    type === "success"
      ? "bg-emerald-50 border-emerald-200 text-emerald-900"
      : "bg-rose-50 border-rose-200 text-rose-950";
  return <div role="status" className={`${base} ${t}`}>{message}</div>;
}

function Spinner({ label }: { label?: string }) {
  return (
    <span className="inline-flex items-center gap-2">
      <svg className="h-4 w-4 animate-spin" viewBox="0 0 24 24" aria-hidden>
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z" />
      </svg>
      {label && <span>{label}</span>}
    </span>
  );
}

function formatUrlError(e: string) {
  switch (e) {
    case "AccessDenied":
      return "Access denied. Please use an authorized account.";
    case "Verification":
      return "Verification link invalid or expired. Request a new one.";
    case "OAuthSignin":
    case "OAuthCallback":
      return "Could not sign in with provider. Try again.";
    case "CredentialsSignin":
      return "Invalid email or password.";
    default:
      return e.replaceAll("_", " ");
  }
}

export default function LoginPage() {
  return (
    <Suspense fallback={<LoginFallback />}>
      <LoginForm />
    </Suspense>
  );
}
```

