# Table of Contents
- app/layout.tsx
- app/page.tsx
- app/providers.tsx
- app/owner/page.tsx
- app/verify/page.tsx
- app/reset/page.tsx
- app/admin/listings/page.tsx
- app/admin/requests/page.tsx
- app/admin/users/page.tsx
- app/admin/submissions/page.tsx
- app/dashboard/sign-out-button.tsx
- app/dashboard/page.tsx
- app/reset-request/page.tsx
- app/components/landing/search-bar.tsx
- app/components/auth/ui.tsx
- app/components/site/nav.tsx
- app/components/site/footer.tsx
- app/components/site/logo.tsx
- app/components/site/header.tsx
- app/register/page.tsx
- app/api/auth/verify/route.ts
- app/api/auth/reset/route.ts
- app/api/auth/reset-request/route.ts
- app/api/auth/register/route.ts
- app/api/auth/[...nextauth]/route.ts
- app/api/listings/route.ts
- app/api/listings/[id]/route.ts
- app/api/admin/users/route.ts
- app/api/admin/users/[id]/soft-delete/route.ts
- app/api/admin/users/[id]/hard-delete/route.ts
- app/api/requests/route.ts
- app/api/submissions/route.ts
- app/api/self-delete/route.ts
- app/login/page.tsx

## File: app/layout.tsx

- Extension: .tsx
- Language: typescript
- Size: 1232 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-10-24 14:53:50

### Code

```typescript
// app/layout.tsx
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

import Providers from "./providers";           // ðŸ‘ˆ add this
import SiteHeader from "./components/site/header";
import SiteFooter from "./components/site/footer";

const geistSans = Geist({ variable: "--font-geist-sans", subsets: ["latin"] });
const geistMono = Geist_Mono({ variable: "--font-geist-mono", subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Local Food Directories",
  description: "Farms, farmers markets and food hubs near you.",
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body
        suppressHydrationWarning
        className={`${geistSans.variable} ${geistMono.variable} antialiased bg-[#eef6e6] text-slate-800`}
      >
        {/* âœ… Wrap the app in SessionProvider so useSession() works */}
        <Providers>
          <div className="min-h-svh flex flex-col">
            <SiteHeader />
            <main className="flex-1">{children}</main>
            <SiteFooter />
          </div>
        </Providers>
      </body>
    </html>
  );
}

```

## File: app/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 13969 bytes
- Created: 2025-11-10 09:43:17
- Modified: 2025-11-10 09:43:16

### Code

```typescript
"use client";

import React, { useMemo, useState } from "react";

/* ---------- Helper UI bits ---------- */
const Container = ({
  children,
  className = "",
}: {
  children: React.ReactNode;
  className?: string;
}) => (
  <div className={`mx-auto w-full max-w-[1200px] px-4 sm:px-6 lg:px-8 ${className}`}>
    {children}
  </div>
);

const Pill = ({
  children,
  className = "",
}: {
  children: React.ReactNode;
  className?: string;
}) => (
  <span className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${className}`}>
    {children}
  </span>
);

const Button = ({ children, className = "", as = "button", ...props }: any) => {
  const Comp = as as any;
  return (
    <Comp
      className={`rounded-lg border border-green-700 bg-green-700 px-3 py-2 text-sm font-semibold text-white shadow-sm transition hover:-translate-y-0.5 hover:bg-green-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-green-600 focus-visible:ring-offset-2 ${className}`}
      {...props}
    >
      {children}
    </Comp>
  );
};

const OutlineButton = ({ children, className = "", as = "button", ...props }: any) => {
  const Comp = as as any;
  return (
    <Comp
      className={`rounded-lg border border-green-700 bg-white px-3 py-2 text-sm font-semibold text-green-800 shadow-sm transition hover:bg-green-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-green-600 focus-visible:ring-offset-2 ${className}`}
      {...props}
    >
      {children}
    </Comp>
  );
};

/* ---------- Data ---------- */
const DIRECTORIES = [
  {
    key: "agritourism",
    title: "Agritourism",
    listings: 14580,
    blurb:
      "Discover a wide variety of farm-to-table, u-pick, corn mazes, and Christmas tree farms near you.",
    cta: "Find a farm",
    img: "https://images.unsplash.com/photo-1500937386664-56d1dfef3854?q=80&w=1600&auto=format&fit=crop",
  },
  {
    key: "csa",
    title: "CSA",
    listings: 4460,
    blurb:
      "Subscribe to a 'share' in local farms to get fresh, in-season produce directly from the farmer.",
    cta: "Find a CSA",
    img: "https://images.unsplash.com/photo-1517263904808-5dc91e3e7044?q=80&w=1600&auto=format&fit=crop",
  },
  {
    key: "farmers-market",
    title: "Farmers Market",
    listings: 7680,
    blurb: "Looking for local, seasonal foods from nearby farmers & makers?",
    cta: "Find a market",
    img: "https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?q=80&w=1600&auto=format&fit=crop",
  },
  {
    key: "food-hub",
    title: "Food Hub",
    listings: 470,
    blurb:
      "Search food hubs that aggregate, distribute, and coordinate local food for businesses.",
    cta: "Find a food hub",
    img: "https://images.unsplash.com/photo-1484980972926-edee96e0960d?q=80&w=1600&auto=format&fit=crop",
  },
  {
    key: "on-farm-market",
    title: "On-Farm Market",
    listings: 4140,
    blurb:
      "Choose self-serve, specialty produce, and products directly at a consumer-facing on-farm store.",
    cta: "Find a market",
    img: "https://images.unsplash.com/photo-1506806732259-39c2d0268443?q=80&w=1600&auto=format&fit=crop",
  },
];

/* ---------- Main ---------- */
export default function HomePage() {
  return (
    <div className="min-h-screen bg-[#eef6e6] text-slate-800">
       <Hero />
       <DirectoryGrid />
       <Contact />
    </div>
  );
}

/* ---------- Hero ---------- */
function Hero() {
  const [query, setQuery] = useState("");
  const [location, setLocation] = useState("");
  const [directory, setDirectory] = useState("all");

  return (
    <section id="hero" className="relative w-full border-b border-slate-200">
      <div className="absolute inset-0 -z-10">
        <div className="grid h-[320px] w-full grid-cols-3 gap-0 overflow-hidden md:h-[360px] lg:h-[420px]">
          <div
            className="h-full w-full bg-cover bg-center"
            style={{
              backgroundImage:
                "url(https://images.unsplash.com/photo-1536412597336-ade7c1ae77b3?q=80&w=2400&auto=format&fit=crop)",
            }}
          >
            <div className="h-full w-full bg-gradient-to-r from-black/40 to-black/0" />
          </div>
          <div
            className="h-full w-full bg-cover bg-center"
            style={{
              backgroundImage:
                "url(https://images.unsplash.com/photo-1464226184884-fa280b87c399?q=80&w=2400&auto=format&fit=crop)",
            }}
          >
            <div className="h-full w-full bg-black/25" />
          </div>
          <div
            className="h-full w-full bg-cover bg-center"
            style={{
              backgroundImage:
                "url(https://images.unsplash.com/photo-1464226184884-fa280b87c399?q=80&w=2400&auto=format&fit=crop)",
            }}
          >
            <div className="h-full w-full bg-gradient-to-l from-black/40 to-black/0" />
          </div>
        </div>
      </div>

      <Container className="relative">
        <div className="pt-16 md:pt-20 lg:pt-24" />
        <div className="mx-auto w-full rounded-xl border border-white/40 bg-white/80 p-2 shadow-lg ring-1 ring-black/5 backdrop-blur md:flex md:items-center md:gap-2">
          <div className="flex-1">
            <label htmlFor="q" className="sr-only">
              What are you looking for?
            </label>
            <input
              id="q"
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              placeholder="What are you looking for?"
              className="w-full rounded-lg border-0 bg-transparent px-3 py-2 text-sm text-slate-900 placeholder:text-slate-500 focus:outline-none"
            />
          </div>
          <div className="h-px w-full bg-slate-200 md:h-8 md:w-px" />
          <div className="w-full md:w-56">
            <label htmlFor="loc" className="sr-only">
              Location
            </label>
            <input
              id="loc"
              value={location}
              onChange={(e) => setLocation(e.target.value)}
              placeholder="Location"
              className="w-full rounded-lg border-0 bg-transparent px-3 py-2 text-sm text-slate-900 placeholder:text-slate-500 focus:outline-none"
            />
          </div>
          <div className="h-px w-full bg-slate-200 md:h-8 md:w-px" />
          <div className="w-full md:w-56">
            <label htmlFor="dir" className="sr-only">
              Select directory
            </label>
            <select
              id="dir"
              value={directory}
              onChange={(e) => setDirectory(e.target.value)}
              className="w-full rounded-lg border-0 bg-transparent px-3 py-2 text-sm text-slate-900 focus:outline-none"
            >
              <option value="all">Select directory</option>
              {DIRECTORIES.map((d) => (
                <option key={d.key} value={d.key}>
                  {d.title}
                </option>
              ))}
            </select>
          </div>
          <div className="mt-2 flex justify-end md:mt-0">
            <Button className="w-full md:w-auto">Search</Button>
          </div>
        </div>

        <div className="mt-3 flex items-center justify-center gap-2 pb-10 text-xs text-slate-100 drop-shadow md:pb-14">
          <span>Farms, farmers markets and food hubs near you</span>
          <span title="This is a demo replica UI.">â€¢</span>
        </div>
      </Container>
    </section>
  );
}

/* ---------- Directory Grid ---------- */
function DirectoryGrid() {
  return (
    <section id="directories" className="py-6 md:py-10">
      <Container>
        <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5">
          {DIRECTORIES.map(({ key: id, ...props }) => (
            <DirectoryCard key={id} {...props} />
          ))}
        </div>
      </Container>
    </section>
  );
}

function DirectoryCard({
  title,
  listings,
  blurb,
  cta,
  img,
}: {
  title: string;
  listings: number;
  blurb: string;
  cta: string;
  img: string;
}) {
  return (
    <div className="overflow-hidden rounded-xl border border-green-700/30 bg-white shadow-sm transition hover:shadow-md">
      <div className="relative h-28 w-full overflow-hidden bg-slate-100">
        <img src={img} alt="" className="h-full w-full object-cover blur-[1px] scale-110" />
        <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-black/10 to-transparent" />
        <div className="absolute top-2 left-2">
          <Pill className="bg-green-700/90 text-white">{title}</Pill>
        </div>
      </div>
      <div className="space-y-2 p-3 text-xs">
        <div className="text-[11px] text-slate-500">
          Total <span className="font-semibold">{listings.toLocaleString()}</span> listings
        </div>
        <p className="min-h-[40px] leading-relaxed text-slate-700">{blurb}</p>
        <Button as="a" href="#" className="mt-1 w-full text-center text-xs">
          {cta}
        </Button>
      </div>
    </div>
  );
}

/* ---------- Contact ---------- */
function Contact() {
  const [email, setEmail] = useState("");
  const [phone, setPhone] = useState("");
  const [subject, setSubject] = useState("");
  const [message, setMessage] = useState("");
  const challenge = useMemo(() => ({ a: 5, b: 1, sum: 6 }), []);
  const [answer, setAnswer] = useState("");
  const [sent, setSent] = useState(false);
  const [errors, setErrors] = useState<string[]>([]);

  const onSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const errs: string[] = [];
    if (!email) errs.push("Email is required");
    if (!subject) errs.push("Subject is required");
    if (!message) errs.push("Message is required");
    if (parseInt(answer, 10) !== challenge.sum) errs.push("Captcha incorrect");
    setErrors(errs);
    if (errs.length === 0) setSent(true);
  };

  return (
    <section id="contact" className="py-8 md:py-12">
      <Container>
        <div className="mx-auto w-full max-w-md rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
          <h3 className="mb-3 text-center text-sm font-semibold text-slate-800">Contact Us</h3>
          {sent ? (
            <div className="rounded-lg bg-green-50 p-3 text-sm text-green-700">
              Thanks! Your message has been submitted (demo). We will get back to you soon.
            </div>
          ) : (
            <form onSubmit={onSubmit} className="space-y-2 text-xs">
              <label className="block">
                <span className="mb-1 block font-medium text-slate-700">Email*</span>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full rounded-lg border border-slate-300 px-3 py-2 focus:border-green-600 focus:outline-none"
                />
              </label>
              <label className="block">
                <span className="mb-1 block font-medium text-slate-700">Phone Number</span>
                <input
                  type="tel"
                  value={phone}
                  onChange={(e) => setPhone(e.target.value)}
                  className="w-full rounded-lg border border-slate-300 px-3 py-2 focus:border-green-600 focus:outline-none"
                />
              </label>
              <label className="block">
                <span className="mb-1 block font-medium text-slate-700">Subject*</span>
                <input
                  value={subject}
                  onChange={(e) => setSubject(e.target.value)}
                  className="w-full rounded-lg border border-slate-300 px-3 py-2 focus:border-green-600 focus:outline-none"
                />
              </label>
              <label className="block">
                <span className="mb-1 block font-medium text-slate-700">Message*</span>
                <textarea
                  rows={4}
                  value={message}
                  onChange={(e) => setMessage(e.target.value)}
                  className="w-full rounded-lg border border-slate-300 px-3 py-2 focus:border-green-600 focus:outline-none"
                />
              </label>
              <div className="flex items-center gap-2 pt-1">
                <span className="text-slate-700">
                  Please solve this equation before submitting the message*
                </span>
              </div>
              <div className="flex items-center gap-2">
                <div className="rounded-md border border-slate-300 px-2 py-1 text-sm text-slate-700">
                  {challenge.a} + {challenge.b} =
                </div>
                <input
                  inputMode="numeric"
                  value={answer}
                  onChange={(e) => setAnswer(e.target.value)}
                  className="h-9 w-20 rounded-lg border border-slate-300 px-3 focus:border-green-600 focus:outline-none"
                />
                <span className="text-xs text-slate-500">* required fields</span>
              </div>
              {errors.length > 0 && (
                <ul className="list-inside list-disc rounded-lg bg-red-50 p-2 text-[11px] text-red-700">
                  {errors.map((e) => (
                    <li key={e}>{e}</li>
                  ))}
                </ul>
              )}
              <div className="flex justify-end pt-1">
                <Button type="submit" className="px-4 py-2">
                  Send Message
                </Button>
              </div>
              <p className="pt-2 text-center text-[11px] text-slate-500">
                You can also send messages to{" "}
                <a className="font-medium text-green-700 underline" href="mailto:directory@localfood.example">
                  directory@localfood.example
                </a>
              </p>
            </form>
          )}
        </div>
      </Container>
    </section>
  );
}

```

## File: app/providers.tsx

- Extension: .tsx
- Language: typescript
- Size: 233 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-24 15:32:27

### Code

```typescript
"use client";

import { SessionProvider } from "next-auth/react";
import React from "react";

export default function Providers({ children }: { children: React.ReactNode }) {
  return <SessionProvider>{children}</SessionProvider>;
}

```

## File: app/owner/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 7177 bytes
- Created: 2025-11-10 14:33:34
- Modified: 2025-11-10 10:43:50

### Code

```typescript
// Owner portal â€” create & manage listings
"use client";
import React from "react";
import Link from "next/link";

export default function OwnerPage() {
  const [name, setName] = React.useState("");
  const [shortIntro, setShortIntro] = React.useState("");
  const [creating, setCreating] = React.useState(false);
  const [listings, setListings] = React.useState<any[]>([]);
  const [loading, setLoading] = React.useState(true);
  const [err, setErr] = React.useState<string | null>(null);

  async function load() {
    setLoading(true);
    const r = await fetch("/api/listings", { cache: "no-store" });
    const d = await r.json().catch(() => ({}));
    setListings(d?.listings || []);
    setLoading(false);
  }

  React.useEffect(() => {
    load();
  }, []);

  async function onCreate(e: React.FormEvent) {
    e.preventDefault();
    if (creating) return;
    setErr(null);
    setCreating(true);
    const r = await fetch("/api/listings", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, shortIntro }),
    });
    const d = await r.json().catch(() => ({}));
    if (!r.ok) setErr(d?.error || "Unable to create listing");
    setCreating(false);
    setName("");
    setShortIntro("");
    load(); // This will reload the table and show the new "PENDING" listing
  }

  // ðŸ‘‡ *** THIS IS THE FIX ***
  // We no longer need the submitForReview function, so we remove it.
  /*
  async function submitForReview(id: string) {
    await fetch(`/api/listings/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "submit" }),
    });
    load();
  }
  */

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <section className="mx-auto max-w-6xl p-6 sm:p-10">
        <header className="mb-6">
          <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">
            Owner Â· Manage listings
          </h1>
          {/* ðŸ‘‡ *** FIX *** (Updated description) */}
          <p className="text-sm text-emerald-900/70">
            Create a listing to submit it for review.
          </p>
        </header>

        {err && (
          <div className="rounded-xl bg-rose-50 border border-rose-200 text-rose-950 px-4 py-3 mb-4 text-sm">
            {err}
          </div>
        )}

        <form
          onSubmit={onCreate}
          className="rounded-2xl border border-emerald-900/10 bg-white/70 p-4 sm:p-6 shadow-sm grid gap-3 sm:grid-cols-3"
        >
          <div className="sm:col-span-1">
            <label className="block text-sm font-medium text-emerald-950">
              Business name
            </label>
            <input
              value={name}
              onChange={(e) => setName(e.target.value)}
              required
              className="mt-1 w-full rounded-xl border border-emerald-900/15 bg-white px-3 py-2 shadow-inner outline-none focus:border-emerald-600/40 focus:ring-1 focus:ring-emerald-600/20"
            />
          </div>
          <div className="sm:col-span-2">
            <label className="block text-sm font-medium text-emerald-950">
              Short intro
            </label>
            <input
              value={shortIntro}
              onChange={(e) => setShortIntro(e.target.value)}
              className="mt-1 w-full rounded-xl border border-emerald-900/15 bg-white px-3 py-2 shadow-inner outline-none"
              placeholder="What you're known forâ€¦"
            />
          </div>
          <div className="sm:col-span-3">
            {/* ðŸ‘‡ *** FIX *** (Updated button text) */}
            <button
              disabled={creating}
              className="rounded-xl bg-emerald-600 text-white px-4 py-2 shadow-sm hover:bg-emerald-700"
            >
              {creating ? "Submitting..." : "Create & submit for review"}
            </button>
          </div>
        </form>

        <div className="mt-6 overflow-x-auto rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b border-emerald-900/10">
                <th className="p-3">Name</th>
                <th className="p-3">Status</th>
                <th className="p-3">Slug</th>
                <th className="p-3">Actions</th>
              </tr>
            </thead>
            <tbody>
              {loading ? (
                <tr>
                  <td className="p-4 text-emerald-900/70" colSpan={4}>
                    Loadingâ€¦
                  </td>
                </tr>
              ) : listings.length === 0 ? (
                <tr>
                  <td className="p-4 text-emerald-900/70" colSpan={4}>
                    No listings yet.
                  </td>
                </tr>
              ) : (
                listings.map((l: any) => (
                  <tr key={l.id} className="border-t border-emerald-900/10">
                    <td className="p-3">{l.name}</td>
                    <td className="p-3">
                      {/* ðŸ‘‡ *** FIX *** (Added status styling) */}
                      <span
                        className={`rounded-full px-2 py-0.5 text-xs font-medium border ${
                          l.status === "PUBLISHED"
                            ? "bg-emerald-50 text-emerald-800 border-emerald-200"
                            : l.status === "REJECTED"
                            ? "bg-rose-50 text-rose-800 border-rose-200"
                            : l.status === "PENDING"
                            ? "bg-amber-50 text-amber-800 border-amber-200"
                            : "bg-slate-50 text-slate-800 border-slate-200"
                        }`}
                      >
                        {l.status}
                      </span>
                    </td>
                    <td className="p-3">{l.slug}</td>
                    <td className="p-3">
                      <div className="flex gap-2">
                        {/* ðŸ‘‡ *** FIX *** (Removed the Submit button) */}
                        {/* <button onClick={() => submitForReview(l.id)} className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">Submit</button> */}
                        <Link
                          href={`/explore/${l.slug}`}
                          className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50"
                        >
                          Preview
                        </Link>
                      </div>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  );
}

```

## File: app/verify/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 4156 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:43:30

### Code

```typescript
// =============================================================
// app/verify/page.tsx â€” email verification landing
// =============================================================
"use client";
import React, { Suspense, useEffect, useState } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { BgDecor, BrandAside, Alert, Spinner } from "../components/auth/ui";

function VerifyForm() {
  const params = useSearchParams();
  const router = useRouter();
  const token = params.get("token");

  const [status, setStatus] = useState<"idle" | "loading" | "ok" | "error">("idle");
  const [message, setMessage] = useState<string>("");

  useEffect(() => {
    async function run() {
      if (!token) {
        setStatus("error");
        setMessage("Missing verification token.");
        return;
      }
      setStatus("loading");
      try {
        const res = await fetch(`/api/auth/verify?token=${encodeURIComponent(token)}`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || "Verification failed.");
        setStatus("ok");
        setMessage("Your email is verified. You can sign in now.");
      } catch (e: any) {
        setStatus("error");
        setMessage(e?.message || "Verification failed.");
      }
    }
    run();
  }, [token]);

  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />

      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <span className="inline-flex items-center gap-2 rounded-full border border-emerald-600/20 bg-emerald-600/5 px-3 py-1 text-xs font-medium text-emerald-800">
              <span className="h-1.5 w-1.5 rounded-full bg-emerald-600" />
              Verify email
            </span>
            <h1 className="mt-4 text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Checking your linkâ€¦</h1>
            <p className="mt-2 text-sm text-emerald-900/70">Please wait while we confirm your account.</p>
          </div>

          {status === "loading" && (
            <div className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 sm:p-8 text-center">
              <Spinner label="Verifying" />
            </div>
          )}

          {status === "ok" && (
            <div className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 sm:p-8">
              <Alert type="success" message={message || "Verified"} />
              <Link href="/login?verified=true" className="mt-2 inline-flex items-center justify-center rounded-xl bg-emerald-600 px-4 py-2 text-white font-medium shadow-sm hover:bg-emerald-700">Go to sign in</Link>
            </div>
          )}

          {status === "error" && (
            <div className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 sm:p-8">
              <Alert type="error" message={message || "Verification failed"} />
              <div className="flex items-center gap-3 mt-2">
                <Link href="/register" className="text-emerald-800 hover:underline">Create account</Link>
                <span className="text-emerald-900/50">Â·</span>
                <Link href="/reset-request" className="text-emerald-800 hover:underline">Forgot password?</Link>
              </div>
            </div>
          )}
        </div>
      </section>
    </main>
  );
}

function VerifyFallback() {
  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />
      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <h1 className="text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Loading...</h1>
          </div>
        </div>
      </section>
    </main>
  );
}

export default function VerifyPage() {
  return (
    <Suspense fallback={<VerifyFallback />}>
      <VerifyForm />
    </Suspense>
  );
}
```

## File: app/reset/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 6196 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:44:32

### Code

```typescript
// =============================================================
// app/reset/page.tsx â€” set a new password (token in URL)
// =============================================================
"use client";
import React, { Suspense, useState } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { BgDecor, BrandAside, Alert, Spinner } from "../components/auth/ui";

function ResetForm() {
  const params = useSearchParams();
  const router = useRouter();
  const token = params.get("token") || "";

  const [password, setPassword] = useState("");
  const [password2, setPassword2] = useState("");
  const [show, setShow] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [err, setErr] = useState<string | null>(null);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (submitting) return;
    setMsg(null);
    setErr(null);

    if (!token) return setErr("Reset link missing or invalid.");
    if (password !== password2) return setErr("Passwords do not match.");
    if (password.length < 8) return setErr("Password must be at least 8 characters.");

    setSubmitting(true);
    try {
      const res = await fetch("/api/auth/reset", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, password }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || "Unable to reset password.");

      setMsg("Password updated. You can sign in now.");
      setTimeout(() => router.push("/login"), 800);
    } catch (e: any) {
      setErr(e?.message || "Something went wrong. Please try again.");
    } finally {
      setSubmitting(false);
    }
  }

  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />

      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <span className="inline-flex items-center gap-2 rounded-full border border-emerald-600/20 bg-emerald-600/5 px-3 py-1 text-xs font-medium text-emerald-800">
              <span className="h-1.5 w-1.5 rounded-full bg-emerald-600" />
              Choose a new password
            </span>
            <h1 className="mt-4 text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Reset your password</h1>
            <p className="mt-2 text-sm text-emerald-900/70">Your reset link is tied to this device and expires for security.</p>
          </div>

          {msg && <Alert type="success" message={msg} />}
          {err && <Alert type="error" message={err} />}

          <form onSubmit={onSubmit} className="rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm backdrop-blur p-6 sm:p-8 space-y-5">
            <div className="space-y-1.5">
              <label htmlFor="password" className="block text-sm font-medium text-emerald-950">New password</label>
              <div className="relative">
                <input
                  id="password"
                  type={show ? "text" : "password"}
                  required
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="peer w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring pr-12"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  autoComplete="new-password"
                />
                <button
                  type="button"
                  onClick={() => setShow((s) => !s)}
                  className="absolute inset-y-0 right-2 my-auto h-9 rounded-lg px-3 text-sm text-emerald-950/70 hover:bg-emerald-50"
                >
                  {show ? "Hide" : "Show"}
                </button>
              </div>
            </div>

            <div className="space-y-1.5">
              <label htmlFor="password2" className="block text-sm font-medium text-emerald-950">Confirm new password</label>
              <input
                id="password2"
                type={show ? "text" : "password"}
                required
                value={password2}
                onChange={(e) => setPassword2(e.target.value)}
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                autoComplete="new-password"
              />
            </div>

            <button
              type="submit"
              disabled={submitting}
              className="group inline-flex w-full items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 py-3 text-white font-medium shadow-sm transition hover:bg-emerald-700 disabled:opacity-60"
            >
              {submitting ? <Spinner label="Updating" /> : <span>Update password</span>}
            </button>

            <p className="text-center text-sm text-emerald-900/70">
              All set? <Link href="/login" className="text-emerald-800 hover:underline">Back to sign in</Link>
            </p>
          </form>
        </div>
      </section>
    </main>
  );
}

function ResetFallback() {
  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />
      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <h1 className="text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Loading...</h1>
          </div>
        </div>
      </section>
    </main>
  );
}

export default function ResetPage() {
  return (
    <Suspense fallback={<ResetFallback />}>
      <ResetForm />
    </Suspense>
  );
}
```

## File: app/admin/listings/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 5471 bytes
- Created: 2025-11-10 14:33:34
- Modified: 2025-11-10 10:59:22

### Code

```typescript
import { auth } from "@/auth";
import { headers, cookies } from "next/headers";

// ðŸ‘‡ *** HELPER FUNCTION ***
// This function forwards the admin's session cookies to the API
async function apiFetch(path: string, init: RequestInit = {}) {
  const h = headers();
  const c = cookies();
  const host = h.get("x-forwarded-host") ?? h.get("host");
  const proto = h.get("x-forwarded-proto") ?? "http";

  if (!host) throw new Error("Missing host header");

  const base = `${proto}://${host}`;

  return fetch(`${base}${path}`, {
    ...init,
    cache: "no-store",
    headers: {
      ...(init.headers || {}),
      cookie: c.toString(),
      "content-type":
        (init.headers as any)?.["content-type"] ?? "application/json",
    },
  });
}

async function getListings() {
  // ðŸ‘‡ Use `apiFetch` to ensure the admin's session is sent
  const res = await apiFetch("/api/listings?all=1");
  if (!res.ok) return { listings: [] as any[] };
  return res.json();
}

export default async function AdminListingsPage() {
  const session = await auth();
  if (!session?.user) return null;

  const { listings } = await getListings();

  async function moderate(
    id: string,
    status: "PUBLISHED" | "REJECTED" | "PENDING",
  ) {
    "use server";
    // ðŸ‘‡ Use `apiFetch` to send the moderation command as an admin
    await apiFetch(`/api/listings/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "moderate", status }),
    });
  }

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <section className="mx-auto max-w-6xl p-6 sm:p-10">
        <header className="mb-6">
          <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">
            Admin Â· Listings
          </h1>
          <p className="text-sm text-emerald-900/70">
            Moderate submissions and keep the directory tidy.
          </p>
        </header>

        <div className="overflow-x-auto rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b border-emerald-900/10">
                <th className="p-3">Name</th>
                <th className="p-3">Status</th>
                <th className="p-3">Owner</th>
                <th className="p-3">Created</th>
                <th className="p-3">Actions</th>
              </tr>
            </thead>
            <tbody>
              {listings.map((l: any) => (
                <tr key={l.id} className="border-t border-emerald-900/10">
                  <td className="p-3">{l.name}</td>
                  <td className="p-3">
                    {/* ðŸ‘‡ Added styling for status */}
                    <span
                      className={`rounded-full px-2 py-0.5 text-xs font-medium border ${
                        l.status === "PUBLISHED"
                          ? "bg-emerald-50 text-emerald-800 border-emerald-200"
                          : l.status === "REJECTED"
                          ? "bg-rose-50 text-rose-800 border-rose-200"
                          : l.status === "PENDING"
                          ? "bg-amber-50 text-amber-800 border-amber-200"
                          : "bg-slate-50 text-slate-800 border-slate-200"
                      }`}
                    >
                      {l.status}
                    </span>
                  </td>
                  <td className="p-3">{l.ownerId || "â€”"}</td>
                  <td className="p-3">
                    {new Date(l.createdAt).toLocaleString()}
                  </td>
                  <td className="p-3">
                    <div className="flex gap-2">
                      <form action={moderate.bind(null, l.id, "PUBLISHED")}>
                        <button className="rounded-lg bg-emerald-600 text-white px-3 py-1 hover:bg-emerald-700">
                          Publish
                        </button>
                      </form>
                      <form action={moderate.bind(null, l.id, "REJECTED")}>
                        <button className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">
                          Reject
                        </button>
                      </form>
                      <form action={moderate.bind(null, l.id, "PENDING")}>
                        <button className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">
                          Pend
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              ))}
              {listings.length === 0 && (
                <tr>
                  <td
                    className="p-4 text-emerald-900/70"
                    colSpan={5}
                  >
                    No listings found.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  );
}

```

## File: app/admin/requests/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 4656 bytes
- Created: 2025-11-10 16:30:37
- Modified: 2025-11-10 16:30:37

### Code

```typescript
import { auth } from "@/auth";

async function getAll() {
  const res = await fetch("/api/requests?all=1", { cache: "no-store" });
  if (!res.ok) return { requests: [] as any[] };
  return res.json();
}

export default async function AdminRequestsPage() {
  const session = await auth();
  const user = session?.user as any;
  if (!user) return null;
  const isStaff = user.role === "ADMIN" || user.role === "EDITOR";
  if (!isStaff) return null;

  const { requests } = await getAll();

  async function moderate(id: string, action: "APPROVED" | "REJECTED" | "PENDING") {
    "use server";
    await fetch("/api/requests", {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, action }),
      cache: "no-store",
    });
  }

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <section className="mx-auto max-w-6xl p-6 sm:p-10">
        <header className="mb-6">
          <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">Admin Â· Approvals</h1>
          <p className="text-sm text-emerald-900/70">Review user-submitted requests.</p>
        </header>

        <div className="overflow-x-auto rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b border-emerald-900/10">
                <th className="p-3">ID</th>
                <th className="p-3">User name</th>
                <th className="p-3">Task subject</th>
                <th className="p-3">Request time</th>
                <th className="p-3">Actions</th>
                <th className="p-3">Action time</th>
              </tr>
            </thead>
            <tbody>
              {requests.map((r: any) => (
                <tr key={r.id} className="border-t border-emerald-900/10 align-top">
                  <td className="p-3 text-xs">{r.id}</td>
                  <td className="p-3">
                    <div className="font-medium">{r.userName || "â€”"}</div>
                    <div className="text-xs text-emerald-900/60">{r.userEmail || ""}</div>
                  </td>
                  <td className="p-3">
                    <div className="font-medium">{r.subject}</div>
                    {r.payload ? (
                      <pre className="mt-1 max-w-[520px] overflow-x-auto rounded-lg bg-slate-50 p-2 text-[11px] text-slate-700">
                        {JSON.stringify(r.payload, null, 2)}
                      </pre>
                    ) : null}
                  </td>
                  <td className="p-3">{new Date(r.requestTime).toLocaleString()}</td>
                  <td className="p-3">
                    <div className="flex flex-wrap items-center gap-2">
                      <span className={`rounded-full px-2 py-0.5 text-xs border ${
                        r.action === "APPROVED" ? "bg-emerald-50 text-emerald-800 border-emerald-200"
                        : r.action === "REJECTED" ? "bg-rose-50 text-rose-800 border-rose-200"
                        : "bg-amber-50 text-amber-800 border-amber-200"
                      }`}>
                        {r.action || "PENDING"}
                      </span>
                      <form action={moderate.bind(null, r.id, "APPROVED")}><button className="rounded-lg bg-emerald-600 text-white px-3 py-1 hover:bg-emerald-700">Approve</button></form>
                      <form action={moderate.bind(null, r.id, "REJECTED")}><button className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">Reject</button></form>
                      <form action={moderate.bind(null, r.id, "PENDING")}><button className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">Pend</button></form>
                    </div>
                  </td>
                  <td className="p-3">{r.actionTime ? new Date(r.actionTime).toLocaleString() : "â€”"}</td>
                </tr>
              ))}
              {requests.length === 0 && (
                <tr><td className="p-4 text-emerald-900/70" colSpan={6}>No requests yet.</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  );
}

```

## File: app/admin/users/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 5469 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-10-24 14:58:15

### Code

```typescript
import { auth } from "@/auth";
import { headers, cookies } from "next/headers";

async function apiFetch(path: string, init: RequestInit = {}) {
  const h = await headers();
  const c = await cookies();
  const host = h.get("x-forwarded-host") ?? h.get("host");
  const proto = h.get("x-forwarded-proto") ?? "http";
  if (!host) throw new Error("Missing host header");
  const base = `${proto}://${host}`;

  return fetch(`${base}${path}`, {
    ...init,
    cache: "no-store",
    headers: {
      ...(init.headers || {}),
      cookie: c.toString(),
      "content-type": (init.headers as any)?.["content-type"] ?? "application/json",
    },
  });
}

async function getUsers() {
  const res = await apiFetch(`/api/admin/users`);
  if (!res.ok) return { users: [] as any[] };
  return res.json();
}

export default async function AdminUsersPage() {
  const session = await auth();
  if (!session?.user) return null;

  const { users } = await getUsers();

  async function softDelete(id: string) {
    "use server";
    await apiFetch(`/api/admin/users/${id}/soft-delete`, { method: "POST" });
  }

  async function hardDelete(id: string) {
    "use server";
    await apiFetch(`/api/admin/users/${id}/hard-delete`, { method: "POST" });
  }

  async function invite(formData: FormData) {
    "use server";
    const email = String(formData.get("email") || "");
    const role = String(formData.get("role") || "VISITOR");
    await apiFetch(`/api/admin/users`, {
      method: "POST",
      body: JSON.stringify({ email, role }),
    });
  }

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <section className="mx-auto max-w-6xl p-6 sm:p-10">
        <header className="mb-6">
          <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">Admin Â· Users</h1>
          <p className="text-sm text-emerald-900/70">Invite, soft-delete, or permanently remove users.</p>
        </header>

        <form action={invite} className="rounded-2xl border border-emerald-900/10 bg-white/70 p-4 sm:p-6 shadow-sm flex flex-col sm:flex-row gap-3 sm:items-end">
          <div className="flex-1">
            <label className="block text-sm font-medium text-emerald-950">Invite email</label>
            <input name="email" type="email" required className="mt-1 w-full rounded-xl border border-emerald-900/15 bg-white px-3 py-2 shadow-inner outline-none focus:border-emerald-600/40 focus:ring-1 focus:ring-emerald-600/20" placeholder="user@example.com" />
          </div>
          <div>
            <label className="block text-sm font-medium text-emerald-950">Role</label>
            <select name="role" defaultValue="VISITOR" className="mt-1 rounded-xl border border-emerald-900/15 bg-white px-3 py-2 shadow-inner outline-none">
              <option value="VISITOR">Visitor</option>
              <option value="OWNER">Owner</option>
              <option value="EDITOR">Editor</option>
              <option value="ADMIN">Admin</option>
            </select>
          </div>
          <button type="submit" className="rounded-xl bg-emerald-600 text-white px-4 py-2 shadow-sm hover:bg-emerald-700">Send invite</button>
        </form>

        <div className="mt-6 overflow-x-auto rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b border-emerald-900/10">
                <th className="p-3">Email</th>
                <th className="p-3">Name</th>
                <th className="p-3">Role</th>
                <th className="p-3">Verified</th>
                <th className="p-3">Deleted</th>
                <th className="p-3">Actions</th>
              </tr>
            </thead>
            <tbody>
              {users.map((u: any) => (
                <tr key={u.id} className="border-t border-emerald-900/10">
                  <td className="p-3">{u.email}</td>
                  <td className="p-3">{u.name || "â€”"}</td>
                  <td className="p-3">{u.role}</td>
                  <td className="p-3">{u.emailVerified ? "Yes" : "No"}</td>
                  <td className="p-3">{u.deletedAt ? "Yes" : "No"}</td>
                  <td className="p-3">
                    <div className="flex gap-2">
                      <form action={softDelete.bind(null, u.id)}>
                        <button className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">Soft delete</button>
                      </form>
                      <form action={hardDelete.bind(null, u.id)}>
                        <button className="rounded-lg bg-rose-600 text-white px-3 py-1 hover:bg-rose-700">Hard delete</button>
                      </form>
                    </div>
                  </td>
                </tr>
              ))}
              {users.length === 0 && (
                <tr><td className="p-4 text-emerald-900/70" colSpan={6}>No users yet.</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  );
}

```

## File: app/admin/submissions/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 9915 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-10-31 16:33:22

### Code

```typescript
// app/admin/submissions/page.tsx
import { auth } from "@/auth";
import { headers, cookies } from "next/headers";
import type { ReactNode } from "react";

async function apiFetch(path: string, init: RequestInit = {}) {
  const h = await headers();
  const c = await cookies();
  const host = h.get("x-forwarded-host") ?? h.get("host");
  const proto = h.get("x-forwarded-proto") ?? "http";
  if (!host) throw new Error("Missing host header");
  const base = `${proto}://${host}`;
  return fetch(`${base}${path}`, {
    ...init,
    cache: "no-store",
    headers: { ...(init.headers || {}), cookie: c.toString(), "content-type": "application/json" },
  });
}

function FormDataDisplay({ data }: { data: any }) {
  const renderValue = (value: any, key?: string): ReactNode => {
    // Handle null/undefined
    if (value === null || value === undefined) {
      return <span className="text-slate-400 italic">empty</span>;
    }

    // Handle booleans
    if (typeof value === "boolean") {
      return (
        <span className={value ? "text-emerald-600 font-medium" : "text-slate-500"}>
          {value ? "Yes" : "No"}
        </span>
      );
    }

    // Handle numbers (including timestamps)
    if (typeof value === "number") {
      // Check if it looks like a timestamp (10 or 13 digits)
      if (value > 1_000_000_000 && value < 10_000_000_000_000) {
        const date = new Date(value > 10_000_000_000 ? value : value * 1000);
        return (
          <span className="text-slate-700">
            {value}
            <span className="ml-2 text-xs text-slate-500">({date.toLocaleString()})</span>
          </span>
        );
      }

      // Check if it's a coordinate
      if (
        key &&
        (key.toLowerCase().includes("lat") ||
          key.toLowerCase().includes("lng") ||
          key.toLowerCase().includes("lon") ||
          key.toLowerCase().includes("coord"))
      ) {
        return <span className="text-blue-600 font-mono text-sm">{value.toFixed(6)}Â°</span>;
      }

      return <span className="text-slate-700 font-mono">{value}</span>;
    }

    // Handle strings
    if (typeof value === "string") {
      // URL?
      if (value.match(/^https?:\/\//)) {
        return (
          <a
            href={value}
            target="_blank"
            rel="noopener noreferrer"
            className="text-blue-600 hover:text-blue-700 underline break-all"
          >
            {value}
          </a>
        );
      }

      // Long text?
      if (value.length > 100) {
        return <span className="text-slate-700 break-words leading-relaxed">{value}</span>;
      }

      return <span className="text-slate-700">{value}</span>;
    }

    // Arrays
    if (Array.isArray(value)) {
      if (value.length === 0) {
        return <span className="text-slate-400 italic">empty list</span>;
      }
      return (
        <div className="space-y-1">
          {value.map((item, idx) => (
            <div key={idx} className="flex gap-2 pl-4 border-l-2 border-emerald-200">
              <span className="text-slate-500 text-xs mt-0.5">{idx + 1}.</span>
              <div className="flex-1">{renderValue(item)}</div>
            </div>
          ))}
        </div>
      );
    }

    // Objects
    if (typeof value === "object") {
      return (
        <div className="space-y-2 pl-4 border-l-2 border-slate-200">
          {Object.entries(value).map(([k, v]) => (
            <div key={k} className="space-y-1">
              <div className="text-xs font-semibold text-emerald-700 uppercase tracking-wide">
                {k.replace(/([A-Z])/g, " $1").replace(/^./, (str) => str.toUpperCase())}
              </div>
              <div className="pl-2">{renderValue(v, k)}</div>
            </div>
          ))}
        </div>
      );
    }

    return <span className="text-slate-700">{String(value)}</span>;
  };

  if (!data || Object.keys(data).length === 0) {
    return <div className="text-slate-400 italic text-sm">No data available</div>;
  }

  return (
    <div className="space-y-3">
      {Object.entries(data).map(([key, value]) => (
        <div key={key} className="group/item">
          <div className="flex items-baseline gap-2 mb-1">
            <span className="text-sm font-semibold text-emerald-800 uppercase tracking-wide">
              {key.replace(/([A-Z])/g, " $1").replace(/^./, (str) => str.toUpperCase())}
            </span>
          </div>
          <div className="pl-3">{renderValue(value, key)}</div>
        </div>
      ))}
    </div>
  );
}

async function getAll() {
  const res = await apiFetch("/api/submissions?all=1");
  if (!res.ok) return { submissions: [] as any[] };
  return res.json();
}

export default async function AdminSubmissionsPage() {
  const session = await auth();
  const me = session?.user as any;
  if (!me || !["ADMIN", "EDITOR"].includes(me.role)) return null;

  const { submissions } = await getAll();

  async function setStatus(id: string, status: "APPROVED" | "REJECTED" | "PENDING") {
    "use server";
    await apiFetch("/api/submissions", {
      method: "PATCH",
      body: JSON.stringify({ id, status }),
    });
  }

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <section className="mx-auto max-w-7xl p-6 sm:p-10">
        <header className="mb-6">
          <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">Admin Â· Submissions</h1>
          <p className="text-sm text-emerald-900/70">Review and approve user-submitted JSON.</p>
        </header>

        <div className="overflow-x-auto rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b border-emerald-900/10">
                <th className="p-3">ID</th>
                <th className="p-3">User</th>
                <th className="p-3">Form</th>
                <th className="p-3">Request time</th>
                <th className="p-3">Actions</th>
                <th className="p-3">Action time</th>
              </tr>
            </thead>
            <tbody>
              {submissions.map((s: any) => (
                <tr key={s.id} className="border-t border-emerald-900/10 align-top">
                  <td className="p-3 text-xs">{s.id}</td>
                  <td className="p-3">
                    <div className="font-medium">{s.userName || "â€”"}</div>
                    <div className="text-xs text-emerald-900/60">{s.userEmail}</div>
                  </td>
                  <td className="p-3">
                    <details className="group">
                      <summary className="cursor-pointer font-medium text-emerald-950 hover:text-emerald-700 transition-colors">
                        {s.formName}
                        <span className="ml-2 text-emerald-600 text-xs group-open:hidden">â–¼ View details</span>
                        <span className="ml-2 text-emerald-600 text-xs hidden group-open:inline">â–² Hide details</span>
                      </summary>
                      <div className="mt-3 max-w-[640px] rounded-lg bg-gradient-to-br from-slate-50 to-slate-100/50 p-4 border border-slate-200 shadow-sm">
                        <FormDataDisplay data={s.data} />
                      </div>
                    </details>
                  </td>
                  <td className="p-3">{new Date(s.submittedAt).toLocaleString()}</td>
                  <td className="p-3">
                    <div className="flex flex-wrap items-center gap-2">
                      <span
                        className={`rounded-full px-2 py-0.5 text-xs border ${
                          s.status === "APPROVED"
                            ? "bg-emerald-50 text-emerald-800 border-emerald-200"
                            : s.status === "REJECTED"
                            ? "bg-rose-50 text-rose-800 border-rose-200"
                            : "bg-amber-50 text-amber-800 border-amber-200"
                        }`}
                      >
                        {s.status}
                      </span>
                      <form action={setStatus.bind(null, s.id, "APPROVED")}>
                        <button className="rounded-lg bg-emerald-600 text-white px-3 py-1 hover:bg-emerald-700">
                          Approve
                        </button>
                      </form>
                      <form action={setStatus.bind(null, s.id, "REJECTED")}>
                        <button className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">
                          Reject
                        </button>
                      </form>
                      <form action={setStatus.bind(null, s.id, "PENDING")}>
                        <button className="rounded-lg border border-emerald-900/15 px-3 py-1 hover:bg-emerald-50">
                          Pend
                        </button>
                      </form>
                    </div>
                  </td>
                  <td className="p-3">{s.actionTime ? new Date(s.actionTime).toLocaleString() : "â€”"}</td>
                </tr>
              ))}
              {submissions.length === 0 && (
                <tr>
                  <td className="p-4 text-emerald-900/70" colSpan={6}>
                    No submissions yet.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  );
}

```

## File: app/dashboard/sign-out-button.tsx

- Extension: .tsx
- Language: typescript
- Size: 307 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-03 18:01:12

### Code

```typescript
// app/dashboard/sign-out-button.tsx (Client Component)
"use client"

import { signOut } from "next-auth/react"

export default function SignOutButton() {
  return (
    <button
      onClick={() => signOut({ callbackUrl: "/login" })}
      style={{ marginTop: 16 }}
    >
      Sign out
    </button>
  )
}
```

## File: app/dashboard/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 5514 bytes
- Created: 2025-11-10 14:33:34
- Modified: 2025-11-10 10:45:56

### Code

```typescript
// app/dashboard/page.tsx
import { auth } from "@/auth";
import { headers, cookies } from "next/headers";
import Link from "next/link";

// Helper: same-origin fetch with cookies forwarded
async function apiFetch(path: string, init: RequestInit = {}) {
  const h = await headers();
  const c = await cookies();

  const host = h.get("x-forwarded-host") ?? h.get("host");
  const proto = h.get("x-forwarded-proto") ?? "http";
  if (!host) throw new Error("Missing host header");
  const base = `${proto}://${host}`;

  return fetch(`${base}${path}`, {
    ...init,
    cache: "no-store",
    headers: {
      ...(init.headers || {}),
      cookie: c.toString(), // forward session cookies
    },
  });
}

async function getMyListings() {
  const res = await apiFetch("/api/listings");
  if (!res.ok) return { listings: [] as any[] };
  return res.json();
}

export default async function Dashboard() {
  const session = await auth();
  if (!session?.user) return null;

  const { listings } = await getMyListings();
  const user = session.user as any;

  return (
    <main className="min-h-screen bg-white relative">
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <section className="mx-auto max-w-6xl p-6 sm:p-10">
        <header className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl sm:text-3xl font-semibold text-emerald-950">
              Welcome, {user.name || user.email}
            </h1>
            <p className="text-sm text-emerald-900/70">
              Role: <span className="font-medium">{user.role}</span>
            </p>
          </div>
          <div className="flex gap-2">
            {(user.role === "ADMIN" || user.role === "EDITOR") && (
              <>
                <Link
                  href="/admin/users"
                  className="rounded-xl border border-emerald-900/15 bg-white px-4 py-2 text-emerald-950 shadow-sm hover:bg-emerald-50"
                >
                  Admin Â· Users
                </Link>
                <Link
                  href="/admin/listings"
                  className="rounded-xl border border-emerald-900/15 bg-white px-4 py-2 text-emerald-950 shadow-sm hover:bg-emerald-50"
                >
                  Admin Â· Listings
                </Link>
              </>
            )}
          </div>
        </header>

        <div className="mt-8 grid gap-4 sm:grid-cols-3">
          <Card
            title="My listings"
            value={listings.length}
            hint="Create or edit your business pages"
            href="/owner"
          />
          <Card
            title="Account"
            value={user.email}
            hint="Update details or self-delete"
            href="/dashboard/profile"
          />
          <Card
            title="Explore"
            value="Directory"
            hint="See what visitors see"
            href="/explore"
          />
        </div>

        <div className="mt-8 grid gap-4 sm:grid-cols-2">
          <div className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 shadow-sm">
            <h2 className="font-medium text-emerald-950">Owner quick actions</h2>
            <ul className="mt-2 space-y-2 text-sm">
              <li>
                <Link className="text-emerald-800 hover:underline" href="/owner">
                  Create a listing
                </Link>
              </li>
              <li>
                <Link className="text-emerald-800 hover:underline" href="/owner">
                  Submit for review
                </Link>
              </li>
            </ul>
          </div>

          <div className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 shadow-sm">
            <h2 className="font-medium text-emerald-950">Account</h2>
            <p className="text-sm text-emerald-900/70 mt-1">Email: {user.email}</p>
            <form action="/api/self-delete" method="post" className="mt-4">
              <button className="rounded-xl bg-rose-600 text-white px-4 py-2 text-sm shadow-sm hover:bg-rose-700">
                Delete my account
              </button>
            </form>
          </div>
        </div>
        {(user.role === "ADMIN" || user.role === "EDITOR") && (
  <>
    <Link href="/admin/users" className="rounded-xl border border-emerald-900/15 bg-white px-4 py-2 text-emerald-950 shadow-sm hover:bg-emerald-50">
      Admin Â· Users
    </Link>
    <Link href="/admin/listings" className="rounded-xl border border-emerald-900/15 bg-white px-4 py-2 text-emerald-950 shadow-sm hover:bg-emerald-50">
      Admin Â· Listings
    </Link>
  </>
)}

      </section>
    </main>
  );
}

function Card({
  title,
  value,
  hint,
  href,
}: {
  title: string;
  value: React.ReactNode;
  hint: string;
  href: string;
}) {
  return (
    <Link
      href={href}
      className="rounded-2xl border border-emerald-900/10 bg-white/70 p-6 shadow-sm block hover:bg-white"
    >
      <p className="text-sm text-emerald-900/70">{title}</p>
      <p className="mt-1 text-2xl font-semibold text-emerald-950">{value}</p>
      <p className="mt-1 text-xs text-emerald-900/60">{hint}</p>
    </Link>
  );
}

```

## File: app/reset-request/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 3819 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:13:53

### Code

```typescript
// =============================================================
// app/(auth)/reset-request/page.tsx â€” request password reset email
// =============================================================
"use client";
import React, { useState } from "react";
import Link from "next/link";
import { BgDecor, BrandAside, Alert, Spinner } from "../components/auth/ui";

export default function ResetRequestPage() {
  const [email, setEmail] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [err, setErr] = useState<string | null>(null);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (submitting) return;
    setMsg(null);
    setErr(null);

    setSubmitting(true);
    try {
      const res = await fetch("/api/auth/reset-request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || "Unable to send reset email.");
      setMsg("If that email exists, we just sent a reset link. Check your inbox.");
    } catch (e: any) {
      setErr(e?.message || "Something went wrong. Please try again.");
    } finally {
      setSubmitting(false);
    }
  }

  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />

      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <span className="inline-flex items-center gap-2 rounded-full border border-emerald-600/20 bg-emerald-600/5 px-3 py-1 text-xs font-medium text-emerald-800">
              <span className="h-1.5 w-1.5 rounded-full bg-emerald-600" />
              Reset password
            </span>
            <h1 className="mt-4 text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Send reset link</h1>
            <p className="mt-2 text-sm text-emerald-900/70">Weâ€™ll email you a secure link to set a new password.</p>
          </div>

          {msg && <Alert type="success" message={msg} />}
          {err && <Alert type="error" message={err} />}

          <form onSubmit={onSubmit} className="rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm backdrop-blur p-6 sm:p-8 space-y-5">
            <div className="space-y-1.5">
              <label htmlFor="email" className="block text-sm font-medium text-emerald-950">Email</label>
              <input
                id="email"
                type="email"
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                placeholder="you@example.com"
                autoComplete="email"
              />
            </div>

            <button
              type="submit"
              disabled={submitting}
              className="group inline-flex w-full items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 py-3 text-white font-medium shadow-sm transition hover:bg-emerald-700 disabled:opacity-60"
            >
              {submitting ? <Spinner label="Sending" /> : <span>Send reset link</span>}
            </button>

            <p className="text-center text-sm text-emerald-900/70">
              Remembered it? <Link href="/login" className="text-emerald-800 hover:underline">Back to sign in</Link>
            </p>
          </form>
        </div>
      </section>
    </main>
  );
}

```

## File: app/components/landing/search-bar.tsx

- Extension: .tsx
- Language: typescript
- Size: 3832 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-05 17:22:29

### Code

```typescript
// app/components/landing/search-bar.tsx
"use client";
import React, { useState } from "react";
import { useRouter } from "next/navigation";

export default function LandingSearchBar() {
  const [q, setQ] = useState("");
  const [when, setWhen] = useState<"today" | "weekend" | "any">("any");
  const router = useRouter();

  function submit(e: React.FormEvent) {
    e.preventDefault();
    const params = new URLSearchParams();
    if (q) params.set("q", q);
    if (when !== "any") params.set("when", when);
    router.push(`/explore?${params.toString()}`);
  }

  return (
    <form onSubmit={submit} className="w-full max-w-3xl rounded-2xl border border-emerald-900/10 bg-white/80 p-3 shadow-sm backdrop-blur">
      <div className="flex flex-col gap-3 sm:flex-row sm:items-center">
        <div className="relative flex-1">
          <input
            value={q}
            onChange={(e) => setQ(e.target.value)}
            placeholder='Try "pumpkin patch", "vineyard with music"...'
            className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 pr-28 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
          />
          <div className="pointer-events-none absolute inset-y-0 right-3 flex items-center text-emerald-900/40 text-sm">
            Search
          </div>
        </div>

        <div className="grid grid-cols-3 gap-2 sm:w-[280px]">
          <button
            type="button"
            onClick={() => setWhen("today")}
            className={`rounded-xl px-3 py-2 text-sm font-medium border ${
              when === "today"
                ? "bg-emerald-600 text-white border-emerald-600"
                : "bg-white text-emerald-900 border-emerald-900/15 hover:bg-emerald-50"
            }`}
          >
            Today
          </button>
          <button
            type="button"
            onClick={() => setWhen("weekend")}
            className={`rounded-xl px-3 py-2 text-sm font-medium border ${
              when === "weekend"
                ? "bg-emerald-600 text-white border-emerald-600"
                : "bg-white text-emerald-900 border-emerald-900/15 hover:bg-emerald-50"
            }`}
          >
            Weekend
          </button>
          <button
            type="button"
            onClick={() => setWhen("any")}
            className={`rounded-xl px-3 py-2 text-sm font-medium border ${
              when === "any"
                ? "bg-emerald-600 text-white border-emerald-600"
                : "bg-white text-emerald-900 border-emerald-900/15 hover:bg-emerald-50"
            }`}
          >
            Anytime
          </button>
        </div>

        <button
          type="submit"
          className="inline-flex items-center justify-center rounded-xl bg-emerald-600 px-5 py-3 text-white font-medium shadow-sm hover:bg-emerald-700"
        >
          Find places
        </button>
      </div>

      {/* quick chips */}
      <div className="mt-3 flex flex-wrap items-center gap-2 text-sm">
        {["U-pick apples", "Farm-stay", "Hayrides", "Wine tasting"].map((t) => (
          <button
            key={t}
            type="button"
            onClick={() => setQ(t)}
            className="rounded-full border border-emerald-900/15 bg-white px-3 py-1.5 text-emerald-900/80 hover:bg-emerald-50"
          >
            {t}
          </button>
        ))}
        <span className="text-emerald-900/40">Â·</span>
        <button
          type="button"
          onClick={() => setQ((s) => (s ? `${s} near me` : "near me"))}
          className="rounded-full border border-emerald-900/15 bg-white px-3 py-1.5 text-emerald-900/80 hover:bg-emerald-50"
        >
          Use my location
        </button>
      </div>
    </form>
  );
}

```

## File: app/components/auth/ui.tsx

- Extension: .tsx
- Language: typescript
- Size: 3362 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-04 11:29:53

### Code

```typescript
"use client";
import React from "react";
import Link from "next/link";

// Drop this at: components/auth/ui.tsx
// Then import in pages like: import { BgDecor, BrandAside, Alert, Spinner, ValueRow } from "../../components/auth/ui";
// If you use a route group like app/(auth)/register/page.tsx, use: import from "../../../components/auth/ui";

export function BgDecor() {
  return (
    <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
      <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
      <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
      <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
    </div>
  );
}

export function BrandAside() {
  return (
    <aside className="hidden lg:flex flex-col justify-between p-10">
      <header className="flex items-center gap-3">
        <div className="h-10 w-10 rounded-2xl bg-emerald-600 flex items-center justify-center text-white font-semibold shadow-md">AG</div>
        <div>
          <p className="text-lg font-semibold text-emerald-900">Agritourism Directory</p>
          <p className="text-sm text-emerald-800/70">Find farms, orchards, vineyards & stays</p>
        </div>
      </header>
      <section className="space-y-6">
        <ValueRow title="Search what you love" desc="Pumpkin patches, wine tastings, farm-stays, u-pick." />
        <ValueRow title="Filter by season & amenities" desc="Open today, kidâ€‘friendly, petâ€‘friendly, accessible." />
        <ValueRow title="Plan your route" desc="Pin places on the map and build a weekend trail." />
        <ValueRow title="For owners & editors" desc="Claim listings, post events, and keep info fresh." />
      </section>
      <footer className="text-sm text-emerald-900/70 flex gap-4">
        <Link href="/about" className="hover:underline">About</Link>
        <Link href="/privacy" className="hover:underline">Privacy</Link>
        <Link href="/terms" className="hover:underline">Terms</Link>
      </footer>
    </aside>
  );
}

export function ValueRow({ title, desc }: { title: string; desc: string }) {
  return (
    <div className="flex items-start gap-3">
      <span className="mt-1 inline-flex h-2.5 w-2.5 shrink-0 rounded-full bg-emerald-600" />
      <div>
        <p className="font-medium text-emerald-950">{title}</p>
        <p className="text-sm text-emerald-900/70">{desc}</p>
      </div>
    </div>
  );
}

export function Alert({ type, message }: { type: "success" | "error"; message: string }) {
  const base = "rounded-xl px-4 py-3 mb-4 text-sm border";
  const t = type === "success" ? "bg-emerald-50 border-emerald-200 text-emerald-900" : "bg-rose-50 border-rose-200 text-rose-950";
  return <div role="status" className={`${base} ${t}`}>{message}</div>;
}

export function Spinner({ label }: { label?: string }) {
  return (
    <span className="inline-flex items-center gap-2">
      <svg className="h-4 w-4 animate-spin" viewBox="0 0 24 24" aria-hidden>
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z" />
      </svg>
      {label && <span>{label}</span>}
    </span>
  );
}

```

## File: app/components/site/nav.tsx

- Extension: .tsx
- Language: typescript
- Size: 1656 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-05 17:22:05

### Code

```typescript
// app/components/site/nav.tsx
import React from "react";
import Link from "next/link";
import Logo from "./logo";

export default function SiteNav() {
  return (
    <header className="relative z-10">
      <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <nav className="flex h-16 items-center justify-between rounded-2xl border border-emerald-900/10 bg-white/70 backdrop-blur px-4 shadow-sm">
          <Link href="/" aria-label="Home" className="shrink-0">
            <Logo />
          </Link>

          <div className="hidden sm:flex items-center gap-6 text-sm">
            <Link href="/explore" className="text-emerald-900/80 hover:text-emerald-900">Explore</Link>
            <Link href="/owner" className="text-emerald-900/80 hover:text-emerald-900">For Owners</Link>
            <Link href="/about" className="text-emerald-900/80 hover:text-emerald-900">About</Link>
            <Link href="/admin" className="text-emerald-900/80 hover:text-emerald-900">Admin</Link>
          </div>

          <div className="flex items-center gap-2">
            <Link
              href="/login"
              className="hidden sm:inline-flex rounded-xl border border-emerald-900/15 bg-white px-4 py-2 text-sm font-medium text-emerald-900 shadow-sm hover:bg-emerald-50"
            >
              Sign in
            </Link>
            <Link
              href="/register"
              className="inline-flex rounded-xl bg-emerald-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-emerald-700"
            >
              Create account
            </Link>
          </div>
        </nav>
      </div>
    </header>
  );
}

```

## File: app/components/site/footer.tsx

- Extension: .tsx
- Language: typescript
- Size: 1909 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-17 14:15:58

### Code

```typescript
"use client";

import React from "react";
import Link from "next/link";

const Container = ({
  children,
  className = "",
}: {
  children: React.ReactNode;
  className?: string;
}) => (
  <div className={`mx-auto w-full max-w-[1200px] px-4 sm:px-6 lg:px-8 ${className}`}>
    {children}
  </div>
);

export default function SiteFooter() {
  return (
    <footer className="bg-[#6b4f3a] text-[#F9F6F2]">
      <Container className="py-8 space-y-4 text-sm relative">
        {/* keep anchor so /#data still works */}
        <span id="data" className="absolute -top-16 h-0 w-0" aria-hidden />

        <p className="text-center leading-relaxed">
          This website was developed through a Cooperative Agreement with Michigan State University
          and USDA&apos;s Agricultural Marketing Service.
        </p>

        <nav
          aria-label="Footer"
          className="flex flex-wrap items-center justify-center gap-x-6 gap-y-2 text-[13px]"
        >
          <Link href="/definitions" className="hover:underline underline-offset-2">
            Definitions
          </Link>
          <Link href="/privacy" className="hover:underline underline-offset-2">
            Privacy Policy
          </Link>
          <Link href="/terms" className="hover:underline underline-offset-2">
            Terms of Use and Service
          </Link>
          <Link href="/accessibility" className="hover:underline underline-offset-2">
            Accessibility Statement
          </Link>
        </nav>

        <div className="text-center text-xs leading-relaxed text-[#F3EDE7]">
          <p>
            OMB Number for Agritourism Directory: 0581-0332_Expiration Date: 01/31/2025
          </p>
          <p>
            OMB Number for CSA, Farmers Market, Food Hub and On-farm Market:
            0581-0169_Expiration Date: 01/31/2023
          </p>
        </div>
      </Container>
    </footer>
  );
}

```

## File: app/components/site/logo.tsx

- Extension: .tsx
- Language: typescript
- Size: 611 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-05 17:21:54

### Code

```typescript
// app/components/site/logo.tsx
import React from "react";

export default function Logo({ withText = false }: { withText?: boolean }) {
  return (
    <div className="flex items-center gap-3">
      <div className="h-10 w-10 rounded-2xl bg-emerald-600 flex items-center justify-center text-white font-semibold shadow-md">
        AG
      </div>
      {withText && (
        <div>
          <p className="text-lg font-semibold text-emerald-900">Agritourism Directory</p>
          <p className="text-xs text-emerald-800/70">Find farms, orchards, vineyards & stays</p>
        </div>
      )}
    </div>
  );
}

```

## File: app/components/site/header.tsx

- Extension: .tsx
- Language: typescript
- Size: 4062 bytes
- Created: 2025-11-10 10:32:37
- Modified: 2025-11-10 10:32:37

### Code

```typescript
"use client";

import Link from "next/link";
import React from "react";
import { useSession, signOut } from "next-auth/react";

const Container = ({ children, className = "" }: { children: React.ReactNode; className?: string }) => (
  <div className={`mx-auto w-full max-w-[1200px] px-4 sm:px-6 lg:px-8 ${className}`}>{children}</div>
);

export default function SiteHeader() {
  const { data } = useSession();
  const user: any = data?.user;
  const isStaff = user && (user.role === "ADMIN" || user.role === "EDITOR");

  return (
    <header className="sticky top-0 z-40 w-full border-b border-slate-200 bg-white/90 backdrop-blur">
      <Container className="flex h-14 items-center gap-3">
        {/* Brand */}
        <Link href="/" className="group flex items-center gap-2">
          <div className="flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" className="h-5 w-5 text-green-700" fill="currentColor" aria-hidden>
              <path d="M12 2a1 1 0 0 1 1 1v2.05c2.89.49 5.5 2.93 6.4 6.2.22.8-1.03 1.26-1.38.5-.98-2.04-2.86-3.74-5.02-4.13V21a1 1 0 1 1-2 0V7.62C8.38 8 6.5 9.7 5.62 11.75c-.33.76-1.6.31-1.38-.5.92-3.29 3.53-5.72 6.4-6.2V3a1 1 0 0 1 1-1Z" />
            </svg>
            <span className="text-sm font-semibold text-slate-900">Local Food Directories</span>
          </div>
        </Link>

        {/* Primary nav (visible on all sizes) */}
        <nav className="ml-3 flex items-center gap-4 text-xs">
          <Link href="/#directories" className="text-slate-600 hover:text-slate-900">Directories</Link>
          <Link href="/#data" className="text-slate-600 hover:text-slate-900">Data Sharing</Link>
          <Link href="/#contact" className="text-slate-600 hover:text-slate-900">Contact</Link>
          <Link href="/explore" className="text-slate-600 hover:text-slate-900">Explore</Link>
          <Link href="/owner" className="text-slate-600 hover:text-slate-900">Owner</Link>
          {isStaff && (
            <div className="relative group">
              <button className="inline-flex items-center gap-1 text-slate-600 hover:text-slate-900">Admin <span aria-hidden>â–¾</span></button>
              <div className="invisible absolute left-0 mt-2 w-44 rounded-lg border border-slate-200 bg-white p-2 text-xs shadow-lg group-hover:visible">
                <Link href="/admin/users" className="block rounded-md px-2 py-1.5 text-slate-700 hover:bg-slate-50">Users</Link>
                <Link href="/admin/listings" className="block rounded-md px-2 py-1.5 text-slate-700 hover:bg-slate-50">Listings</Link>
                <Link href="/admin/submissions" className="block rounded-md px-2 py-1.5 text-slate-700 hover:bg-slate-50">Submissions</Link>
              </div>
            </div>
          )}
        </nav>

        {/* Right side CTAs (never hidden) */}
        <div className="ml-auto flex items-center gap-2">
          {!user ? (
            <>
              <Link href="/login" className="rounded-lg border border-green-700 bg-white px-3 py-2 text-xs font-semibold text-green-800 shadow-sm transition hover:bg-green-50">
                Sign in
              </Link>
              <Link href="/register" className="rounded-lg border border-green-700 bg-green-700 px-3 py-2 text-xs font-semibold text-white shadow-sm transition hover:-translate-y-0.5 hover:bg-green-800">
                Sign up
              </Link>
            </>
          ) : (
            <>
              <Link href="/dashboard" className="rounded-lg border border-emerald-900/15 bg-white px-3 py-2 text-xs font-medium text-emerald-900 shadow-sm hover:bg-emerald-50">
                Dashboard
              </Link>
              <button
                onClick={() => signOut({ callbackUrl: "/login" })}
                className="rounded-lg bg-rose-600 px-3 py-2 text-xs font-semibold text-white shadow-sm transition hover:bg-rose-700"
              >
                Sign out
              </button>
            </>
          )}
        </div>
      </Container>
    </header>
  );
}

```

## File: app/register/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 9894 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:42:40

### Code

```typescript
// =============================================================
// app/register/page.tsx
// =============================================================
"use client";
import React, { Suspense, useMemo, useState } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { BgDecor, BrandAside, Alert, Spinner } from "../components/auth/ui";

function RegisterForm() {
  const router = useRouter();
  const params = useSearchParams();
  const callbackUrl = useMemo(() => params.get("callbackUrl") ?? "/dashboard", [params]);

  // ---- NEW: invite/as-owner flags + invited info ----
  const invite = params.get("invite") || null;
  const asOwner = params.get("as") === "owner";
  const [invitedEmail, setInvitedEmail] = useState<string | null>(null);
  const [invitedRole, setInvitedRole] = useState<string | null>(null);

  const [name, setName] = useState("");
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [password2, setPassword2] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [agree, setAgree] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [msg, setMsg] = useState<string | null>(null);
  const [err, setErr] = useState<string | null>(null);

  // ---- NEW: inspect invite token on mount ----
  React.useEffect(() => {
    let ignore = false;
    (async () => {
      if (!invite) return;
      const r = await fetch(`/api/invite/inspect?token=${encodeURIComponent(invite)}`, { cache: "no-store" });
      const d = await r.json().catch(() => ({}));
      if (!ignore) {
        if (d?.valid) {
          setInvitedEmail(d.email);
          setEmail(d.email);
          setInvitedRole(d.role);
        } else {
          setErr("Invite link is invalid or expired.");
        }
      }
    })();
    return () => {
      ignore = true;
    };
  }, [invite]);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (submitting) return;
    setMsg(null);
    setErr(null);

    if (!agree) return setErr("Please accept the Terms to continue.");
    if (password !== password2) return setErr("Passwords do not match.");
    if (password.length < 8) return setErr("Password must be at least 8 characters.");

    setSubmitting(true);
    try {
      // ---- NEW: send invite/as flag to API ----
      const body: any = { name, email, password };
      if (invite) body.invite = invite;
      else if (asOwner) body.as = "owner";

      const res = await fetch("/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data?.error || "Could not create your account.");

      setMsg("Account created. Check your email to verify before signing in.");
    } catch (e: any) {
      setErr(e?.message || "Something went wrong. Please try again.");
    } finally {
      setSubmitting(false);
    }
  }

  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />

      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <span className="inline-flex items-center gap-2 rounded-full border border-emerald-600/20 bg-emerald-600/5 px-3 py-1 text-xs font-medium text-emerald-800">
              <span className="h-1.5 w-1.5 rounded-full bg-emerald-600" />
              Create your account
            </span>
            <h1 className="mt-4 text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Join the Agritourism Directory</h1>
            <p className="mt-2 text-sm text-emerald-900/70">Owners & editors manage listings. Visitors can browse without an account.</p>
          </div>

          {msg && <Alert type="success" message={msg} />}
          {err && <Alert type="error" message={err} />}

          <form onSubmit={onSubmit} className="rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm backdrop-blur p-6 sm:p-8 space-y-5">
            <div className="space-y-1.5">
              <label htmlFor="name" className="block text-sm font-medium text-emerald-950">Name (optional)</label>
              <input
                id="name"
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                placeholder="Jane Farmer"
              />
            </div>

            <div className="space-y-1.5">
              <label htmlFor="email" className="block text-sm font-medium text-emerald-950">Email</label>
              <input
                id="email"
                type="email"
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                disabled={!!invitedEmail}
                className={`w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring ${invitedEmail ? "opacity-70 cursor-not-allowed" : ""}`}
                placeholder="you@example.com"
                autoComplete="email"
              />
              {invitedRole && (
                <p className="text-xs text-emerald-900/60 mt-1">
                  Invited as <span className="font-medium">{invitedRole}</span>.
                </p>
              )}
            </div>

            <div className="space-y-1.5">
              <label htmlFor="password" className="block text-sm font-medium text-emerald-950">Password</label>
              <div className="relative">
                <input
                  id="password"
                  type={showPassword ? "text" : "password"}
                  required
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="peer w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring pr-12"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  autoComplete="new-password"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword((s) => !s)}
                  className="absolute inset-y-0 right-2 my-auto h-9 rounded-lg px-3 text-sm text-emerald-950/70 hover:bg-emerald-50"
                >
                  {showPassword ? "Hide" : "Show"}
                </button>
              </div>
              <p className="text-xs text-emerald-900/60">Use at least 8 characters. Consider a mix of letters, numbers, and symbols.</p>
            </div>

            <div className="space-y-1.5">
              <label htmlFor="password2" className="block text-sm font-medium text-emerald-950">Confirm password</label>
              <input
                id="password2"
                type={showPassword ? "text" : "password"}
                required
                value={password2}
                onChange={(e) => setPassword2(e.target.value)}
                className="w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                autoComplete="new-password"
              />
            </div>

            <label className="flex items-start gap-3 text-sm">
              <input
                type="checkbox"
                checked={agree}
                onChange={(e) => setAgree(e.target.checked)}
                className="mt-0.5 h-4 w-4 rounded border-emerald-900/20 text-emerald-600 focus:ring-emerald-600"
              />
              <span className="text-emerald-900/80">
                I agree to the <Link href="/terms" className="text-emerald-800 underline">Terms</Link> and <Link href="/privacy" className="text-emerald-800 underline">Privacy Policy</Link>.
              </span>
            </label>

            <button
              type="submit"
              disabled={submitting}
              className="group inline-flex w-full items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 py-3 text-white font-medium shadow-sm transition hover:bg-emerald-700 disabled:opacity-60"
            >
              {submitting ? <Spinner label="Creating account" /> : <span>Create account</span>}
            </button>

            <p className="text-center text-sm text-emerald-900/70">
              Already have an account? <Link href="/login" className="text-emerald-800 hover:underline">Sign in</Link>
            </p>
          </form>
        </div>
      </section>
    </main>
  );
}

function RegisterFallback() {
  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      <BgDecor />
      <BrandAside />
      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <h1 className="text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Loading...</h1>
          </div>
        </div>
      </section>
    </main>
  );
}

export default function RegisterPage() {
  return (
    <Suspense fallback={<RegisterFallback />}>
      <RegisterForm />
    </Suspense>
  );
}
```

## File: app/api/auth/verify/route.ts

- Extension: .ts
- Language: typescript
- Size: 783 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-05 15:43:49

### Code

```typescript
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { consumeEmailVerificationToken } from "@/lib/tokens";
import { logActivity } from "@/lib/activity";

export async function GET(req: Request) {
  const { searchParams } = new URL(req.url);
  const token = searchParams.get("token");
  if (!token) return NextResponse.json({ error: "Missing token" }, { status: 400 });

  const email = await consumeEmailVerificationToken(token);
  if (!email) return NextResponse.json({ error: "Invalid or expired token" }, { status: 400 });

  const user = await prisma.user.update({ where: { email }, data: { emailVerified: new Date() } });
  await logActivity({ userId: user.id, action: "AUTH_EMAIL_VERIFIED" });

  return NextResponse.json({ ok: true });
}

```

## File: app/api/auth/reset/route.ts

- Extension: .ts
- Language: typescript
- Size: 1442 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-10 09:30:51

### Code

```typescript
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { consumePasswordResetToken } from "@/lib/tokens";
import bcrypt from "bcryptjs";
import { logActivity } from "@/lib/activity";
import { sendPasswordUpdatedEmail } from "@/lib/mail";


export async function POST(req: Request) {
  const { token, password } = await req.json().catch(() => ({}));
  if (!token || !password) return NextResponse.json({ error: "Missing token or password" }, { status: 400 });

  const email = await consumePasswordResetToken(token);
  if (!email) return NextResponse.json({ error: "Invalid or expired token" }, { status: 400 });

  const user = await prisma.user.findUnique({ where: { email } });
  if (!user || user.deletedAt) return NextResponse.json({ error: "Account not available" }, { status: 400 });

  const hash = await bcrypt.hash(password, 10);
  await prisma.user.update({ where: { id: user.id }, data: { passwordHash: hash } });
  await logActivity({ userId: user.id, action: "AUTH_PASSWORD_RESET" });


  // after updating the password hash:
  await prisma.user.update({ where: { id: user.id }, data: { passwordHash: hash } });

  // NEW (optional): let user know their password changed
  try { await sendPasswordUpdatedEmail(user.email); } catch (e) { console.error("notify reset:", e); }

  await logActivity({ userId: user.id, action: "AUTH_PASSWORD_RESET" });


  return NextResponse.json({ ok: true });
}

```

## File: app/api/auth/reset-request/route.ts

- Extension: .ts
- Language: typescript
- Size: 836 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-05 15:44:11

### Code

```typescript
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { issuePasswordResetToken } from "@/lib/tokens";
import { sendPasswordResetEmail } from "@/lib/mail";
import { logActivity } from "@/lib/activity";

export async function POST(req: Request) {
  const { email } = await req.json().catch(() => ({}));
  if (!email) return NextResponse.json({ error: "Missing email" }, { status: 400 });

  const user = await prisma.user.findUnique({ where: { email: String(email).toLowerCase().trim() } });
  if (user && !user.deletedAt) {
    const token = await issuePasswordResetToken(user.email);
    await sendPasswordResetEmail(user.email, token);
    await logActivity({ userId: user.id, action: "AUTH_RESET_REQUEST" });
  }
  // Always respond ok to avoid leakage
  return NextResponse.json({ ok: true });
}

```

## File: app/api/auth/register/route.ts

- Extension: .ts
- Language: typescript
- Size: 1931 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-08 11:24:35

### Code

```typescript
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import bcrypt from "bcryptjs";
import { issueEmailVerificationToken } from "@/lib/tokens";
import { sendVerificationEmail } from "@/lib/mail";
import { logActivity } from "@/lib/activity";
import { Role } from "@prisma/client";

export async function POST(req: Request) {
  const { name, email, password, invite, as } = await req.json().catch(() => ({}));
  if (!email || !password) return NextResponse.json({ error: "Missing fields" }, { status: 400 });

  const normalized = String(email).toLowerCase().trim();
  const existing = await prisma.user.findUnique({ where: { email: normalized } });
  if (existing) return NextResponse.json({ error: "Email already in use" }, { status: 400 });

  // Resolve intended role
  let role: Role = "VISITOR";
  if (invite) {
    const inv = await prisma.inviteToken.findUnique({ where: { token: String(invite) } });
    if (!inv || inv.expires < new Date() || inv.usedAt) {
      return NextResponse.json({ error: "Invite invalid or expired" }, { status: 400 });
    }
    if (inv.email !== normalized) {
      return NextResponse.json({ error: "Invite email mismatch" }, { status: 400 });
    }
    role = inv.role;
  } else if (String(as || "").toUpperCase() === "OWNER") {
    // Allow self-register as OWNER (not EDITOR/ADMIN)
    role = "OWNER";
  }

  const passwordHash = await bcrypt.hash(password, 10);
  const user = await prisma.user.create({
    data: { email: normalized, name: name || null, passwordHash, role },
  });

  if (invite) {
    await prisma.inviteToken.update({
      where: { token: invite },
      data: { usedAt: new Date() },
    });
  }

  const token = await issueEmailVerificationToken(user.email);
  await sendVerificationEmail(user.email, token);
  await logActivity({ userId: user.id, action: "AUTH_REGISTER", details: role });

  return NextResponse.json({ ok: true });
}

```

## File: app/api/auth/[...nextauth]/route.ts

- Extension: .ts
- Language: typescript
- Size: 156 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-17 15:03:20

### Code

```typescript
import NextAuth from "next-auth";
import { authOptions } from "@/auth";

const handler = NextAuth(authOptions);
export { handler as GET, handler as POST };

```

## File: app/api/listings/route.ts

- Extension: .ts
- Language: typescript
- Size: 2077 bytes
- Created: 2025-11-10 14:33:35
- Modified: 2025-11-10 10:40:48

### Code

```typescript
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { slugify } from "@/lib/slugify";
import { logActivity } from "@/lib/activity";
import { hasRole } from "@/lib/rbac";

export async function GET(req: Request) {
Â  const session = await getServerSession(authOptions);
Â  const url = new URL(req.url);
Â  const all = url.searchParams.get("all") === "1";

Â  if (!session?.user) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

Â  if (all && hasRole((session.user as any).role, "EDITOR")) {
Â  Â  const rows = await prisma.listing.findMany({ where: { deletedAt: null }, orderBy: { createdAt: "desc" } });
Â  Â  return NextResponse.json({ listings: rows });
Â  }

Â  const rows = await prisma.listing.findMany({
Â  Â  where: { ownerId: (session.user as any).id, deletedAt: null },
Â  Â  orderBy: { createdAt: "desc" },
Â  });
Â  return NextResponse.json({ listings: rows });
}

export async function POST(req: Request) {
Â  const session = await getServerSession(authOptions);
Â  if (!session?.user?.id) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

Â  const { name, shortIntro } = await req.json().catch(() => ({}));
Â  if (!name) return NextResponse.json({ error: "Name required" }, { status: 400 });

Â  const base = slugify(name);
Â  let slug = base;
Â  let i = 1;
Â  while (await prisma.listing.findUnique({ where: { slug } })) {
Â  Â  i += 1;
Â  Â  slug = `${base}-${i}`;
Â  }

Â  const row = await prisma.listing.create({
Â  Â  data: {
Â  Â  Â  name,
Â  Â  Â  slug,
Â  Â  Â  shortIntro: shortIntro || null,
Â  Â  Â  ownerId: (session.user as any).id,
Â  Â  Â  // ðŸ‘‡ *** THIS IS THE FIX ***
Â  Â  Â  // We change "DRAFT" to "PENDING"
Â  Â  Â  status: "PENDING",
Â  Â  },
Â  });

Â  // We can log this as a submission now, not just a create
Â  await logActivity({ userId: (session.user as any).id, action: "LISTING_CREATE_AND_SUBMIT", details: row.id });
Â  return NextResponse.json({ listing: row });
}
```

## File: app/api/listings/[id]/route.ts

- Extension: .ts
- Language: typescript
- Size: 4047 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:01:48

### Code

```typescript
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { canEditListing } from "@/lib/permissions";
import { logActivity } from "@/lib/activity";

export async function GET(_req: Request, context: unknown) {
  const { params } = context as { params: { id: string } };

  const row = await prisma.listing.findUnique({ where: { id: params.id } });
  if (!row || row.deletedAt) return NextResponse.json({ error: "Not found" }, { status: 404 });
  return NextResponse.json({ listing: row });
}

export async function PATCH(req: Request, context: unknown) {
  const { params } = context as { params: { id: string } };

  const session = await getServerSession(authOptions);
  if (!session?.user?.id) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const row = await prisma.listing.findUnique({ where: { id: params.id } });
  if (!row || row.deletedAt) return NextResponse.json({ error: "Not found" }, { status: 404 });

  if (!canEditListing(session.user as any, row)) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const body = await req.json().catch(() => ({} as any));

  // action=submit sets status -> PENDING
  if (body?.action === "submit") {
    const updated = await prisma.listing.update({
      where: { id: row.id },
      data: { status: "PENDING" },
    });
    await logActivity({
      userId: (session.user as any).id,
      action: "LISTING_SUBMIT_REVIEW",
      details: row.id,
    });
    return NextResponse.json({ listing: updated });
  }

  // Admin/editor moderation
  if (
    body?.action === "moderate" &&
    ((session.user as any).role === "ADMIN" || (session.user as any).role === "EDITOR")
  ) {
    const nextStatus = String(body.status || "").toUpperCase();
    if (!["PUBLISHED", "REJECTED", "PENDING"].includes(nextStatus)) {
      return NextResponse.json({ error: "Invalid status" }, { status: 400 });
    }
    const updated = await prisma.listing.update({
      where: { id: row.id },
      data: { status: nextStatus as any },
    });
    await logActivity({
      userId: (session.user as any).id,
      action: "LISTING_MODERATE",
      details: `${row.id}:${nextStatus}`,
    });
    return NextResponse.json({ listing: updated });
  }

  // Update basics
  const updated = await prisma.listing.update({
    where: { id: row.id },
    data: {
      name: body.name ?? row.name,
      shortIntro: body.shortIntro ?? row.shortIntro,
      address1: body.address1 ?? row.address1,
      city: body.city ?? row.city,
      region: body.region ?? row.region,
      postalCode: body.postalCode ?? row.postalCode,
      country: body.country ?? row.country,
      phone: body.phone ?? row.phone,
      website: body.website ?? row.website,
      amenities: body.amenities ?? row.amenities,
      activities: body.activities ?? row.activities,
      hours: body.hours ?? row.hours,
    },
  });
  await logActivity({
    userId: (session.user as any).id,
    action: "LISTING_UPDATE",
    details: row.id,
  });
  return NextResponse.json({ listing: updated });
}

export async function DELETE(_req: Request, context: unknown) {
  const { params } = context as { params: { id: string } };

  const session = await getServerSession(authOptions);
  if (!session?.user?.id) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const row = await prisma.listing.findUnique({ where: { id: params.id } });
  if (!row || row.deletedAt) return NextResponse.json({ error: "Not found" }, { status: 404 });
  if (!canEditListing(session.user as any, row)) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const updated = await prisma.listing.update({
    where: { id: row.id },
    data: { deletedAt: new Date() },
  });
  await logActivity({
    userId: (session.user as any).id,
    action: "LISTING_DELETE",
    details: row.id,
  });
  return NextResponse.json({ ok: true, listing: updated });
}

```

## File: app/api/admin/users/route.ts

- Extension: .ts
- Language: typescript
- Size: 1634 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-05 15:45:18

### Code

```typescript
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { hasRole } from "@/lib/rbac";
import { issueInviteToken } from "@/lib/tokens";
import { sendInviteEmail } from "@/lib/mail";
import { logActivity } from "@/lib/activity";

export async function GET() {
  const session = await getServerSession(authOptions);
  if (!session?.user) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  if (!hasRole((session.user as any).role, "ADMIN")) return NextResponse.json({ error: "Forbidden" }, { status: 403 });

  const users = await prisma.user.findMany({
    orderBy: { createdAt: "desc" },
    select: { id: true, email: true, name: true, role: true, emailVerified: true, deletedAt: true, createdAt: true },
  });
  return NextResponse.json({ users });
}

export async function POST(req: Request) {
  const session = await getServerSession(authOptions);
  if (!session?.user) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  if (!hasRole((session.user as any).role, "ADMIN")) return NextResponse.json({ error: "Forbidden" }, { status: 403 });

  const { email, role } = await req.json().catch(() => ({}));
  if (!email) return NextResponse.json({ error: "Missing email" }, { status: 400 });

  const token = await issueInviteToken(String(email).toLowerCase().trim(), role || "VISITOR");
  await sendInviteEmail(email, token);
  await logActivity({ userId: (session.user as any).id, action: "ADMIN_INVITE_USER", details: email });

  return NextResponse.json({ ok: true });
}

```

## File: app/api/admin/users/[id]/soft-delete/route.ts

- Extension: .ts
- Language: typescript
- Size: 927 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:01:12

### Code

```typescript
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { hasRole } from "@/lib/rbac";
import { logActivity } from "@/lib/activity";

export async function POST(_req: Request, context: unknown) {
  const { params } = context as { params: { id: string } };

  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  if (!hasRole((session.user as any).role, "ADMIN")) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  await prisma.user.update({ where: { id: params.id }, data: { deletedAt: new Date() } });
  await logActivity({
    userId: (session.user as any).id,
    action: "ADMIN_SOFT_DELETE_USER",
    details: params.id,
  });

  return NextResponse.json({ ok: true });
}

```

## File: app/api/admin/users/[id]/hard-delete/route.ts

- Extension: .ts
- Language: typescript
- Size: 894 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:01:36

### Code

```typescript
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { hasRole } from "@/lib/rbac";
import { logActivity } from "@/lib/activity";

export async function POST(_req: Request, context: unknown) {
  const { params } = context as { params: { id: string } };

  const session = await getServerSession(authOptions);
  if (!session?.user) {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }
  if (!hasRole((session.user as any).role, "ADMIN")) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  await prisma.user.delete({ where: { id: params.id } });
  await logActivity({
    userId: (session.user as any).id,
    action: "ADMIN_HARD_DELETE_USER",
    details: params.id,
  });

  return NextResponse.json({ ok: true });
}

```

## File: app/api/requests/route.ts

- Extension: .ts
- Language: typescript
- Size: 3729 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-10-24 14:00:17

### Code

```typescript
// app/api/requests/route.ts
import { NextResponse } from "next/server";
import path from "path";
import fs from "fs/promises";
import { auth } from "@/auth";

export const revalidate = 0;
export const dynamic = "force-dynamic";

const DATA_DIR = path.join(process.cwd(), "data", "requests");
const INDEX_FILE = path.join(DATA_DIR, "index.json");

type RequestItem = {
  id: string;
  userId?: string | null;
  userEmail?: string | null;
  userName?: string | null;
  subject: string;
  payload?: any;
  requestTime: string; // ISO
  action?: "APPROVED" | "REJECTED" | "PENDING" | null;
  actionTime?: string | null; // ISO
};

async function ensureDir() {
  await fs.mkdir(DATA_DIR, { recursive: true });
  try { await fs.access(INDEX_FILE); } catch { await fs.writeFile(INDEX_FILE, "[]", "utf8"); }
}

async function readAll(): Promise<RequestItem[]> {
  await ensureDir();
  try {
    const buf = await fs.readFile(INDEX_FILE, "utf8");
    const list = JSON.parse(buf) as RequestItem[];
    // newest first
    return list.sort((a, b) => (a.requestTime < b.requestTime ? 1 : -1));
  } catch {
    return [];
  }
}

async function writeAll(items: RequestItem[]) {
  await fs.writeFile(INDEX_FILE, JSON.stringify(items, null, 2), "utf8");
}

// GET /api/requests[?all=1]
// - admins/editors: all items
// - others: only own items
export async function GET(req: Request) {
  const session = await auth().catch(() => null);
  const me = session?.user as any | undefined;
  const role = me?.role as string | undefined;

  const { searchParams } = new URL(req.url);
  const wantAll = searchParams.get("all") === "1";

  const all = await readAll();
  const visible = wantAll && (role === "ADMIN" || role === "EDITOR")
    ? all
    : all.filter((r) => r.userId && me?.id && r.userId === me.id);

  return NextResponse.json({ requests: visible });
}

// POST /api/requests
// body: { subject: string, payload?: any }
export async function POST(req: Request) {
  const session = await auth().catch(() => null);
  const me = session?.user as any | undefined;

  const { subject, payload } = await req.json().catch(() => ({}));
  if (!subject || typeof subject !== "string") {
    return NextResponse.json({ error: "Subject is required" }, { status: 400 });
  }

  const now = new Date().toISOString();
  const id = `${Date.now()}`;

  const item: RequestItem = {
    id,
    userId: me?.id ?? null,
    userEmail: me?.email ?? null,
    userName: me?.name ?? me?.email ?? "Anonymous",
    subject: subject.trim(),
    payload: payload ?? null,
    requestTime: now,
    action: "PENDING",
    actionTime: null,
  };

  const all = await readAll();
  all.push(item);
  await writeAll(all);

  return NextResponse.json({ ok: true, request: item });
}

// PATCH /api/requests
// body: { id: string, action: "APPROVED" | "REJECTED" | "PENDING" }
export async function PATCH(req: Request) {
  const session = await auth().catch(() => null);
  const me = session?.user as any | undefined;
  const role = me?.role as string | undefined;
  if (!(role === "ADMIN" || role === "EDITOR")) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const { id, action } = await req.json().catch(() => ({}));
  if (!id || !["APPROVED", "REJECTED", "PENDING"].includes(action)) {
    return NextResponse.json({ error: "Invalid payload" }, { status: 400 });
  }

  const all = await readAll();
  const idx = all.findIndex((r) => r.id === String(id));
  if (idx < 0) return NextResponse.json({ error: "Not found" }, { status: 404 });

  all[idx].action = action;
  all[idx].actionTime = action === "PENDING" ? null : new Date().toISOString();

  await writeAll(all);
  return NextResponse.json({ ok: true, request: all[idx] });
}

```

## File: app/api/submissions/route.ts

- Extension: .ts
- Language: typescript
- Size: 4125 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-10-24 14:51:17

### Code

```typescript
// app/api/submissions/route.ts
import { NextResponse } from "next/server";
import path from "path";
import fs from "fs/promises";
import { auth } from "@/auth";

export const revalidate = 0;
export const dynamic = "force-dynamic";

const DATA_DIR = path.join(process.cwd(), "data", "submissions");
const INDEX = path.join(DATA_DIR, "index.json");

type Submission = {
  id: string;
  userId: string;
  userEmail: string;
  userName: string | null;
  formId: string;
  formName: string;
  data: any;
  submittedAt: string;  // ISO
  status: "PENDING" | "APPROVED" | "REJECTED";
  actionTime?: string | null; // ISO or null
  file: string; // saved json file path relative to /data/submissions
};

async function ensure() {
  await fs.mkdir(DATA_DIR, { recursive: true });
  try { await fs.access(INDEX); } catch { await fs.writeFile(INDEX, "[]", "utf8"); }
}
async function readAll(): Promise<Submission[]> {
  await ensure();
  try { return JSON.parse(await fs.readFile(INDEX, "utf8")); } catch { return []; }
}
async function writeAll(items: Submission[]) {
  await fs.writeFile(INDEX, JSON.stringify(items, null, 2), "utf8");
}

// GET /api/submissions[?all=1]  â†’ staff sees all, others see their own
export async function GET(req: Request) {
  const session = await auth().catch(() => null);
  const me = session?.user as any | undefined;

  if (!me) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const { searchParams } = new URL(req.url);
  const wantAll = searchParams.get("all") === "1";
  const isStaff = me.role === "ADMIN" || me.role === "EDITOR";

  const items = await readAll();
  const visible = wantAll && isStaff ? items : items.filter(s => s.userId === me.id);

  // newest first
  visible.sort((a, b) => (a.submittedAt < b.submittedAt ? 1 : -1));
  return NextResponse.json({ submissions: visible });
}

// POST /api/submissions  { formId, formName, data }
export async function POST(req: Request) {
  const session = await auth().catch(() => null);
  const me = session?.user as any | undefined;

  if (!me) return NextResponse.json({ error: "Please sign in" }, { status: 401 });

  const body = await req.json().catch(() => ({}));
  const formId = String(body.formId || "").trim();
  const formName = String(body.formName || "").trim();
  const data = body.data;

  if (!formName) return NextResponse.json({ error: "Missing formName" }, { status: 400 });

  const now = new Date().toISOString();
  const id = `${Date.now()}`;
  const file = `submission-${id}.json`;

  const submission: Submission = {
    id,
    userId: me.id,
    userEmail: me.email,
    userName: me.name || null,
    formId: formId || "custom",
    formName,
    data,
    submittedAt: now,
    status: "PENDING",
    actionTime: null,
    file,
  };

  // save the JSON file
  await ensure();
  await fs.writeFile(path.join(DATA_DIR, file), JSON.stringify(submission, null, 2), "utf8");

  // update index
  const all = await readAll();
  all.push(submission);
  await writeAll(all);

  return NextResponse.json({ ok: true, submission });
}

// PATCH /api/submissions  { id, status }
export async function PATCH(req: Request) {
  const session = await auth().catch(() => null);
  const me = session?.user as any | undefined;
  if (!(me && (me.role === "ADMIN" || me.role === "EDITOR"))) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const { id, status } = await req.json().catch(() => ({}));
  if (!id || !["PENDING", "APPROVED", "REJECTED"].includes(status)) {
    return NextResponse.json({ error: "Invalid payload" }, { status: 400 });
  }

  const all = await readAll();
  const i = all.findIndex(s => s.id === String(id));
  if (i < 0) return NextResponse.json({ error: "Not found" }, { status: 404 });

  all[i].status = status;
  all[i].actionTime = status === "PENDING" ? null : new Date().toISOString();

  await writeAll(all);

  // also update on-disk file for convenience
  try {
    await fs.writeFile(path.join(DATA_DIR, all[i].file), JSON.stringify(all[i], null, 2), "utf8");
  } catch {}

  return NextResponse.json({ ok: true, submission: all[i] });
}

```

## File: app/api/self-delete/route.ts

- Extension: .ts
- Language: typescript
- Size: 637 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-05 15:44:56

### Code

```typescript
import { NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/auth";
import { prisma } from "@/lib/prisma";
import { logActivity } from "@/lib/activity";

export async function POST() {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  await prisma.user.update({ where: { id: (session.user as any).id }, data: { deletedAt: new Date() } });
  await logActivity({ userId: (session.user as any).id, action: "ACCOUNT_SELF_DELETE" });
  return NextResponse.json({ ok: true });
}

```

## File: app/login/page.tsx

- Extension: .tsx
- Language: typescript
- Size: 14634 bytes
- Created: 2025-11-10 09:24:19
- Modified: 2025-09-19 15:45:45

### Code

```typescript
"use client";
import React, { Suspense, useMemo, useState } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { signIn } from "next-auth/react";

/**
 * Drop this file at: app/(auth)/login/page.tsx  (or app/login/page.tsx)
 * TailwindCSS recommended. If you don't use it yet, the page will still render basic styles,
 * but the look shines with Tailwind.
 */

function LoginForm() {
  const router = useRouter();
  const params = useSearchParams();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const verified = params.get("verified") === "true";
  const urlError = params.get("error"); // e.g., NextAuth error query
  const callbackUrl = useMemo(() => params.get("callbackUrl") ?? "/dashboard", [params]);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (submitting) return;
    setErr(null);
    setSubmitting(true);
    const res = await signIn("credentials", {
      email,
      password,
      redirect: false,
      callbackUrl,
    });
    if (!res) {
      setErr("Something went wrong. Please try again.");
      setSubmitting(false);
      return;
    }
    if (res.error) {
      setErr(
        res.error === "EMAIL_NOT_VERIFIED"
          ? "Please verify your email first."
          : res.error === "CredentialsSignin"
          ? "Invalid email or password."
          : res.error
      );
      setSubmitting(false);
      return;
    }
    // success
    router.push(res.url ?? callbackUrl);
  }

  function onProvider(provider: string) {
    setErr(null);
    setSubmitting(true);
    signIn(provider, { callbackUrl });
  }

  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      {/* Decorative background */}
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      {/* Left panel: brand + value props */}
      <aside className="hidden lg:flex flex-col justify-between p-10">
        <header className="flex items-center gap-3">
          <div className="h-10 w-10 rounded-2xl bg-emerald-600 flex items-center justify-center text-white font-semibold shadow-md">
            AG
          </div>
          <div className="">
            <p className="text-lg font-semibold text-emerald-900">Agritourism Directory</p>
            <p className="text-sm text-emerald-800/70">Find farms, orchards, vineyards & stays</p>
          </div>
        </header>

        <section className="space-y-6">
          <ValueRow title="Search what you love" desc="Pumpkin patches, wine tastings, farm-stays, u-pick." />
          <ValueRow title="Filter by season & amenities" desc="Open today, kidâ€‘friendly, petâ€‘friendly, accessible." />
          <ValueRow title="Plan your route" desc="Pin places on the map and build a weekend trail." />
          <ValueRow title="For owners & editors" desc="Claim listings, post events, and keep info fresh." />
        </section>

        <footer className="text-sm text-emerald-900/70 flex gap-4">
          <Link href="/about" className="hover:underline">About</Link>
          <Link href="/privacy" className="hover:underline">Privacy</Link>
          <Link href="/terms" className="hover:underline">Terms</Link>
        </footer>
      </aside>

      {/* Right panel: auth card */}
      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <span className="inline-flex items-center gap-2 rounded-full border border-emerald-600/20 bg-emerald-600/5 px-3 py-1 text-xs font-medium text-emerald-800">
              <span className="h-1.5 w-1.5 rounded-full bg-emerald-600" />
              Welcome back
            </span>
            <h1 className="mt-4 text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Sign in to your account</h1>
            <p className="mt-2 text-sm text-emerald-900/70">
              Visitors can browse without an account. Owners & editors sign in to manage listings.
            </p>
          </div>

          {/* Alerts */}
          {verified && (
            <Alert type="success" message="Email verified. You can sign in now." />
          )}
          {urlError && !err && (
            <Alert type="error" message={formatUrlError(urlError)} />
          )}
          {err && <Alert type="error" message={err} />}

          <form onSubmit={onSubmit} className="rounded-2xl border border-emerald-900/10 bg-white/70 shadow-sm backdrop-blur p-6 sm:p-8 space-y-5">
            <div className="space-y-1.5">
              <label htmlFor="email" className="block text-sm font-medium text-emerald-950">Email</label>
              <div className="relative">
                <input
                  id="email"
                  type="email"
                  autoComplete="email"
                  required
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="peer w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring"
                  placeholder="you@example.com"
                />
              </div>
            </div>

            <div className="space-y-1.5">
              <label htmlFor="password" className="block text-sm font-medium text-emerald-950">Password</label>
              <div className="relative">
                <input
                  id="password"
                  type={showPassword ? "text" : "password"}
                  autoComplete="current-password"
                  required
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="peer w-full rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 shadow-inner outline-none ring-emerald-600/20 placeholder:text-emerald-900/40 focus:border-emerald-600/40 focus:ring pr-12"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword((s) => !s)}
                  className="absolute inset-y-0 right-2 my-auto h-9 rounded-lg px-3 text-sm text-emerald-950/70 hover:bg-emerald-50"
                  aria-label={showPassword ? "Hide password" : "Show password"}
                >
                  {showPassword ? "Hide" : "Show"}
                </button>
              </div>
            </div>

            <div className="flex items-center justify-between text-sm">
              <label className="flex items-center gap-2 select-none">
                <input type="checkbox" className="h-4 w-4 rounded border-emerald-900/20 text-emerald-600 focus:ring-emerald-600" />
                <span className="text-emerald-900/80">Remember me</span>
              </label>
              <Link href="/reset-request" className="text-emerald-800 hover:underline">Forgot password?</Link>
            </div>

            <button
              type="submit"
              disabled={submitting}
              className="group inline-flex w-full items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 py-3 text-white font-medium shadow-sm transition hover:bg-emerald-700 disabled:opacity-60"
            >
              {submitting ? (
                <Spinner label="Signing in" />
              ) : (
                <>
                  <span>Sign in</span>
                </>
              )}
            </button>

            <div className="relative">
              <div className="absolute inset-0 flex items-center" aria-hidden>
                <div className="w-full border-t border-emerald-900/10" />
              </div>
              <div className="relative flex justify-center">
                <span className="bg-white px-3 text-xs text-emerald-900/60">or</span>
              </div>
            </div>

            <div className="grid grid-cols-1 gap-3">
              <button
                type="button"
                onClick={() => onProvider("google")}
                className="inline-flex w-full items-center justify-center gap-2 rounded-xl border border-emerald-900/15 bg-white px-4 py-3 text-emerald-950 font-medium shadow-sm hover:bg-emerald-50"
              >
                <svg aria-hidden viewBox="0 0 24 24" className="h-5 w-5">
                  <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.2 3.31v2.75h3.56c2.08-1.92 3.28-4.75 3.28-8.07z"/>
                  <path fill="#34A853" d="M12 23c3 0 5.5-1 7.33-2.73l-3.56-2.75c-.98.66-2.23 1.06-3.77 1.06-2.9 0-5.35-1.96-6.23-4.6H1.99v2.86C3.81 20.53 7.58 23 12 23z"/>
                  <path fill="#FBBC05" d="M5.77 13.98c-.22-.66-.35-1.36-.35-2.08s.13-1.42.35-2.08V6.96H1.99A10.01 10.01 0 0 0 2 11.9c0 1.62.39 3.14 1.09 4.47l2.68-2.39z"/>
                  <path fill="#EA4335" d="M12 4.58c1.62 0 3.07.56 4.21 1.65l3.16-3.16C17.5 1.5 15 0.5 12 0.5 7.58 0.5 3.81 3 1.99 6.96l3.78 2.86C6.65 6.54 9.1 4.58 12 4.58z"/>
                </svg>
                Continue with Google
              </button>
            </div>

            <p className="text-center text-sm text-emerald-900/70">
              Don't have an account? <Link href="/register" className="text-emerald-800 hover:underline">Create one</Link>
            </p>
          </form>

          {/* Quick navigation for this app's personas */}
          <div className="mt-8 grid gap-3">
            <PersonaLink href="/explore" title="Browse as visitor" desc="Search farms, filter by season, and save favorites." />
            <PersonaLink href="/owner" title="Claim or manage a listing" desc="Update hours, add events, upload photos." />
            <PersonaLink href="/admin" title="Editor dashboard" desc="Review updates, manage tags & announcements." />
          </div>
        </div>
      </section>
    </main>
  );
}

function LoginFallback() {
  return (
    <main className="min-h-screen grid lg:grid-cols-2 bg-white relative">
      {/* Decorative background */}
      <div aria-hidden className="pointer-events-none absolute inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-b from-emerald-50 via-white to-amber-50" />
        <div className="absolute -left-24 -top-24 h-96 w-96 rounded-full bg-emerald-200/30 blur-3xl" />
        <div className="absolute -right-24 -bottom-24 h-96 w-96 rounded-full bg-amber-200/30 blur-3xl" />
      </div>

      <aside className="hidden lg:flex flex-col justify-between p-10">
        <header className="flex items-center gap-3">
          <div className="h-10 w-10 rounded-2xl bg-emerald-600 flex items-center justify-center text-white font-semibold shadow-md">
            AG
          </div>
          <div className="">
            <p className="text-lg font-semibold text-emerald-900">Agritourism Directory</p>
            <p className="text-sm text-emerald-800/70">Find farms, orchards, vineyards & stays</p>
          </div>
        </header>
      </aside>

      <section className="flex items-center justify-center p-6 sm:p-10">
        <div className="w-full max-w-md">
          <div className="mb-8 text-center">
            <h1 className="text-2xl sm:text-3xl font-semibold tracking-tight text-emerald-950">Loading...</h1>
          </div>
        </div>
      </section>
    </main>
  );
}

function ValueRow({ title, desc }: { title: string; desc: string }) {
  return (
    <div className="flex items-start gap-3">
      <span className="mt-1 inline-flex h-2.5 w-2.5 shrink-0 rounded-full bg-emerald-600" />
      <div>
        <p className="font-medium text-emerald-950">{title}</p>
        <p className="text-sm text-emerald-900/70">{desc}</p>
      </div>
    </div>
  );
}

function PersonaLink({ href, title, desc }: { href: string; title: string; desc: string }) {
  return (
    <Link
      href={href}
      className="group rounded-2xl border border-emerald-900/10 bg-white/60 p-4 shadow-sm backdrop-blur transition hover:border-emerald-600/30 hover:bg-white"
    >
      <div className="flex items-center justify-between">
        <div>
          <p className="font-medium text-emerald-950">{title}</p>
          <p className="text-sm text-emerald-900/70">{desc}</p>
        </div>
        <span className="ml-4 inline-flex h-9 w-9 items-center justify-center rounded-xl border border-emerald-900/10 bg-white text-emerald-900/70 group-hover:border-emerald-600/30 group-hover:text-emerald-900">
          â†’
        </span>
      </div>
    </Link>
  );
}

function Alert({ type, message }: { type: "success" | "error"; message: string }) {
  const base = "rounded-xl px-4 py-3 mb-4 text-sm border";
  const t =
    type === "success"
      ? "bg-emerald-50 border-emerald-200 text-emerald-900"
      : "bg-rose-50 border-rose-200 text-rose-950";
  return <div role="status" className={`${base} ${t}`}>{message}</div>;
}

function Spinner({ label }: { label?: string }) {
  return (
    <span className="inline-flex items-center gap-2">
      <svg className="h-4 w-4 animate-spin" viewBox="0 0 24 24" aria-hidden>
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z" />
      </svg>
      {label && <span>{label}</span>}
    </span>
  );
}

function formatUrlError(e: string) {
  switch (e) {
    case "AccessDenied":
      return "Access denied. Please use an authorized account.";
    case "Verification":
      return "Verification link invalid or expired. Request a new one.";
    case "OAuthSignin":
    case "OAuthCallback":
      return "Could not sign in with provider. Try again.";
    case "CredentialsSignin":
      return "Invalid email or password.";
    default:
      return e.replaceAll("_", " ");
  }
}

export default function LoginPage() {
  return (
    <Suspense fallback={<LoginFallback />}>
      <LoginForm />
    </Suspense>
  );
}
```

